<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface Admin - Claudyne</title>
    <!-- Cache buster v1.3.0 FRESH FILE - NOUVEAU FICHIER ANTI-CACHE timestamp: 2025-09-20-23:30 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="styles/glassmorphism.css">
    <link rel="stylesheet" href="styles/mobile-optimization.css">
    
    <!-- PWA et optimisations réseau -->
    <meta name="theme-color" content="#1a1a2e">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="preload" href="js/network-optimization.js" as="script" data-critical="true">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #F8FAFC !important;
            background-image: none !important;
            background-size: auto !important;
            animation: none !important;
            color: #1F2937 !important;
            min-height: 100vh;
        }
        
        /* Force override of glassmorphism background */
        body::before,
        body::after {
            display: none !important;
        }

        /* Override glassmorphism dark backgrounds for admin */
        .admin-interface body,
        .admin-interface .main-content,
        .admin-interface .content-area {
            background: #F8FAFC !important;
            color: #1F2937 !important;
        }

        /* Ensure text is always visible on light background */
        .admin-interface * {
            color: #1F2937 !important;
        }

        .admin-interface h1, 
        .admin-interface h2, 
        .admin-interface h3, 
        .admin-interface h4, 
        .admin-interface h5, 
        .admin-interface h6 {
            color: #1F2937 !important;
        }

        .admin-interface .sidebar {
            background: linear-gradient(135deg, #1F2937, #374151) !important;
            color: white !important;
        }

        .admin-interface .sidebar * {
            color: white !important;
        }

        .admin-interface .card,
        .admin-interface .stat-card {
            background: white !important;
            color: #1F2937 !important;
            border: 1px solid #E5E7EB !important;
        }

        .admin-interface .card *,
        .admin-interface .stat-card * {
            color: #1F2937 !important;
        }

        /* Override all glassmorphism effects for admin */
        .admin-interface .glass,
        .admin-interface .glass-card,
        .admin-interface .glass-btn {
            background: white !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            color: #1F2937 !important;
        }

        /* Special glassmorphism styles for email templates section */
        #email-templates-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        #email-templates-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3), transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3), transparent 50%);
            animation: float 15s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Glass effect components */
        #email-templates-section .glass-card {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 20px !important;
            padding: 2rem !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease !important;
            position: relative !important;
            overflow: hidden !important;
        }

        #email-templates-section .glass-card:hover {
            transform: translateY(-5px) !important;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.2) !important;
        }

        #email-templates-section .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }

        #email-templates-section .glass-accent {
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 0 20px 0 80px;
        }

        #email-templates-section .glass-btn {
            background: rgba(255, 255, 255, 0.15) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 15px !important;
            color: white !important;
            padding: 12px 24px !important;
            font-weight: 500 !important;
            transition: all 0.3s ease !important;
            text-decoration: none !important;
        }

        #email-templates-section .glass-btn:hover {
            background: rgba(255, 255, 255, 0.25) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
        }

        #email-templates-section .glass-btn.btn-primary {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(99, 102, 241, 0.8)) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
        }

        #email-templates-section .glass-btn.btn-secondary {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        #email-templates-section .glass-panel {
            background: rgba(255, 255, 255, 0.08) !important;
            backdrop-filter: blur(15px) !important;
            -webkit-backdrop-filter: blur(15px) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            border-radius: 16px !important;
            padding: 1.5rem !important;
            margin-bottom: 2rem !important;
        }

        #email-templates-section .glass-input,
        #email-templates-section .glass-select,
        #email-templates-section .glass-textarea {
            background: rgba(255, 255, 255, 0.98) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            border: 2px solid rgba(255, 255, 255, 0.4) !important;
            border-radius: 8px !important;
            padding: 12px 16px !important;
            color: #1f2937 !important;
            transition: all 0.3s ease !important;
            font-weight: 500 !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        #email-templates-section .glass-input:focus,
        #email-templates-section .glass-select:focus,
        #email-templates-section .glass-textarea:focus {
            outline: none !important;
            border-color: #2563eb !important;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1) !important;
            background: #ffffff !important;
        }

        /* Fix pour les select dropdown options */
        #email-templates-section .glass-select option {
            background: white !important;
            color: #1f2937 !important;
            padding: 8px !important;
        }

        /* Amélioration de la lisibilité pour les placeholders */
        #email-templates-section .glass-input::placeholder,
        #email-templates-section .glass-textarea::placeholder {
            color: rgba(31, 41, 55, 0.6) !important;
        }


        #email-templates-section .glass-input:focus,
        #email-templates-section .glass-select:focus,
        #email-templates-section .glass-textarea:focus {
            outline: none !important;
            border-color: rgba(255, 255, 255, 0.4) !important;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1) !important;
        }

        #email-templates-section .glass-icon {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1)) !important;
            border-radius: 16px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 64px !important;
            height: 64px !important;
            margin-bottom: 1rem !important;
        }

        #email-templates-section .glass-icon i {
            font-size: 24px !important;
            color: white !important;
        }

        /* Glass Modal - CONTRASTE MAXIMAL FIXÉ */
        .modal,
        .glass-modal,
        #templateModal,
        #email-templates-section .glass-modal {
            background: rgba(0, 0, 0, 0.95) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            z-index: 9999 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .modal-content,
        .glass-modal-content,
        #templateModal .modal-content,
        #email-templates-section .glass-modal-content {
            background: #ffffff !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            border: 3px solid #1f2937 !important;
            border-radius: 12px !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.8) !important;
            color: #1f2937 !important;
            padding: 24px !important;
            margin: 0 !important;
            max-width: 90vw !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
            position: relative !important;
        }

        /* Force TOUS les éléments de TOUTES les modals avec contraste maximal */
        .modal-content *,
        .glass-modal-content *,
        #templateModal *,
        #email-templates-section .modal-content *,
        #email-templates-section .glass-modal-content *,
        .modal-content h1, .modal-content h2, .modal-content h3, .modal-content h4,
        .modal-content label, .modal-content span, .modal-content p, .modal-content div,
        #templateModal h1, #templateModal h2, #templateModal h3, #templateModal h4,
        #templateModal label, #templateModal span, #templateModal p, #templateModal div {
            color: #1f2937 !important;
            background: transparent !important;
            text-shadow: none !important;
            font-weight: 600 !important;
        }

        /* Champs de saisie avec contraste optimal */
        .modal-content input,
        .modal-content select,
        .modal-content textarea,
        #templateModal input,
        #templateModal select,
        #templateModal textarea,
        .glass-modal-content input,
        .glass-modal-content select,
        .glass-modal-content textarea,
        #email-templates-section input,
        #email-templates-section select,
        #email-templates-section textarea {
            background: #ffffff !important;
            border: 2px solid #374151 !important;
            color: #1f2937 !important;
            padding: 12px 16px !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            width: 100% !important;
            box-sizing: border-box !important;
            outline: none !important;
        }

        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus,
        #templateModal input:focus,
        #templateModal select:focus,
        #templateModal textarea:focus {
            border-color: #2563eb !important;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1) !important;
        }

        #email-templates-section .glass-modal-content .glass-input::placeholder,
        #email-templates-section .glass-modal-content .glass-textarea::placeholder,
        #email-templates-section .glass-modal-content input::placeholder,
        #email-templates-section .glass-modal-content textarea::placeholder {
            color: #9ca3af !important;
        }

        /* Grid layouts for email templates */
        #email-templates-section .glass-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
            gap: 1.5rem !important;
            margin-bottom: 2rem !important;
        }

        #email-templates-section .filter-controls {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 1rem !important;
            align-items: end !important;
            margin-bottom: 2rem !important;
        }

        #email-templates-section .filter-group {
            display: flex !important;
            flex-direction: column !important;
            gap: 0.5rem !important;
        }

        #email-templates-section .filter-group label {
            font-weight: 500 !important;
            color: white !important;
            font-size: 0.9rem !important;
        }

        #email-templates-section .templates-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)) !important;
            gap: 1.5rem !important;
            margin-bottom: 2rem !important;
        }

        #email-templates-section .template-card {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 12px !important;
            padding: 1.5rem !important;
            transition: all 0.3s ease !important;
            position: relative !important;
            overflow: hidden !important;
            color: #1f2937 !important;
        }

        #email-templates-section .template-card * {
            color: #1f2937 !important;
        }

        #email-templates-section .template-card h3,
        #email-templates-section .template-card h4 {
            color: #1f2937 !important;
            font-weight: 600 !important;
            margin-bottom: 0.5rem !important;
        }

        #email-templates-section .template-card p,
        #email-templates-section .template-card span {
            color: #4b5563 !important;
            font-weight: 400 !important;
        }

        #email-templates-section .template-card:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15) !important;
            border-color: rgba(37, 99, 235, 0.4) !important;
        }

        /* Boutons dans les cards de templates */
        #email-templates-section .template-card .btn,
        #email-templates-section .template-card button {
            background: #2563eb !important;
            color: #ffffff !important;
            border: 1px solid #2563eb !important;
            padding: 8px 16px !important;
            border-radius: 6px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            margin: 2px !important;
            cursor: pointer !important;
            text-decoration: none !important;
            display: inline-block !important;
            transition: all 0.2s ease !important;
        }

        #email-templates-section .template-card .btn:hover,
        #email-templates-section .template-card button:hover {
            background: #1d4ed8 !important;
            border-color: #1d4ed8 !important;
        }

        #email-templates-section .template-card .btn-secondary {
            background: #6b7280 !important;
            border-color: #6b7280 !important;
        }

        #email-templates-section .template-card .btn-secondary:hover {
            background: #4b5563 !important;
            border-color: #4b5563 !important;
        }

        #email-templates-section .loading-state,
        #email-templates-section .empty-state {
            text-align: center !important;
            padding: 4rem 2rem !important;
            color: white !important;
        }

        #email-templates-section .loading-spinner {
            width: 48px !important;
            height: 48px !important;
            border: 4px solid rgba(255, 255, 255, 0.2) !important;
            border-top: 4px solid white !important;
            border-radius: 50% !important;
            animation: spin 1s linear infinite !important;
            margin: 0 auto 1rem !important;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Text colors for email templates section */
        #email-templates-section,
        #email-templates-section * {
            color: white !important;
        }

        /* Exceptions pour les éléments nécessitant du texte sombre */
        #email-templates-section .glass-modal-content,
        #email-templates-section .glass-modal-content *,
        #email-templates-section .glass-input,
        #email-templates-section .glass-select,
        #email-templates-section .glass-textarea {
            color: #1f2937 !important;
        }

        /* Templates cards avec contraste amélioré */
        #email-templates-section .template-card {
            color: #1f2937 !important;
        }

        #email-templates-section .template-card * {
            color: #1f2937 !important;
        }

        /* Fix pour les placeholders */
        #email-templates-section .glass-input::placeholder,
        #email-templates-section .glass-textarea::placeholder,
        #email-templates-section input::placeholder,
        #email-templates-section textarea::placeholder {
            color: #9ca3af !important;
            opacity: 1 !important;
        }

        /* APERÇU TEMPLATES - Styles spécifiques pour prévisualisation */
        .preview-container,
        #email-templates-section .preview-container,
        .glass-modal .preview-container {
            background: #ffffff !important;
            border: 2px solid #e5e7eb !important;
            border-radius: 12px !important;
            overflow: hidden !important;
            color: #1f2937 !important;
        }

        .preview-header,
        #email-templates-section .preview-header,
        .glass-modal .preview-header {
            padding: 1rem !important;
            background: #f9fafb !important;
            border-bottom: 2px solid #e5e7eb !important;
            color: #1f2937 !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        .preview-header h3,
        #email-templates-section .preview-header h3,
        .glass-modal .preview-header h3 {
            color: #1f2937 !important;
            font-weight: 600 !important;
            margin: 0 !important;
        }

        .email-preview,
        #email-templates-section .email-preview,
        .glass-modal .email-preview {
            padding: 1.5rem !important;
            background: #ffffff !important;
            color: #1f2937 !important;
            min-height: 200px !important;
        }

        .email-subject,
        #email-templates-section .email-subject,
        .glass-modal .email-subject {
            margin-bottom: 1rem !important;
            padding: 1rem !important;
            background: #f8fafc !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 6px !important;
            color: #1f2937 !important;
        }

        .email-subject strong,
        #email-templates-section .email-subject strong,
        .glass-modal .email-subject strong {
            color: #1f2937 !important;
            font-weight: 600 !important;
        }

        .email-content,
        #email-templates-section .email-content,
        .glass-modal .email-content {
            color: #374151 !important;
            line-height: 1.6 !important;
            background: #ffffff !important;
            padding: 1rem !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 6px !important;
            min-height: 150px !important;
        }

        .email-metadata,
        #email-templates-section .email-metadata,
        .glass-modal .email-metadata {
            margin-bottom: 1rem !important;
            font-size: 0.9rem !important;
            color: #6b7280 !important;
            background: #f3f4f6 !important;
            padding: 0.75rem !important;
            border-radius: 4px !important;
        }

        /* Onglet d'aperçu actif */
        #previewTab,
        #email-templates-section #previewTab {
            background: #ffffff !important;
            color: #1f2937 !important;
            padding: 1rem !important;
        }

        /* Texte dans l'aperçu */
        #previewTab *,
        #email-templates-section #previewTab *,
        #emailPreview,
        #email-templates-section #emailPreview,
        #emailPreview *,
        #email-templates-section #emailPreview *,
        #previewSubject,
        #email-templates-section #previewSubject,
        #previewContent,
        #email-templates-section #previewContent {
            color: #1f2937 !important;
            background: transparent !important;
        }

        /* Modal d'aperçu template (popup) - styles spécifiques */
        .modal.show .modal-content.glass-modal-content {
            background: #ffffff !important;
            color: #1f2937 !important;
        }

        .modal.show .modal-content .email-preview,
        .modal.show .modal-content .email-subject,
        .modal.show .modal-content .email-content,
        .modal.show .modal-content .email-metadata {
            background: #ffffff !important;
            color: #1f2937 !important;
        }

        /* Contenu HTML dans l'aperçu */
        .email-content p,
        .email-content div,
        .email-content span,
        .email-content h1,
        .email-content h2,
        .email-content h3,
        .email-content h4,
        .email-content h5,
        .email-content h6,
        #email-templates-section .email-content p,
        #email-templates-section .email-content div,
        #email-templates-section .email-content span,
        #email-templates-section .email-content h1,
        #email-templates-section .email-content h2,
        #email-templates-section .email-content h3,
        #email-templates-section .email-content h4,
        #email-templates-section .email-content h5,
        #email-templates-section .email-content h6 {
            color: #374151 !important;
            background: transparent !important;
        }

        /* Variables template et contenu dynamique */
        .email-content em,
        .email-content strong,
        .email-content b,
        #email-templates-section .email-content em,
        #email-templates-section .email-content strong,
        #email-templates-section .email-content b {
            color: #1f2937 !important;
        }

        /* Force tous les éléments textuels dans l'aperçu en mode sombre */
        .glass-modal-content[style*="max-width: 800px"] {
            background: #ffffff !important;
            color: #1f2937 !important;
        }

        .glass-modal-content[style*="max-width: 800px"] * {
            color: #1f2937 !important;
        }

        .glass-modal-content[style*="max-width: 800px"] .email-preview {
            background: #ffffff !important;
        }

        .glass-modal-content[style*="max-width: 800px"] .email-subject {
            background: #f8fafc !important;
            color: #1f2937 !important;
        }

        .glass-modal-content[style*="max-width: 800px"] .email-content {
            background: #ffffff !important;
            color: #374151 !important;
        }

        /* PROTECTION GLOBALE APERÇU - Force tout contenu d'aperçu en mode clair */
        div[style*="padding: 2rem"] .email-preview,
        div[style*="padding: 2rem"] .email-preview *,
        .modal-content[style*="max-width: 800px"] div,
        .modal-content[style*="max-width: 800px"] span,
        .modal-content[style*="max-width: 800px"] p,
        .modal-content[style*="max-width: 800px"] h1,
        .modal-content[style*="max-width: 800px"] h2,
        .modal-content[style*="max-width: 800px"] h3,
        .modal-content[style*="max-width: 800px"] h4 {
            color: #1f2937 !important;
            background: transparent !important;
        }

        /* Surcharge spécifique pour contenu HTML injecté */
        .email-preview[style],
        .email-subject[style],
        .email-content[style],
        .email-metadata[style] {
            background: #ffffff !important;
            color: #1f2937 !important;
        }

        .email-preview[style] *,
        .email-subject[style] *,
        .email-content[style] *,
        .email-metadata[style] * {
            color: #1f2937 !important;
        }

        /* APERÇU TEMPLATES - Style inline forcé (JavaScript généré) */
        [style*="padding: 2rem"] {
            background: #ffffff !important;
            color: #1f2937 !important;
        }

        [style*="margin-bottom: 1rem; padding: 1rem; background: #f8fafc"] {
            background: #f8fafc !important;
            color: #1f2937 !important;
            border: 1px solid #e2e8f0 !important;
        }

        [style*="margin-bottom: 1rem; font-size: 0.9rem; color: #6b7280"] {
            background: #f3f4f6 !important;
            color: #6b7280 !important;
        }

        /* Force toutes les divs générées par JS d'aperçu */
        .modal.show div[style*="font-size: 0.9rem"],
        .modal.show div[style*="margin-bottom: 1rem"],
        .modal.show div[style*="padding: 1rem"] {
            color: #1f2937 !important;
        }

        /* Styles spécifiques pour le HTML généré dans previewTemplate() */
        .modal.show .glass-modal-content div[style*="padding: 2rem"] {
            background: #ffffff !important;
            color: #1f2937 !important;
        }

        .modal.show .glass-modal-content div[style*="padding: 2rem"] div {
            color: #1f2937 !important;
        }

        .modal.show .glass-modal-content div[style*="padding: 2rem"] strong {
            color: #1f2937 !important;
        }

        /* Override ultra-spécifique pour l'aperçu des templates */
        .modal.glass-modal.show .modal-content.glass-modal-content[style*="max-width: 800px"] {
            background: #ffffff !important;
            color: #1f2937 !important;
        }

        .modal.glass-modal.show .modal-content.glass-modal-content[style*="max-width: 800px"] * {
            color: #1f2937 !important;
        }

        .modal.glass-modal.show .modal-content.glass-modal-content[style*="max-width: 800px"] .email-preview,
        .modal.glass-modal.show .modal-content.glass-modal-content[style*="max-width: 800px"] .email-subject,
        .modal.glass-modal.show .modal-content.glass-modal-content[style*="max-width: 800px"] .email-content,
        .modal.glass-modal.show .modal-content.glass-modal-content[style*="max-width: 800px"] .email-metadata {
            background: white !important;
            color: #1f2937 !important;
        }

        .modal.glass-modal.show .modal-content.glass-modal-content[style*="max-width: 800px"] div[style*="background: #f8fafc"] {
            background: #f8fafc !important;
            color: #1f2937 !important;
        }

        .modal.glass-modal.show .modal-content.glass-modal-content[style*="max-width: 800px"] div[style*="background: white"] {
            background: white !important;
            color: #1f2937 !important;
        }

        .modal.glass-modal.show .modal-content.glass-modal-content[style*="max-width: 800px"] div[style*="color: #6b7280"] {
            color: #6b7280 !important;
        }

        /* Override pour tous les éléments dans l'aperçu */
        .modal.glass-modal.show[style*="max-width: 800px"] div[style*="padding: 1.5rem"] {
            background: white !important;
            color: #1f2937 !important;
        }

        /* Titres et labels dans les modales */
        #email-templates-section .glass-modal-content h2,
        #email-templates-section .glass-modal-content h3,
        #email-templates-section .glass-modal-content label {
            color: #1f2937 !important;
            font-weight: 600 !important;
        }

        /* Boutons de la modal - style ultra visible et accessible */
        .modal-content .glass-btn,
        .modal-content .btn,
        .modal-content button,
        #templateModal .glass-btn,
        #templateModal .btn,
        #templateModal button,
        #email-templates-section .glass-modal-content .glass-btn,
        #email-templates-section .glass-modal-content .btn,
        #email-templates-section .glass-modal-content button {
            background: #2563eb !important;
            color: #ffffff !important;
            border: 2px solid #2563eb !important;
            padding: 12px 20px !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            text-decoration: none !important;
            display: inline-block !important;
            margin: 4px !important;
            min-height: 44px !important;
            line-height: 1.2 !important;
        }

        .modal-content .glass-btn:hover,
        .modal-content .btn:hover,
        .modal-content button:hover,
        #templateModal .glass-btn:hover,
        #templateModal .btn:hover,
        #templateModal button:hover,
        #email-templates-section .glass-modal-content .glass-btn:hover,
        #email-templates-section .glass-modal-content .btn:hover,
        #email-templates-section .glass-modal-content button:hover {
            background: #1d4ed8 !important;
            border-color: #1d4ed8 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3) !important;
        }

        /* Boutons secondaires */
        .modal-content .btn-secondary,
        #templateModal .btn-secondary,
        #email-templates-section .glass-modal-content .btn-secondary {
            background: #6b7280 !important;
            border-color: #6b7280 !important;
            color: #ffffff !important;
        }

        .modal-content .btn-secondary:hover,
        #templateModal .btn-secondary:hover,
        #email-templates-section .glass-modal-content .btn-secondary:hover {
            background: #4b5563 !important;
            border-color: #4b5563 !important;
        }

        /* Bouton fermer modal - amélioration contraste */
        .modal-content .close,
        .modal-content .close-btn,
        #templateModal .close,
        #templateModal .close-btn,
        #email-templates-section .glass-modal-content .close,
        #email-templates-section .glass-modal-content .close-btn {
            color: #6b7280 !important;
            font-size: 20px !important;
            font-weight: bold !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            padding: 8px !important;
            position: absolute !important;
            top: 12px !important;
            right: 12px !important;
            width: 32px !important;
            height: 32px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 4px !important;
            transition: all 0.2s ease !important;
        }

        .modal-content .close:hover,
        .modal-content .close-btn:hover,
        #templateModal .close:hover,
        #templateModal .close-btn:hover,
        #email-templates-section .glass-modal-content .close:hover,
        #email-templates-section .glass-modal-content .close-btn:hover {
            color: #1f2937 !important;
            background: #f3f4f6 !important;
        }

        /* Onglets de la modal - amélioration contraste */
        .modal-tabs,
        #templateModal .modal-tabs {
            display: flex !important;
            border-bottom: 2px solid #e5e7eb !important;
            margin-bottom: 20px !important;
        }

        .tab-btn,
        #templateModal .tab-btn {
            background: none !important;
            border: none !important;
            padding: 12px 20px !important;
            cursor: pointer !important;
            color: #6b7280 !important;
            font-weight: 500 !important;
            border-bottom: 2px solid transparent !important;
            transition: all 0.2s ease !important;
        }

        .tab-btn.active,
        #templateModal .tab-btn.active {
            color: #2563eb !important;
            border-bottom-color: #2563eb !important;
            font-weight: 600 !important;
        }

        .tab-btn:hover,
        #templateModal .tab-btn:hover {
            color: #1f2937 !important;
            background: #f9fafb !important;
        }

        /* Fix dropdown menu background */
        #addContentDropdown {
            background: rgba(75, 85, 99, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 8px !important;
        }

        #addContentDropdown a {
            color: white !important;
            padding: 8px 16px !important;
            display: block !important;
            text-decoration: none !important;
        }

        #addContentDropdown a:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        #email-templates-section .page-title {
            font-size: 2.5rem !important;
            font-weight: bold !important;
            margin-bottom: 0.5rem !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1) !important;
        }

        #email-templates-section .page-description {
            font-size: 1.1rem !important;
            opacity: 0.9 !important;
        }

        #email-templates-section .stat-content h3 {
            font-size: 2rem !important;
            font-weight: bold !important;
            margin-bottom: 0.25rem !important;
        }

        #email-templates-section .stat-content p {
            font-size: 0.9rem !important;
            opacity: 0.8 !important;
        }

        /* Modal specific styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }

        .modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            width: 800px;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-btn.active {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6 !important;
            border-bottom: 2px solid #3b82f6;
        }

        .tab-content {
            display: none;
            padding: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .toolbar-btn {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(0, 0, 0, 0.2);
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .toolbar-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .toolbar-section {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            padding-right: 1rem;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toolbar-section:last-child {
            border-right: none;
        }

        .mode-btn.active {
            background: #3b82f6 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .visual-editor {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
        }

        .visual-editor h1, .visual-editor h2, .visual-editor h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .visual-editor p {
            margin-bottom: 1rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .preview-container {
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        .preview-header {
            padding: 1rem;
            background: rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .email-preview {
            padding: 1.5rem;
        }

        .email-subject {
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        .email-content {
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 200px;
            background: white;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Ensure main content area is always light */
        .admin-interface .main-content {
            background: #F8FAFC !important;
            background-image: none !important;
        }

        /* Override any dark text colors */
        .admin-interface p,
        .admin-interface span,
        .admin-interface div,
        .admin-interface td,
        .admin-interface th,
        .admin-interface label {
            color: #1F2937 !important;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #1F2937, #374151);
            color: white;
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 2rem 1.5rem 1rem;
            border-bottom: 1px solid #4B5563;
            text-align: center;
        }

        .admin-logo {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .admin-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .admin-subtitle {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .nav-menu {
            list-style: none;
            padding: 1rem 0;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(16, 185, 129, 0.2);
            border-right: 3px solid #10B981;
        }

        .nav-icon {
            font-size: 1.2rem;
            margin-right: 0.75rem;
            width: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }

        .page-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #E5E7EB;
        }

        .page-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1F2937;
        }

        .page-description {
            color: #6B7280;
            margin-top: 0.5rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .stat-card.primary { border-left-color: #10B981; }
        .stat-card.secondary { border-left-color: #3B82F6; }
        .stat-card.warning { border-left-color: #F59E0B; }
        .stat-card.danger { border-left-color: #EF4444; }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .stat-title {
            color: #6B7280;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .stat-icon {
            font-size: 1.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1F2937;
        }

        .stat-change {
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        .stat-change.positive { color: #10B981; }
        .stat-change.negative { color: #EF4444; }

        /* Content Sections */
        .content-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            padding: 1.5rem;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1F2937;
        }

        .section-content {
            padding: 1.5rem;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
        }

        .data-table th {
            background: #F9FAFB;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .data-table tr:hover {
            background: #F9FAFB;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.active {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-badge.pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .status-badge.inactive {
            background: #FEE2E2;
            color: #991B1B;
        }

        .status-badge.trial {
            background: #DBEAFE;
            color: #1E40AF;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #10B981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #6B7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4B5563;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }
        
        .btn-tab {
            background: #F3F4F6;
            color: #4B5563;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-tab:hover {
            background: #E5E7EB;
        }

        .btn-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .content-tab-panel {
            display: block;
        }

        .content-tab-panel.hidden {
            display: none;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-info {
            background: #DBEAFE;
            color: #1E40AF;
        }
        
        .account-type-option {
            cursor: pointer;
            flex: 1;
        }
        
        .account-type-option input[type="radio"] {
            display: none;
        }
        
        .account-type-card {
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            background: #F9FAFB;
        }
        
        .account-type-card:hover {
            border-color: #D1D5DB;
            background: #F3F4F6;
        }
        
        .account-type-option input[type="radio"]:checked + .account-type-card {
            border-color: #10B981;
            background: #ECFDF5;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .account-type-card h3 {
            margin: 0.5rem 0;
            color: #1F2937;
            font-size: 1.1rem;
        }
        
        .account-type-card p {
            margin: 0.25rem 0;
            color: #6B7280;
            font-size: 0.875rem;
        }
        
        .account-type-card small {
            color: #9CA3AF;
            font-size: 0.75rem;
        }
        
        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .form-section h3 {
            color: #1F2937;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .btn-success {
            background: #10B981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #EF4444;
            color: white;
        }

        .btn-danger:hover {
            background: #DC2626;
        }
        
        .btn-warning {
            background: #F59E0B;
            color: white;
        }

        .btn-warning:hover {
            background: #D97706;
        }

        /* Charts */
        .chart-container {
            height: 300px;
            display: flex;
            align-items: end;
            gap: 1rem;
            padding: 1rem;
            background: #F9FAFB;
            border-radius: 8px;
        }

        .chart-bar {
            background: #10B981;
            border-radius: 4px 4px 0 0;
            min-width: 30px;
            position: relative;
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            background: #059669;
        }

        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #6B7280;
            white-space: nowrap;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10B981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: static;
                height: auto;
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }

        /* Styles pour les plans tarifaires */
        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .plan-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .plan-card:hover {
            border-color: #3B82F6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .plan-card.featured {
            border-color: #10B981;
            background: linear-gradient(135deg, #ECFDF5 0%, #F0FDF4 100%);
        }

        .plan-card.featured::before {
            content: "⭐ Populaire";
            position: absolute;
            top: -10px;
            right: 1rem;
            background: #10B981;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .plan-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #E5E7EB;
        }

        .plan-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 0.5rem;
        }

        .plan-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .plan-type.individual {
            background: #DBEAFE;
            color: #1D4ED8;
        }

        .plan-type.family {
            background: #DCFCE7;
            color: #166534;
        }

        .plan-price {
            font-size: 2rem;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 0.25rem;
        }

        .plan-duration {
            color: #6B7280;
            font-size: 0.875rem;
        }

        .plan-features {
            margin: 1.5rem 0;
        }

        .plan-features ul {
            list-style: none;
            padding: 0;
        }

        .plan-features li {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            color: #4B5563;
            font-size: 0.875rem;
        }

        .plan-features li::before {
            content: "✅";
            margin-right: 0.75rem;
        }

        .plan-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .checkbox-item:hover {
            background-color: #F9FAFB;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filter-group select {
            padding: 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #E5E7EB;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .plan-status {
            position: absolute;
            top: 1rem;
            left: 1rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .plan-status.active {
            background: #DCFCE7;
            color: #166534;
        }

        .plan-status.inactive {
            background: #FEE2E2;
            color: #DC2626;
        }

        .plan-status.draft {
            background: #F3F4F6;
            color: #6B7280;
        }

        /* Styles pour le formulaire de connexion admin */
        .admin-login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .admin-login-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 3rem 2.5rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .admin-login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .admin-login-header h1 {
            color: #1F2937 !important;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .admin-login-header p {
            color: #6B7280 !important;
            font-size: 0.9rem;
        }

        .admin-login-form .input-group {
            margin-bottom: 1.5rem;
        }

        .admin-login-form label {
            display: block;
            color: #374151 !important;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .admin-login-form input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            color: #1F2937 !important;
        }

        .admin-login-form input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .admin-login-btn {
            width: 100%;
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            color: white !important;
            border: none;
            padding: 0.875rem 1rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .admin-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .admin-error-message {
            background: #FEE2E2;
            color: #DC2626 !important;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
            border-left: 4px solid #DC2626;
        }

        .admin-login-footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #E5E7EB;
        }

        .admin-login-footer p {
            color: #6B7280 !important;
            font-size: 0.8rem;
        }

        /* Cacher l'interface admin par défaut */
        .admin-container {
            display: none;
        }

        .admin-container.authenticated {
            display: block;
        }

        /* ==========================================
           EMAIL AUTOMATION STYLES
           ========================================== */

        /* Stats cards for automation */
        .automation-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .automation-stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .automation-stat-card .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #FFD700;
            display: block;
        }

        .automation-stat-card .stat-label {
            font-size: 0.9rem;
            color: #E5E7EB;
            margin-top: 0.5rem;
        }

        /* Triggers grid */
        .triggers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .automation-trigger-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .automation-trigger-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .automation-trigger-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .automation-trigger-header h4 {
            margin: 0;
            color: #FFD700;
            font-size: 1.1rem;
        }

        /* Toggle switch */
        .trigger-toggle .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .trigger-toggle .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .trigger-toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #6B7280;
            transition: .4s;
            border-radius: 24px;
        }

        .trigger-toggle .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .trigger-toggle input:checked + .slider {
            background-color: #10B981;
        }

        .trigger-toggle input:checked + .slider:before {
            transform: translateX(26px);
        }

        .trigger-description {
            color: #D1D5DB;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        /* Trigger details */
        .trigger-details {
            margin-bottom: 1rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .detail-label {
            font-weight: 500;
            color: #9CA3AF;
            font-size: 0.85rem;
        }

        .detail-value {
            color: #E5E7EB;
            font-size: 0.85rem;
        }

        /* Trigger stats */
        .trigger-stats {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 1.25rem;
            font-weight: bold;
            color: #FFD700;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #9CA3AF;
            margin-top: 0.25rem;
        }

        /* Trigger actions */
        .trigger-actions {
            display: flex;
            gap: 0.5rem;
        }

        .trigger-actions .btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.8rem;
        }

        /* Email queue table */
        .email-queue-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 500;
            color: #E5E7EB;
            font-size: 0.9rem;
        }

        .user-email {
            color: #9CA3AF;
            font-size: 0.8rem;
        }

        /* Analytics section */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .analytics-card .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #10B981;
            display: block;
        }

        .analytics-card .metric-label {
            color: #E5E7EB;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* Badges for status */
        .glass-badge-info {
            background: rgba(59, 130, 246, 0.3);
            color: #93C5FD;
            border: 1px solid rgba(59, 130, 246, 0.5);
        }

        .glass-badge-warning {
            background: rgba(245, 158, 11, 0.3);
            color: #FCD34D;
            border: 1px solid rgba(245, 158, 11, 0.5);
        }

        .glass-badge-success {
            background: rgba(16, 185, 129, 0.3);
            color: #6EE7B7;
            border: 1px solid rgba(16, 185, 129, 0.5);
        }

        .glass-badge-danger {
            background: rgba(239, 68, 68, 0.3);
            color: #FCA5A5;
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        /* Section headers */
        .automation-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .automation-section-header h3 {
            margin: 0;
            color: #FFD700;
            font-size: 1.4rem;
        }

        /* Responsive for automation */
        @media (max-width: 768px) {
            .triggers-grid {
                grid-template-columns: 1fr;
            }

            .automation-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .trigger-stats {
                flex-direction: column;
                gap: 0.5rem;
            }

            .trigger-actions {
                flex-direction: column;
            }
        }

        /* === END EMAIL AUTOMATION STYLES === */

        /* === DATA MANAGEMENT STYLES === */
        .data-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .data-status-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #FFD700;
        }

        .data-status-item h4 {
            color: #FFD700;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .data-status-item p {
            margin: 4px 0;
            font-size: 13px;
        }

        .data-status-item small {
            opacity: 0.7;
            font-size: 11px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .button-grid button {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .button-grid button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        /* === END DATA MANAGEMENT STYLES === */

    </style>
</head>
<body>
    <!-- Formulaire de connexion administrateur -->
    <div id="adminLoginForm" class="admin-login-overlay">
        <div class="admin-login-container">
            <div class="admin-login-header">
                <h1>🔐 Connexion Administrateur</h1>
                <p>Accès sécurisé à l'interface d'administration Claudyne</p>
            </div>

            <form id="adminAuthForm" class="admin-login-form">
                <div class="input-group">
                    <label for="adminEmail">Email, nom d'utilisateur ou téléphone</label>
                    <input type="text" id="adminEmail" name="credential" placeholder="admin@claudyne.com, admin ou Admin" required>
                </div>

                <div class="input-group">
                    <label for="adminPassword">Mot de passe</label>
                    <input type="password" id="adminPassword" name="password" placeholder="••••••••" required>
                </div>

                <button type="submit" id="adminLoginBtn" class="admin-login-btn">
                    Se connecter
                </button>

                <div style="text-align: center; margin-top: 1rem;">
                    <button type="button" onclick="showForgotPassword()" style="
                        background: none;
                        border: none;
                        color: #3B82F6;
                        font-size: 0.9rem;
                        cursor: pointer;
                        text-decoration: underline;
                        padding: 0.5rem;
                    ">
                        Mot de passe oublié ?
                    </button>
                </div>

                <div id="adminLoginError" class="admin-error-message" style="display: none;"></div>
            </form>

            <div class="admin-login-footer">
                <p>Interface réservée aux administrateurs autorisés</p>
            </div>
        </div>
    </div>

    <!-- Modal Mot de passe oublié -->
    <div id="forgotPasswordModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 20000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    ">
        <div style="
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        ">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🔐</div>
                <h2 style="color: #1F2937; margin: 0; font-size: 1.5rem;">
                    Récupération de mot de passe
                </h2>
                <p style="color: #6B7280; margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                    Entrez votre email pour recevoir un lien de réinitialisation
                </p>
            </div>

            <form id="forgotPasswordForm">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                        Email administrateur
                    </label>
                    <input type="email" id="forgotEmail" required style="
                        width: 100%;
                        padding: 0.875rem 1rem;
                        border: 2px solid #E5E7EB;
                        border-radius: 10px;
                        font-size: 1rem;
                        transition: all 0.2s;
                        box-sizing: border-box;
                    " placeholder="admin@claudyne.com">
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" onclick="closeForgotPassword()" style="
                        flex: 1;
                        background: #F3F4F6;
                        color: #374151;
                        border: none;
                        padding: 0.875rem 1rem;
                        border-radius: 10px;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">
                        Annuler
                    </button>
                    <button type="submit" id="sendResetBtn" style="
                        flex: 1;
                        background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
                        color: white;
                        border: none;
                        padding: 0.875rem 1rem;
                        border-radius: 10px;
                        font-size: 1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                    ">
                        Envoyer le lien
                    </button>
                </div>

                <div id="forgotPasswordMessage" style="
                    margin-top: 1rem;
                    padding: 0.875rem;
                    border-radius: 10px;
                    font-size: 0.9rem;
                    display: none;
                "></div>
            </form>
        </div>
    </div>

    <!-- Particules d'arrière-plan -->
    <div class="glass-particles">
        <div class="glass-particle" style="left: 10%; animation-delay: 0s;"></div>
        <div class="glass-particle" style="left: 20%; animation-delay: 1s;"></div>
        <div class="glass-particle" style="left: 30%; animation-delay: 2s;"></div>
        <div class="glass-particle" style="left: 40%; animation-delay: 0.5s;"></div>
        <div class="glass-particle" style="left: 50%; animation-delay: 1.5s;"></div>
        <div class="glass-particle" style="left: 60%; animation-delay: 2.5s;"></div>
        <div class="glass-particle" style="left: 70%; animation-delay: 0.2s;"></div>
        <div class="glass-particle" style="left: 80%; animation-delay: 1.2s;"></div>
        <div class="glass-particle" style="left: 90%; animation-delay: 2.2s;"></div>
    </div>

    <div class="admin-container admin-interface">
        <!-- Sidebar -->
        <div class="sidebar glass-nav">
            <div class="sidebar-header glass-text-primary">
                <div class="admin-logo animate-pulse">👨‍💼</div>
                <div class="admin-title glass-text-primary">Admin Claudyne</div>
                <div class="admin-subtitle glass-text-secondary">Panneau de contrôle</div>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                            <span class="nav-icon">📊</span>
                            Tableau de bord
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('users')">
                            <span class="nav-icon">👥</span>
                            Gestion des familles
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('family-links')">
                            <span class="nav-icon">🔗</span>
                            Liaisons Famille-Étudiants
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('roles-management')">
                            <span class="nav-icon">🎭</span>
                            Gestion des rôles
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('staff-management')">
                            <span class="nav-icon">👨‍🏫</span>
                            Équipe pédagogique
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('content')">
                            <span class="nav-icon">📚</span>
                            Contenu pédagogique
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('payments')">
                            <span class="nav-icon">💰</span>
                            Paiements
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('analytics')">
                            <span class="nav-icon">📈</span>
                            Analyses
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('free-modules')">
                            <span class="nav-icon">🆓</span>
                            Modules gratuits
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('trial-management')">
                            <span class="nav-icon">⏰</span>
                            Gestion essais
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('communication')">
                            <span class="nav-icon">📧</span>
                            Communication
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('email-templates')">
                            <span class="nav-icon">🎨</span>
                            Templates Email
                        </a>
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('email-automation')">
                            <span class="nav-icon">🤖</span>
                            Automatisation
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('reports')">
                            <span class="nav-icon">📊</span>
                            Rapports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('system-monitoring')">
                            <span class="nav-icon">🖥️</span>
                            Monitoring
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('pricing-plans')">
                            <span class="nav-icon">💰</span>
                            Plans tarifaires
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('subscriptions-management')">
                            <span class="nav-icon">📊</span>
                            Gestion Abonnements
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('data-management')">
                            <span class="nav-icon">🔧</span>
                            Gestion Données
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="showSection('settings')">
                            <span class="nav-icon">⚙️</span>
                            Paramètres
                        </a>
                    </li>
                    <li class="nav-item" style="margin-top: 2rem; border-top: 1px solid #4B5563; padding-top: 1rem;">
                        <a class="nav-link glass-nav-item" href="javascript:void(0)" onclick="adminLogout()" style="color: #F87171 !important;">
                            <span class="nav-icon">🚪</span>
                            Se déconnecter
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Tableau de bord</h1>
                        <p class="page-description">Vue d'ensemble de la plateforme Claudyne</p>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card glass-stat-card primary">
                        <div class="stat-header">
                            <span class="stat-title">Familles Actives</span>
                            <span class="stat-icon">👨‍👩‍👧‍👦</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="active-families">-</div>
                        <div class="stat-change positive">+12% ce mois</div>
                    </div>

                    <div class="stat-card glass-stat-card secondary">
                        <div class="stat-header">
                            <span class="stat-title">Étudiants Actifs</span>
                            <span class="stat-icon">🎓</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="active-students">-</div>
                        <div class="stat-change positive">+8% ce mois</div>
                    </div>

                    <div class="stat-card glass-stat-card warning">
                        <div class="stat-header">
                            <span class="stat-title">Revenus (Mois)</span>
                            <span class="stat-icon">💰</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="monthly-revenue">-</div>
                        <div class="stat-change positive">+15% ce mois</div>
                    </div>

                    <div class="stat-card glass-stat-card danger">
                        <div class="stat-header">
                            <span class="stat-title">Quiz Terminés</span>
                            <span class="stat-icon">🧠</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="quizzes-taken">-</div>
                        <div class="stat-change positive">+22% ce mois</div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Activité récente</h2>
                        <button class="btn btn-primary btn-sm">Actualiser</button>
                    </div>
                    <div class="section-content">
                        <div id="recent-activity">
                            <div class="loading"></div> Chargement des activités...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Gestion des abonnés</h1>
                        <p class="page-description">Comptes familiaux et individuels - Création, modification, suivi - Contrôle total de la base abonnés</p>
                    </div>
                </div>

                <!-- Search and Filter Tools -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Recherche et filtres</h2>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Rechercher par ID abonné</label>
                                <input type="text" id="subscriberIdSearch" placeholder="Ex: FAM-001234 ou IND-005678" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Nom / Titre compte</label>
                                <input type="text" id="accountNameSearch" placeholder="Famille Mbarga, Jean Doe..." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Statut</label>
                                <select id="statusFilter" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="">Tous</option>
                                    <option value="active">Actif</option>
                                    <option value="trial">Essai</option>
                                    <option value="expired">Expiré</option>
                                    <option value="suspended">Suspendu</option>
                                </select>
                            </div>
                            <button class="btn btn-primary glass-btn glass-btn-primary" onclick="searchSubscribers()" style="padding: 0.75rem 1.5rem;">🔍 Rechercher</button>
                        </div>
                    </div>
                </div>

                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Abonnés enregistrés</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success btn-sm" onclick="showCreateAccountModal()">➕ Nouveau Compte</button>
                            <button class="btn btn-secondary btn-sm" onclick="showTrialManagement()">📅 Gestion Essais</button>
                            <button class="btn btn-primary btn-sm" onclick="exportSubscribersCSV()">📊 Exporter CSV</button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="users-table">
                            <div class="loading"></div> Chargement des familles...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Section -->
            <div id="content-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Contenu pédagogique</h1>
                        <p class="page-description">Gestion des cours, quiz et évaluations</p>
                    </div>
                </div>

                <!-- Content Management Tabs -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-tab active" onclick="showContentTab('courses')" id="courses-tab">📚 Cours</button>
                            <button class="btn btn-tab" onclick="showContentTab('quizzes')" id="quizzes-tab">🧠 Quiz</button>
                            <button class="btn btn-tab" onclick="showContentTab('resources')" id="resources-tab">📖 Ressources</button>
                        </div>
                        <div class="dropdown" style="position: relative; display: inline-block;">
                            <button class="btn btn-primary btn-sm glass-btn glass-btn-primary" id="addContentBtn">➕ Ajouter contenu</button>
                            <div class="dropdown-content" id="addContentDropdown" style="display: none; position: absolute; background: rgba(255,255,255,0.95); min-width: 200px; border-radius: 12px; z-index: 1000; top: 100%;">
                                <button class="glass-btn" style="width: 100%; margin: 0.25rem 0; border-radius: 8px;" onclick="showAddCourseModal()">📚 Nouveau Cours</button>
                                <button class="glass-btn" style="width: 100%; margin: 0.25rem 0; border-radius: 8px;" onclick="showAddQuizModal()">🧠 Nouveau Quiz</button>
                                <button class="glass-btn" style="width: 100%; margin: 0.25rem 0; border-radius: 8px;" onclick="showAddResourceModal()">📖 Nouvelle Ressource</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-content">
                        <div id="courses-content" class="content-tab-panel">
                            <div id="courses-table">
                                <div class="loading"></div> Chargement des cours...
                            </div>
                        </div>
                        
                        <div id="quizzes-content" class="content-tab-panel hidden">
                            <div id="quizzes-table">
                                <div class="loading"></div> Chargement des quiz...
                            </div>
                        </div>
                        
                        <div id="resources-content" class="content-tab-panel hidden">
                            <div id="resources-table">
                                <div class="loading"></div> Chargement des ressources...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payments Section -->
            <div id="payments-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Gestion des paiements</h1>
                        <p class="page-description">Transactions et abonnements</p>
                    </div>
                </div>

                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Transactions récentes</h2>
                        <button class="btn btn-primary btn-sm">Exporter rapport</button>
                    </div>
                    <div class="section-content">
                        <div id="payments-table">
                            <div class="loading"></div> Chargement des transactions...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Analyses et rapports</h1>
                        <p class="page-description">Statistiques détaillées de la plateforme</p>
                    </div>
                </div>

                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Croissance des utilisateurs</h2>
                    </div>
                    <div class="section-content">
                        <div id="user-growth-chart" class="chart-container">
                            <div class="loading"></div> Chargement du graphique...
                        </div>
                    </div>
                </div>

                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Statistiques régionales</h2>
                    </div>
                    <div class="section-content">
                        <div id="regional-stats">
                            <div class="loading"></div> Chargement des statistiques...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Free Modules Section -->
            <div id="free-modules-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Modules gratuits</h1>
                        <p class="page-description">Gestion du contenu gratuit accessible sans abonnement</p>
                    </div>
                </div>

                <!-- Free modules settings -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Paramètres des modules gratuits</h2>
                        <button class="btn btn-primary btn-sm" onclick="saveFreeModuleSettings()">Sauvegarder paramètres</button>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Max leçons gratuites par matière</label>
                                <input type="number" id="maxFreeLessons" value="2" min="0" max="10" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Max quiz gratuits par matière</label>
                                <input type="number" id="maxFreeQuizzes" value="1" min="0" max="5" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Durée max par leçon (min)</label>
                                <input type="number" id="durationLimit" value="30" min="5" max="120" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div style="display: flex; align-items: center;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="allowProgressTracking" checked style="margin-right: 0.5rem;">
                                    Suivi de progression autorisé
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Free modules list -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Modules gratuits disponibles</h2>
                        <button class="btn btn-primary btn-sm">Ajouter module</button>
                    </div>
                    <div class="section-content">
                        <div id="free-modules-table">
                            <div class="loading"></div> Chargement des modules gratuits...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trial Management Section -->
            <div id="trial-management-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Gestion des périodes d'essai</h1>
                        <p class="page-description">Modifier les périodes d'essai des familles individuellement</p>
                    </div>
                </div>

                <!-- Quick trial extension -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Extension rapide d'essai</h2>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 1rem; align-items: end;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ID Famille</label>
                                <input type="text" id="familyId" placeholder="ex: 1, 2, 3..." style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Nouveaux jours d'essai</label>
                                <input type="number" id="newTrialDays" value="14" min="1" max="90" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Raison de l'extension</label>
                                <input type="text" id="trialReason" placeholder="ex: Support technique, famille nombreuse..." style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <button class="btn btn-primary glass-btn glass-btn-primary" onclick="extendTrial()" style="padding: 0.6rem 1rem;">Étendre essai</button>
                        </div>
                        <div id="trial-extension-result" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                </div>

                <!-- Trial extensions history -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Historique des extensions</h2>
                        <button class="btn btn-secondary btn-sm">Exporter rapport</button>
                    </div>
                    <div class="section-content">
                        <div id="trial-history-table">
                            <div class="loading"></div> Chargement de l'historique...
                        </div>
                    </div>
                </div>

                <!-- Trial statistics -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Statistiques des essais</h2>
                    </div>
                    <div class="section-content">
                        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                            <div class="stat-card glass-stat-card primary">
                                <div class="stat-header">
                                    <span class="stat-title">Extensions totales</span>
                                    <span class="stat-icon">📈</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="total-extensions">-</div>
                                <div class="stat-change positive">Ce mois</div>
                            </div>
                            <div class="stat-card glass-stat-card secondary">
                                <div class="stat-header">
                                    <span class="stat-title">Durée moyenne</span>
                                    <span class="stat-icon">⏱️</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="avg-extension-days">-</div>
                                <div class="stat-change">jours</div>
                            </div>
                            <div class="stat-card glass-stat-card warning">
                                <div class="stat-header">
                                    <span class="stat-title">Extensions actives</span>
                                    <span class="stat-icon">🔄</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="active-extensions">-</div>
                                <div class="stat-change">En cours</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Roles Management Section -->
            <div id="roles-management-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Gestion des rôles et permissions</h1>
                        <p class="page-description">Configuration des profils utilisateurs et leurs autorisations</p>
                    </div>
                </div>

                <!-- Roles Overview -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card glass-stat-card primary">
                        <div class="stat-header">
                            <span class="stat-title">Administrateurs</span>
                            <span class="stat-icon">👑</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="admin-count">-</div>
                        <div class="stat-change">Accès complet</div>
                    </div>
                    <div class="stat-card glass-stat-card secondary">
                        <div class="stat-header">
                            <span class="stat-title">Enseignants</span>
                            <span class="stat-icon">👨‍🏫</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="teacher-count">-</div>
                        <div class="stat-change">Contenu pédagogique</div>
                    </div>
                    <div class="stat-card glass-stat-card warning">
                        <div class="stat-header">
                            <span class="stat-title">Modérateurs</span>
                            <span class="stat-icon">🛡️</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="moderator-count">-</div>
                        <div class="stat-change">Modération</div>
                    </div>
                    <div class="stat-card glass-stat-card danger">
                        <div class="stat-header">
                            <span class="stat-title">Validateurs</span>
                            <span class="stat-icon">✅</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="validator-count">-</div>
                        <div class="stat-change">Validation contenu</div>
                    </div>
                </div>

                <!-- Role Creation -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Créer un nouveau rôle</h2>
                        <button class="btn btn-primary glass-btn glass-btn-primary" onclick="createNewRole()">+ Nouveau rôle</button>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 1.5rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Nom du rôle</label>
                                <input type="text" id="roleName" placeholder="Ex: Superviseur régional" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Niveau hiérarchique</label>
                                <select id="roleLevel" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="1">1 - Super Admin</option>
                                    <option value="2">2 - Admin régional</option>
                                    <option value="3">3 - Coordinateur</option>
                                    <option value="4">4 - Enseignant senior</option>
                                    <option value="5">5 - Enseignant</option>
                                    <option value="6">6 - Assistant</option>
                                    <option value="7">7 - Stagiaire</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Description</label>
                                <input type="text" id="roleDescription" placeholder="Description des responsabilités" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <!-- Permissions Grid -->
                        <div style="margin-top: 1.5rem;">
                            <h4 style="margin-bottom: 1rem; color: #1F2937;">Permissions</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div style="border: 1px solid #E5E7EB; border-radius: 6px; padding: 1rem;">
                                    <h5 style="margin-bottom: 0.5rem; color: #374151;">👥 Gestion utilisateurs</h5>
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                        <label><input type="checkbox" id="perm-users-read"> Consulter</label>
                                        <label><input type="checkbox" id="perm-users-create"> Créer</label>
                                        <label><input type="checkbox" id="perm-users-edit"> Modifier</label>
                                        <label><input type="checkbox" id="perm-users-delete"> Supprimer</label>
                                    </div>
                                </div>
                                <div style="border: 1px solid #E5E7EB; border-radius: 6px; padding: 1rem;">
                                    <h5 style="margin-bottom: 0.5rem; color: #374151;">📚 Contenu pédagogique</h5>
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                        <label><input type="checkbox" id="perm-content-read"> Consulter</label>
                                        <label><input type="checkbox" id="perm-content-create"> Créer</label>
                                        <label><input type="checkbox" id="perm-content-edit"> Modifier</label>
                                        <label><input type="checkbox" id="perm-content-validate"> Valider</label>
                                    </div>
                                </div>
                                <div style="border: 1px solid #E5E7EB; border-radius: 6px; padding: 1rem;">
                                    <h5 style="margin-bottom: 0.5rem; color: #374151;">💰 Finances</h5>
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                        <label><input type="checkbox" id="perm-finance-read"> Consulter</label>
                                        <label><input type="checkbox" id="perm-finance-manage"> Gérer paiements</label>
                                        <label><input type="checkbox" id="perm-finance-reports"> Rapports</label>
                                        <label><input type="checkbox" id="perm-finance-admin"> Admin finances</label>
                                    </div>
                                </div>
                                <div style="border: 1px solid #E5E7EB; border-radius: 6px; padding: 1rem;">
                                    <h5 style="margin-bottom: 0.5rem; color: #374151;">⚙️ Système</h5>
                                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                        <label><input type="checkbox" id="perm-system-read"> Monitoring</label>
                                        <label><input type="checkbox" id="perm-system-backup"> Sauvegardes</label>
                                        <label><input type="checkbox" id="perm-system-config"> Configuration</label>
                                        <label><input type="checkbox" id="perm-system-admin"> Admin système</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem;">
                            <button class="btn btn-primary glass-btn glass-btn-primary" onclick="saveRole()">💾 Sauvegarder le rôle</button>
                            <button class="btn btn-secondary glass-btn" onclick="resetRoleForm()">🔄 Réinitialiser</button>
                        </div>
                        <div id="role-creation-result" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                </div>

                <!-- Existing Roles -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Rôles configurés</h2>
                        <button class="btn btn-secondary btn-sm">Exporter config</button>
                    </div>
                    <div class="section-content">
                        <div id="roles-table">
                            <div class="loading"></div> Chargement des rôles...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Staff Management Section -->
            <div id="staff-management-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Équipe pédagogique</h1>
                        <p class="page-description">Gestion du personnel enseignant et administratif</p>
                    </div>
                </div>

                <!-- Staff Overview -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card glass-stat-card primary">
                        <div class="stat-header">
                            <span class="stat-title">Personnel total</span>
                            <span class="stat-icon">👥</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="total-staff">-</div>
                        <div class="stat-change positive">+3 ce mois</div>
                    </div>
                    <div class="stat-card glass-stat-card secondary">
                        <div class="stat-header">
                            <span class="stat-title">Actifs aujourd'hui</span>
                            <span class="stat-icon">🟢</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="active-staff-today">-</div>
                        <div class="stat-change">en ligne</div>
                    </div>
                    <div class="stat-card glass-stat-card warning">
                        <div class="stat-header">
                            <span class="stat-title">En formation</span>
                            <span class="stat-icon">📖</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="staff-in-training">-</div>
                        <div class="stat-change">cette semaine</div>
                    </div>
                    <div class="stat-card glass-stat-card danger">
                        <div class="stat-header">
                            <span class="stat-title">Évaluations en cours</span>
                            <span class="stat-icon">📊</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="staff-evaluations">-</div>
                        <div class="stat-change">à compléter</div>
                    </div>
                </div>

                <!-- Add New Staff Member -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Ajouter un membre de l'équipe</h2>
                        <button class="btn btn-success btn-sm" onclick="addTeamMember()">➕ Ajouter membre</button>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Prénom</label>
                                <input type="text" id="staffFirstName" placeholder="Jean" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Nom</label>
                                <input type="text" id="staffLastName" placeholder="Mballa" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                                <input type="email" id="staffEmail" placeholder="jean.mballa@claudyne.com" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Téléphone</label>
                                <input type="tel" id="staffPhone" placeholder="+237 6XX XX XX XX" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Rôle principal</label>
                                <select id="staffRole" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="admin">👑 Administrateur</option>
                                    <option value="teacher">👨‍🏫 Enseignant</option>
                                    <option value="moderator">🛡️ Modérateur</option>
                                    <option value="validator">✅ Validateur</option>
                                    <option value="support">🎧 Support</option>
                                    <option value="analyst">📊 Analyste</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Région</label>
                                <select id="staffRegion" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="centre">Centre</option>
                                    <option value="littoral">Littoral</option>
                                    <option value="ouest">Ouest</option>
                                    <option value="nord-ouest">Nord-Ouest</option>
                                    <option value="sud-ouest">Sud-Ouest</option>
                                    <option value="adamaoua">Adamaoua</option>
                                    <option value="est">Est</option>
                                    <option value="nord">Nord</option>
                                    <option value="extreme-nord">Extrême-Nord</option>
                                    <option value="sud">Sud</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Spécialité</label>
                                <select id="staffSpeciality" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="mathematics">Mathématiques</option>
                                    <option value="french">Français</option>
                                    <option value="english">Anglais</option>
                                    <option value="sciences">Sciences</option>
                                    <option value="history">Histoire-Géographie</option>
                                    <option value="technology">Technologies</option>
                                    <option value="management">Gestion</option>
                                    <option value="support">Support technique</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Date d'embauche</label>
                                <input type="date" id="staffHireDate" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Notes biographiques</label>
                            <textarea id="staffBio" placeholder="Formation, expérience, compétences particulières..." style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px; resize: vertical;" rows="3"></textarea>
                        </div>

                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button class="btn btn-primary glass-btn glass-btn-primary" onclick="addStaffMember()">👤 Ajouter membre</button>
                            <button class="btn btn-secondary glass-btn" onclick="importStaffCSV()">📥 Importer CSV</button>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="sendWelcomeEmail" checked style="margin-right: 0.5rem;">
                                Envoyer email de bienvenue
                            </label>
                        </div>
                        <div id="staff-addition-result" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                </div>

                <!-- Staff Directory -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Annuaire du personnel</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="staffFilter" style="padding: 0.375rem 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 0.75rem;">
                                <option value="all">Tous les rôles</option>
                                <option value="admin">Administrateurs</option>
                                <option value="teacher">Enseignants</option>
                                <option value="moderator">Modérateurs</option>
                                <option value="validator">Validateurs</option>
                            </select>
                            <button class="btn btn-secondary btn-sm" onclick="exportStaffDirectory()">📤 Exporter annuaire</button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="staff-directory-table">
                            <div class="loading"></div> Chargement de l'annuaire...
                        </div>
                    </div>
                </div>

                <!-- Performance Dashboard -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Tableau de performance de l'équipe</h2>
                    </div>
                    <div class="section-content">
                        <div id="staff-performance-chart" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div class="loading"></div> Chargement des performances...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Communication Section -->
            <div id="communication-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Communication</h1>
                        <p class="page-description">Envoi de notifications et messages aux abonnés</p>
                    </div>
                </div>

                <!-- Quick Message -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Message rapide</h2>
                        <button class="btn btn-primary btn-sm" onclick="sendQuickMessage()">📩 Envoyer message</button>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Destinataires</label>
                                <select id="messageRecipients" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="all">Tous les abonnés</option>
                                    <option value="active">Abonnés actifs</option>
                                    <option value="trial">Abonnés en essai</option>
                                    <option value="expired">Essais expirés</option>
                                    <option value="family">Comptes familiaux</option>
                                    <option value="individual">Comptes individuels</option>
                                    <option value="custom">Sélection personnalisée</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Canal d'envoi</label>
                                <select id="messageChannel" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="email">📬 Email</option>
                                    <option value="sms">📱 SMS</option>
                                    <option value="popup">📢 Pop-up (App)</option>
                                    <option value="all_channels">🚀 Tous les canaux</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Type de message</label>
                                <select id="messageType" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="info">Information</option>
                                    <option value="promotion">Promotion</option>
                                    <option value="reminder">Rappel</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="urgent">⚠️ Urgent</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Objet</label>
                            <input type="text" id="messageSubject" placeholder="Ex: Nouvelle fonctionnalité disponible" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Message</label>
                            <textarea id="messageContent" rows="4" placeholder="Rédigez votre message ici..." style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button class="btn btn-primary glass-btn glass-btn-primary" onclick="sendMessage()">📧 Envoyer message</button>
                            <button class="btn btn-secondary glass-btn" onclick="previewMessage()">👁️ Aperçu</button>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="scheduleMessage" style="margin-right: 0.5rem;">
                                Programmer l'envoi
                            </label>
                        </div>
                        <div id="message-result" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                </div>

                <!-- Message History -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Historique des messages</h2>
                        <button class="btn btn-secondary btn-sm">Voir tout</button>
                    </div>
                    <div class="section-content">
                        <div id="message-history-table">
                            <div class="loading"></div> Chargement de l'historique...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Templates Section -->
            <div id="email-templates-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">📧 Gestion des Templates Email</h1>
                        <p class="page-description">Interface futuriste pour créer et gérer vos templates d'emails</p>
                    </div>
                    <button class="btn-primary glass-btn" onclick="openTemplateModal()">
                        <i class="fas fa-plus"></i>
                        Nouveau Template
                    </button>
                </div>

                <!-- Glass Stats Cards -->
                <div class="stats-grid glass-grid">
                    <div class="stat-card glass-card">
                        <div class="stat-icon glass-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalTemplates">0</h3>
                            <p>Templates Actifs</p>
                        </div>
                        <div class="glass-accent"></div>
                    </div>

                    <div class="stat-card glass-card">
                        <div class="stat-icon glass-icon">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="emailsSent">0</h3>
                            <p>Emails Envoyés</p>
                        </div>
                        <div class="glass-accent"></div>
                    </div>

                    <div class="stat-card glass-card">
                        <div class="stat-icon glass-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="successRate">98%</h3>
                            <p>Taux de Succès</p>
                        </div>
                        <div class="glass-accent"></div>
                    </div>

                    <div class="stat-card glass-card">
                        <div class="stat-icon glass-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="lastUpdate">Maintenant</h3>
                            <p>Dernière MAJ</p>
                        </div>
                        <div class="glass-accent"></div>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div class="filter-controls glass-panel">
                    <div class="filter-group">
                        <label>Catégorie</label>
                        <select id="categoryFilter" class="glass-select">
                            <option value="">Toutes les catégories</option>
                            <option value="authentication">Authentification</option>
                            <option value="notification">Notification</option>
                            <option value="battle">Battle Royale</option>
                            <option value="system">Système</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Statut</label>
                        <select id="statusFilter" class="glass-select">
                            <option value="">Tous les statuts</option>
                            <option value="active">Actif</option>
                            <option value="draft">Brouillon</option>
                            <option value="archived">Archivé</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Recherche</label>
                        <input type="text" id="searchFilter" class="glass-input" placeholder="Rechercher un template...">
                    </div>

                    <button class="btn-secondary glass-btn" onclick="resetFilters()">
                        <i class="fas fa-undo"></i>
                        Reset
                    </button>
                </div>

                <!-- Templates Grid -->
                <div class="templates-grid" id="templatesGrid">
                    <!-- Templates will be loaded here -->
                </div>

                <!-- Loading State -->
                <div id="templateLoading" class="loading-state glass-card">
                    <div class="loading-spinner"></div>
                    <p>Chargement des templates...</p>
                </div>

                <!-- Empty State -->
                <div id="templateEmpty" class="empty-state glass-card hidden">
                    <i class="fas fa-envelope-open-text"></i>
                    <h3>Aucun template trouvé</h3>
                    <p>Créez votre premier template email pour commencer</p>
                    <button class="btn-primary glass-btn" onclick="openTemplateModal()">
                        Créer un Template
                    </button>
                </div>
            </div>

            <!-- Template Modal -->
            <div id="templateModal" class="modal glass-modal">
                <div class="modal-content glass-modal-content">
                    <div class="modal-header">
                        <h2 id="modalTitle">Nouveau Template Email</h2>
                        <button class="close-btn" onclick="closeTemplateModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="modal-tabs">
                        <button class="tab-btn active" onclick="switchTab('editor')">
                            <i class="fas fa-edit"></i>
                            Éditeur
                        </button>
                        <button class="tab-btn" onclick="switchTab('preview')">
                            <i class="fas fa-eye"></i>
                            Aperçu
                        </button>
                        <button class="tab-btn" onclick="switchTab('settings')">
                            <i class="fas fa-cog"></i>
                            Paramètres
                        </button>
                    </div>

                    <!-- Editor Tab -->
                    <div id="editorTab" class="tab-content active">
                        <form id="templateForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="templateName">Nom du Template</label>
                                    <input type="text" id="templateName" class="glass-input" required>
                                </div>

                                <div class="form-group">
                                    <label for="templateCategory">Catégorie</label>
                                    <select id="templateCategory" class="glass-select" required>
                                        <option value="">Sélectionner une catégorie</option>
                                        <option value="authentication">Authentification</option>
                                        <option value="notification">Notification</option>
                                        <option value="battle">Battle Royale</option>
                                        <option value="system">Système</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="templateSubject">Sujet de l'Email</label>
                                <input type="text" id="templateSubject" class="glass-input" required>
                            </div>

                            <div class="form-group">
                                <label for="templateContent">Contenu Email</label>
                                <div class="editor-toolbar">
                                    <div class="toolbar-section">
                                        <label style="margin-right: 10px; font-weight: 600;">Mode:</label>
                                        <button type="button" class="toolbar-btn mode-btn active" onclick="switchEditorMode('html')" id="htmlModeBtn">
                                            <i class="fas fa-code"></i> HTML
                                        </button>
                                        <button type="button" class="toolbar-btn mode-btn" onclick="switchEditorMode('visual')" id="visualModeBtn">
                                            <i class="fas fa-eye"></i> Visuel
                                        </button>
                                    </div>
                                    <div class="toolbar-section">
                                        <button type="button" class="toolbar-btn" onclick="insertVariable('{{userName}}')">
                                            <i class="fas fa-user"></i> Nom Utilisateur
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="insertVariable('{{email}}')">
                                            <i class="fas fa-envelope"></i> Email
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="insertVariable('{{resetLink}}')">
                                            <i class="fas fa-link"></i> Lien Reset
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="insertVariable('{{verificationCode}}')">
                                            <i class="fas fa-key"></i> Code Vérification
                                        </button>
                                    </div>
                                    <div class="toolbar-section" id="visualToolbar" style="display: none;">
                                        <button type="button" class="toolbar-btn" onclick="formatText('bold')">
                                            <i class="fas fa-bold"></i> Gras
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="formatText('italic')">
                                            <i class="fas fa-italic"></i> Italique
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="formatText('insertHTML', '<strong>')">
                                            <i class="fas fa-plus"></i> Titre
                                        </button>
                                        <button type="button" class="toolbar-btn" onclick="insertLink()">
                                            <i class="fas fa-link"></i> Lien
                                        </button>
                                    </div>
                                </div>
                                <textarea id="templateContent" class="glass-textarea" rows="15" required style="display: block;"></textarea>
                                <div id="visualEditor" class="glass-textarea visual-editor" contenteditable="true" style="display: none; min-height: 400px; padding: 1rem; border: 1px solid #D1D5DB; border-radius: 6px; background: white; color: #1f2937; overflow-y: auto;"></div>
                            </div>

                            <div class="form-group">
                                <label for="templateVariables">Variables Disponibles</label>
                                <input type="text" id="templateVariables" class="glass-input" placeholder="userName,email,resetLink,verificationCode">
                                <small>Variables séparées par des virgules</small>
                            </div>
                        </form>
                    </div>

                    <!-- Preview Tab -->
                    <div id="previewTab" class="tab-content">
                        <div class="preview-container glass-card">
                            <div class="preview-header">
                                <h3>Aperçu Email</h3>
                                <button class="btn-secondary" onclick="refreshPreview()">
                                    <i class="fas fa-sync"></i>
                                    Actualiser
                                </button>
                            </div>
                            <div class="email-preview" id="emailPreview">
                                <div class="email-subject">
                                    <strong>Sujet:</strong> <span id="previewSubject">Sujet de l'email</span>
                                </div>
                                <div class="email-content" id="previewContent">
                                    Contenu de l'email apparaîtra ici...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div id="settingsTab" class="tab-content">
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="templateStatus">Statut</label>
                                <select id="templateStatus" class="glass-select">
                                    <option value="active">Actif</option>
                                    <option value="draft">Brouillon</option>
                                    <option value="archived">Archivé</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="templateVersion">Version</label>
                                <input type="number" id="templateVersion" class="glass-input" value="1" min="1">
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="isDefault"> Template par défaut
                                </label>
                            </div>

                            <div class="form-group">
                                <label for="templateDescription">Description</label>
                                <textarea id="templateDescription" class="glass-textarea" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-secondary glass-btn" onclick="closeTemplateModal()">
                            Annuler
                        </button>
                        <button type="button" class="btn-secondary glass-btn" onclick="saveAsDraft()">
                            <i class="fas fa-save"></i>
                            Sauvegarder Brouillon
                        </button>
                        <button type="button" class="btn-primary glass-btn" onclick="saveTemplate()">
                            <i class="fas fa-check"></i>
                            Enregistrer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Email Automation Section -->
            <div id="email-automation-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">🤖 Automatisation des Emails</h1>
                        <p class="page-description">Configuration des emails automatiques et déclencheurs</p>
                    </div>
                    <button class="btn-primary glass-btn" onclick="openAutomationModal()">
                        <i class="fas fa-plus"></i>
                        Nouveau Déclencheur
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid glass-grid">
                    <div class="stat-card glass-card">
                        <div class="stat-icon glass-icon">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="activeAutomations">5</h3>
                            <p>Automatisations Actives</p>
                        </div>
                        <div class="glass-accent"></div>
                    </div>

                    <div class="stat-card glass-card">
                        <div class="stat-icon glass-icon">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="emailsSentToday">127</h3>
                            <p>Emails Envoyés Aujourd'hui</p>
                        </div>
                        <div class="glass-accent"></div>
                    </div>

                    <div class="stat-card glass-card">
                        <div class="stat-icon glass-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="emailsInQueue">23</h3>
                            <p>En Attente</p>
                        </div>
                        <div class="glass-accent"></div>
                    </div>

                    <div class="stat-card glass-card">
                        <div class="stat-icon glass-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="deliveryRate">98%</h3>
                            <p>Taux de Livraison</p>
                        </div>
                        <div class="glass-accent"></div>
                    </div>
                </div>

                <!-- Email Triggers Configuration -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">🎯 Déclencheurs d'Emails</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary btn-sm" onclick="openAutomationModal()">➕ Nouveau Déclencheur</button>
                            <button class="btn btn-success btn-sm" onclick="saveAutomationConfiguration()">💾 Sauvegarder Config</button>
                            <button class="btn btn-secondary btn-sm" onclick="testAllTriggers()">🧪 Tester Tous</button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="triggersGrid" class="triggers-grid">
                            <!-- Triggers will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Email Queue Management -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">📬 File d'Attente des Emails</h2>
                        <div class="queue-controls">
                            <button class="btn btn-success btn-sm" onclick="processEmailQueue()">▶️ Traiter File</button>
                            <button class="btn btn-warning btn-sm" onclick="pauseEmailQueue()">⏸️ Pause</button>
                            <button class="btn btn-danger btn-sm" onclick="clearEmailQueue()">🗑️ Vider</button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="emailQueueTable">
                            <div class="loading">Chargement de la file d'attente...</div>
                        </div>
                    </div>
                </div>

                <!-- Email Analytics -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">📊 Statistiques des Emails</h2>
                        <select id="analyticsTimeframe" class="glass-select" onchange="updateEmailAnalytics()">
                            <option value="24h">Dernières 24h</option>
                            <option value="7d" selected>7 derniers jours</option>
                            <option value="30d">30 derniers jours</option>
                            <option value="90d">3 derniers mois</option>
                        </select>
                    </div>
                    <div class="section-content">
                        <div id="emailAnalyticsChart" style="height: 300px;">
                            <div class="loading">Chargement des statistiques...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Rapports détaillés</h1>
                        <p class="page-description">Génération de rapports personnalisés</p>
                    </div>
                </div>

                <!-- Report Generator -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Générateur de rapports</h2>
                        <button class="btn btn-primary btn-sm" onclick="generateReport()">📊 Générer rapport</button>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Type de rapport</label>
                                <select id="reportType" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="users">Rapport utilisateurs</option>
                                    <option value="revenue">Rapport revenus</option>
                                    <option value="content">Rapport contenu</option>
                                    <option value="engagement">Rapport engagement</option>
                                    <option value="regional">Rapport régional</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Période</label>
                                <select id="reportPeriod" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="week">7 derniers jours</option>
                                    <option value="month">30 derniers jours</option>
                                    <option value="quarter">90 derniers jours</option>
                                    <option value="year">12 derniers mois</option>
                                    <option value="custom">Période personnalisée</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Format</label>
                                <select id="reportFormat" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="pdf">PDF</option>
                                    <option value="excel">Excel</option>
                                    <option value="csv">CSV</option>
                                    <option value="json">JSON</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: end;">
                                <button class="btn btn-primary glass-btn glass-btn-primary" onclick="generateReport()" style="width: 100%;">📊 Générer rapport</button>
                            </div>
                        </div>
                        <div id="report-result" style="margin-top: 1rem; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                    </div>
                </div>

                <!-- Scheduled Reports -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Rapports programmés</h2>
                        <button class="btn btn-primary btn-sm" onclick="scheduleNewReport()">+ Nouveau</button>
                    </div>
                    <div class="section-content">
                        <div id="scheduled-reports-table">
                            <div class="loading"></div> Chargement des rapports programmés...
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Monitoring Section -->
            <div id="system-monitoring-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Monitoring système</h1>
                        <p class="page-description">Surveillance de la performance et santé du système</p>
                    </div>
                </div>

                <!-- System Health -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card glass-stat-card primary">
                        <div class="stat-header">
                            <span class="stat-title">Statut serveur</span>
                            <span class="stat-icon" id="server-status">🟢</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="uptime-display">-</div>
                        <div class="stat-change">Uptime</div>
                    </div>
                    <div class="stat-card glass-stat-card secondary">
                        <div class="stat-header">
                            <span class="stat-title">Utilisation CPU</span>
                            <span class="stat-icon">⚡</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="cpu-usage">-</div>
                        <div class="stat-change">%</div>
                    </div>
                    <div class="stat-card glass-stat-card warning">
                        <div class="stat-header">
                            <span class="stat-title">Mémoire RAM</span>
                            <span class="stat-icon">💾</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="memory-usage">-</div>
                        <div class="stat-change">MB utilisés</div>
                    </div>
                    <div class="stat-card glass-stat-card danger">
                        <div class="stat-header">
                            <span class="stat-title">Erreurs (24h)</span>
                            <span class="stat-icon">⚠️</span>
                        </div>
                        <div class="stat-value glass-stat-value" id="error-count">-</div>
                        <div class="stat-change">incidents</div>
                    </div>
                </div>

                <!-- System Logs -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Logs système récents</h2>
                        <button class="btn btn-secondary btn-sm" onclick="refreshLogs()">🔄 Actualiser</button>
                    </div>
                    <div class="section-content">
                        <div id="system-logs" style="background: #1F2937; color: #F3F4F6; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.875rem; max-height: 400px; overflow-y: auto;">
                            <div class="loading" style="color: #F3F4F6;"></div> Chargement des logs...
                        </div>
                    </div>
                </div>

                <!-- Security Status -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Statut de sécurité</h2>
                        <button class="btn btn-secondary btn-sm" onclick="refreshSecurityStatus()">🔄 Actualiser</button>
                    </div>
                    <div class="section-content">
                        <div class="stats-grid" style="margin-bottom: 1rem;">
                            <div class="stat-card glass-stat-card primary">
                                <div class="stat-header">
                                    <span class="stat-title">Fail2ban</span>
                                    <span class="stat-icon" id="fail2ban-status">🛡️</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="banned-ips">-</div>
                                <div class="stat-change">IPs bannies</div>
                            </div>
                            <div class="stat-card glass-stat-card warning">
                                <div class="stat-header">
                                    <span class="stat-title">SSH Attacks</span>
                                    <span class="stat-icon">🚫</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="ssh-attacks">-</div>
                                <div class="stat-change">dernières 24h</div>
                            </div>
                            <div class="stat-card glass-stat-card secondary">
                                <div class="stat-header">
                                    <span class="stat-title">SSL Status</span>
                                    <span class="stat-icon">🔐</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="ssl-expiry">-</div>
                                <div class="stat-change">jours restants</div>
                            </div>
                            <div class="stat-card glass-stat-card success">
                                <div class="stat-header">
                                    <span class="stat-title">Firewall</span>
                                    <span class="stat-icon" id="firewall-status">🔥</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="firewall-rules">-</div>
                                <div class="stat-change">règles actives</div>
                            </div>
                        </div>
                        <div id="security-details" style="background: #1F2937; color: #F3F4F6; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.875rem;">
                            <div class="loading" style="color: #F3F4F6;"></div> Chargement statut sécurité...
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Métriques de performance</h2>
                        <div class="filter-group">
                            <select id="metricsTimeRange" onchange="refreshPerformanceMetrics()">
                                <option value="1h">Dernière heure</option>
                                <option value="24h" selected>Dernières 24h</option>
                                <option value="7d">7 derniers jours</option>
                            </select>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="stats-grid" style="margin-bottom: 1rem;">
                            <div class="stat-card glass-stat-card info">
                                <div class="stat-header">
                                    <span class="stat-title">Requêtes Web</span>
                                    <span class="stat-icon">🌐</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="web-requests">-</div>
                                <div class="stat-change">total</div>
                            </div>
                            <div class="stat-card glass-stat-card primary">
                                <div class="stat-header">
                                    <span class="stat-title">Visiteurs uniques</span>
                                    <span class="stat-icon">👥</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="unique-visitors">-</div>
                                <div class="stat-change">IPs distinctes</div>
                            </div>
                            <div class="stat-card glass-stat-card secondary">
                                <div class="stat-header">
                                    <span class="stat-title">Temps réponse moy.</span>
                                    <span class="stat-icon">⏱️</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="avg-response-time">-</div>
                                <div class="stat-change">secondes</div>
                            </div>
                            <div class="stat-card glass-stat-card warning">
                                <div class="stat-header">
                                    <span class="stat-title">Erreurs HTTP</span>
                                    <span class="stat-icon">❌</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="http-errors">-</div>
                                <div class="stat-change">4xx/5xx</div>
                            </div>
                        </div>
                        <div id="performance-chart" style="background: #1F2937; color: #F3F4F6; padding: 1rem; border-radius: 6px; min-height: 200px;">
                            <div class="loading" style="color: #F3F4F6;"></div> Chargement métriques...
                        </div>
                    </div>
                </div>

                <!-- Backup Status -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">État des sauvegardes</h2>
                        <button class="btn btn-primary btn-sm" onclick="triggerBackup()">💾 Forcer sauvegarde</button>
                    </div>
                    <div class="section-content">
                        <div id="backup-status-table">
                            <div class="loading"></div> Chargement de l'état des sauvegardes...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pricing Plans Section -->
            <div id="pricing-plans-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Gestion des plans tarifaires</h1>
                        <p class="page-description">Créer et gérer les formules d'abonnement</p>
                    </div>
                    <button class="btn btn-primary glass-btn glass-btn-primary" onclick="showCreatePlanModal()">
                        ➕ Nouveau Plan
                    </button>
                </div>

                <!-- Current Plans -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Plans actuels</h2>
                        <div class="filter-group">
                            <select id="planTypeFilter" onchange="filterPlans()">
                                <option value="">Tous les types</option>
                                <option value="individual">Individuel</option>
                                <option value="family">Familial</option>
                            </select>
                            <select id="planStatusFilter" onchange="filterPlans()">
                                <option value="">Tous les statuts</option>
                                <option value="active">Actif</option>
                                <option value="inactive">Inactif</option>
                            </select>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="pricing-plans-grid" class="plans-grid">
                            <div class="loading"></div> Chargement des plans...
                        </div>
                    </div>
                </div>

                <!-- Plan Statistics -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Statistiques des abonnements</h2>
                    </div>
                    <div class="section-content">
                        <div class="stats-grid">
                            <div class="stat-card glass-stat-card">
                                <div class="stat-header">
                                    <span class="stat-title">Plans Actifs</span>
                                    <span class="stat-icon">✅</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="active-plans-count">-</div>
                            </div>
                            <div class="stat-card glass-stat-card">
                                <div class="stat-header">
                                    <span class="stat-title">Revenus Mensuels</span>
                                    <span class="stat-icon">💰</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="monthly-revenue-plans">-</div>
                            </div>
                            <div class="stat-card glass-stat-card">
                                <div class="stat-header">
                                    <span class="stat-title">Abonnés Total</span>
                                    <span class="stat-icon">👥</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="total-subscribers">-</div>
                            </div>
                            <div class="stat-card glass-stat-card">
                                <div class="stat-header">
                                    <span class="stat-title">Plan Populaire</span>
                                    <span class="stat-icon">⭐</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="popular-plan">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscriptions Management Section -->
            <div id="subscriptions-management-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">📊 Gestion des Abonnements</h1>
                        <p class="page-description">Suivi et gestion des abonnements utilisateurs</p>
                    </div>
                    <button class="btn btn-primary glass-btn glass-btn-primary" onclick="refreshSubscriptionStats()">
                        🔄 Actualiser
                    </button>
                </div>

                <!-- Statistics Cards -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">📈 Statistiques Globales</h2>
                    </div>
                    <div class="section-content">
                        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                            <div class="stat-card glass-stat-card" style="background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; border: none;">
                                <div class="stat-header">
                                    <span class="stat-title" style="color: white;">Utilisateurs Total</span>
                                    <span class="stat-icon">👥</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="sub-total-users" style="color: white;">-</div>
                                <div class="stat-footer" style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 0.5rem;">Tous comptes</div>
                            </div>

                            <div class="stat-card glass-stat-card" style="background: linear-gradient(135deg, #10B981, #059669); color: white; border: none;">
                                <div class="stat-header">
                                    <span class="stat-title" style="color: white;">Essais Actifs</span>
                                    <span class="stat-icon">🎯</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="sub-active-trials" style="color: white;">-</div>
                                <div class="stat-footer" style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 0.5rem;">TRIAL (7 jours)</div>
                            </div>

                            <div class="stat-card glass-stat-card" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none;">
                                <div class="stat-header">
                                    <span class="stat-title" style="color: white;">Abonnements Actifs</span>
                                    <span class="stat-icon">✅</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="sub-active-subscriptions" style="color: white;">-</div>
                                <div class="stat-footer" style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 0.5rem;">ACTIVE (payant)</div>
                            </div>

                            <div class="stat-card glass-stat-card" style="background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none;">
                                <div class="stat-header">
                                    <span class="stat-title" style="color: white;">Suspendus</span>
                                    <span class="stat-icon">⏸️</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="sub-suspended" style="color: white;">-</div>
                                <div class="stat-footer" style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 0.5rem;">En attente paiement</div>
                            </div>

                            <div class="stat-card glass-stat-card" style="background: linear-gradient(135deg, #EF4444, #DC2626); color: white; border: none;">
                                <div class="stat-header">
                                    <span class="stat-title" style="color: white;">Expirés</span>
                                    <span class="stat-icon">❌</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="sub-expired" style="color: white;">-</div>
                                <div class="stat-footer" style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 0.5rem;">Abonnement terminé</div>
                            </div>

                            <div class="stat-card glass-stat-card" style="background: linear-gradient(135deg, #06B6D4, #0891B2); color: white; border: none;">
                                <div class="stat-header">
                                    <span class="stat-title" style="color: white;">Revenus Actuels</span>
                                    <span class="stat-icon">💰</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="sub-current-revenue" style="color: white;">-</div>
                                <div class="stat-footer" style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 0.5rem;">FCFA / mois</div>
                            </div>

                            <div class="stat-card glass-stat-card" style="background: linear-gradient(135deg, #EC4899, #DB2777); color: white; border: none;">
                                <div class="stat-header">
                                    <span class="stat-title" style="color: white;">Revenus Attendus</span>
                                    <span class="stat-icon">📈</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="sub-expected-revenue" style="color: white;">-</div>
                                <div class="stat-footer" style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 0.5rem;">FCFA / mois</div>
                            </div>

                            <div class="stat-card glass-stat-card" style="background: linear-gradient(135deg, #6366F1, #4F46E5); color: white; border: none;">
                                <div class="stat-header">
                                    <span class="stat-title" style="color: white;">Expirations Proches</span>
                                    <span class="stat-icon">⚠️</span>
                                </div>
                                <div class="stat-value glass-stat-value" id="sub-expiring-soon" style="color: white;">-</div>
                                <div class="stat-footer" style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 0.5rem;">Dans 3 jours</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cron Jobs Management -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">⚙️ Tâches Automatiques (Cron Jobs)</h2>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                            <div style="padding: 1rem; border: 1px solid #E5E7EB; border-radius: 8px;">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">🔍 Vérifier Essais Expirés</h3>
                                <p style="font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">Suspend les comptes dont l'essai est terminé</p>
                                <button class="btn btn-sm glass-btn glass-btn-primary" onclick="runCronJob('checkExpiredTrials')" style="width: 100%;">
                                    Exécuter Maintenant
                                </button>
                            </div>

                            <div style="padding: 1rem; border: 1px solid #E5E7EB; border-radius: 8px;">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">⏰ Vérifier Abonnements Expirés</h3>
                                <p style="font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">Désactive les abonnements payants expirés</p>
                                <button class="btn btn-sm glass-btn glass-btn-primary" onclick="runCronJob('checkExpiredSubscriptions')" style="width: 100%;">
                                    Exécuter Maintenant
                                </button>
                            </div>

                            <div style="padding: 1rem; border: 1px solid #E5E7EB; border-radius: 8px;">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">🔄 Traiter Renouvellements</h3>
                                <p style="font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">Gère les renouvellements automatiques</p>
                                <button class="btn btn-sm glass-btn glass-btn-primary" onclick="runCronJob('processAutoRenewals')" style="width: 100%;">
                                    Exécuter Maintenant
                                </button>
                            </div>

                            <div style="padding: 1rem; border: 1px solid #E5E7EB; border-radius: 8px;">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">📧 Envoyer Rappels</h3>
                                <p style="font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">Envoie rappels 3 jours avant expiration</p>
                                <button class="btn btn-sm glass-btn glass-btn-primary" onclick="runCronJob('sendExpirationReminders')" style="width: 100%;">
                                    Exécuter Maintenant
                                </button>
                            </div>

                            <div style="padding: 1rem; border: 1px solid #E5E7EB; border-radius: 8px;">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">📊 Générer Rapport</h3>
                                <p style="font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">Crée un rapport quotidien complet</p>
                                <button class="btn btn-sm glass-btn glass-btn-primary" onclick="runCronJob('generateDailyReport')" style="width: 100%;">
                                    Exécuter Maintenant
                                </button>
                            </div>

                            <div style="padding: 1rem; border: 1px solid #E5E7EB; border-radius: 8px;">
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">🚀 Exécuter Tout</h3>
                                <p style="font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">Lance toutes les tâches quotidiennes</p>
                                <button class="btn btn-sm glass-btn" onclick="runCronJob('runDailyJobs')" style="width: 100%; background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white;">
                                    Exécuter Maintenant
                                </button>
                            </div>
                        </div>

                        <!-- Job Results -->
                        <div id="cron-job-results" style="margin-top: 1.5rem; padding: 1rem; background: #F9FAFB; border-radius: 8px; display: none;">
                            <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">Résultats</h3>
                            <pre id="cron-job-output" style="font-family: monospace; font-size: 0.875rem; white-space: pre-wrap; color: #1F2937;"></pre>
                        </div>
                    </div>
                </div>

                <!-- Users by Subscription Status -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">👥 Utilisateurs par Statut</h2>
                        <div class="filter-group">
                            <select id="subStatusFilter" onchange="filterSubscriptionUsers()" style="padding: 0.5rem; border: 1px solid #E5E7EB; border-radius: 6px;">
                                <option value="">Tous les statuts</option>
                                <option value="TRIAL">TRIAL (Essai)</option>
                                <option value="ACTIVE">ACTIVE (Actif)</option>
                                <option value="SUSPENDED">SUSPENDED (Suspendu)</option>
                                <option value="EXPIRED">EXPIRED (Expiré)</option>
                                <option value="CANCELLED">CANCELLED (Annulé)</option>
                            </select>
                            <select id="subPlanFilter" onchange="filterSubscriptionUsers()" style="padding: 0.5rem; border: 1px solid #E5E7EB; border-radius: 6px;">
                                <option value="">Tous les plans</option>
                                <option value="INDIVIDUAL_STUDENT">Étudiant (8000 FCFA)</option>
                                <option value="INDIVIDUAL_TEACHER">Enseignant (Gratuit)</option>
                                <option value="FAMILY_MANAGER">Famille (15000 FCFA)</option>
                            </select>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="subscription-users-table" style="overflow-x: auto;">
                            <table class="data-table" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #F3F4F6; border-bottom: 2px solid #E5E7EB;">
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Utilisateur</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Rôle</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Plan</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Statut</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Prix</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Expiration</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="subscription-users-tbody">
                                    <tr>
                                        <td colspan="7" style="padding: 2rem; text-align: center; color: #6B7280;">
                                            <div class="loading"></div> Chargement des utilisateurs...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <!-- Section Gestion des Données -->
            <div id="data-management-section" class="section hidden">
                <div class="section-header">
                    <h1 class="page-title">🔧 Gestion des Données Dynamiques</h1>
                    <p class="page-description">Contrôle et réinitialisation des données Claudyne</p>
                </div>

                <div class="dashboard-grid">
                    <!-- État des données -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>📊 État des Données</h3>
                        </div>
                        <div class="card-content">
                            <div id="dataStatusInfo" class="data-status-grid">
                                <!-- Rempli dynamiquement -->
                            </div>
                        </div>
                    </div>

                    <!-- Actions rapides -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>⚡ Actions Rapides</h3>
                        </div>
                        <div class="card-content">
                            <div class="button-grid">
                                <button class="btn-danger" onclick="resetAllDataAdmin()" style="background: linear-gradient(45deg, #FF4757, #FF3838); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 5px;">
                                    🔄 Reset Complet
                                </button>
                                <button class="btn-warning" onclick="resetCategoryAdmin('EMAIL_TEMPLATES')" style="background: linear-gradient(45deg, #FFA502, #FF7675); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 5px;">
                                    📧 Reset Templates
                                </button>
                                <button class="btn-warning" onclick="resetCategoryAdmin('EMAIL_AUTOMATIONS')" style="background: linear-gradient(45deg, #FFA502, #FF7675); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 5px;">
                                    🤖 Reset Automations
                                </button>
                                <button class="btn-warning" onclick="resetCategoryAdmin('DASHBOARD_STATS')" style="background: linear-gradient(45deg, #FFA502, #FF7675); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 5px;">
                                    📊 Reset Stats
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Sauvegarde/Restauration -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>💾 Sauvegarde & Restauration</h3>
                        </div>
                        <div class="card-content">
                            <div class="button-grid">
                                <button class="btn-success" onclick="exportDataAdmin()" style="background: linear-gradient(45deg, #2ED573, #1ABC9C); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 5px;">
                                    📥 Exporter Données
                                </button>
                                <button class="btn-success" onclick="document.getElementById('importFileAdmin').click()" style="background: linear-gradient(45deg, #2ED573, #1ABC9C); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 5px;">
                                    📤 Importer Données
                                </button>
                                <input type="file" id="importFileAdmin" accept=".json" style="display: none;" onchange="importDataAdmin(this.files[0])">
                            </div>
                        </div>
                    </div>

                    <!-- Journal des actions -->
                    <div class="dashboard-card" style="grid-column: 1 / -1;">
                        <div class="card-header">
                            <h3>📜 Journal des Actions</h3>
                            <button onclick="clearDataLog()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                🗑️ Vider
                            </button>
                        </div>
                        <div class="card-content">
                            <div id="dataActionLog" style="background: #000; color: #00FF00; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; height: 200px; overflow-y: auto;">
                                Gestion des données initialisée...<br>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Paramètres</h1>
                        <p class="page-description">Configuration de la plateforme</p>
                    </div>
                </div>


                <!-- Admin Profile Settings -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">🔐 Profil Administrateur</h2>
                        <button class="btn btn-secondary btn-sm" onclick="togglePasswordChange()">🔑 Changer mot de passe</button>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email Admin</label>
                                <input type="email" id="adminEmailSettings" value="admin@claudyne.com" readonly style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px; background-color: #F9FAFB;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Dernière connexion</label>
                                <input type="text" id="lastLogin" value="Il y a quelques minutes" readonly style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px; background-color: #F9FAFB;">
                            </div>
                        </div>

                        <!-- Change Password Form (Hidden by default) -->
                        <div id="passwordChangeForm" style="display: none; margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #EEF2FF 0%, #F0F9FF 100%); border-radius: 8px; border: 1px solid #C7D2FE;">
                            <h3 style="margin: 0 0 1rem 0; color: #1E40AF; font-size: 1.1rem;">🔒 Modifier le mot de passe</h3>
                            <div style="display: grid; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Mot de passe actuel</label>
                                    <input type="password" id="currentPassword" placeholder="••••••••" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Nouveau mot de passe</label>
                                    <input type="password" id="newPassword" placeholder="••••••••" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Confirmer nouveau mot de passe</label>
                                    <input type="password" id="confirmPassword" placeholder="••••••••" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                </div>
                                <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                                    <button class="btn btn-primary" onclick="changeAdminPassword()">✅ Modifier</button>
                                    <button class="btn btn-secondary" onclick="cancelPasswordChange()">❌ Annuler</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- General Settings -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Paramètres généraux</h2>
                        <button class="btn btn-primary btn-sm" onclick="saveSettings()">💾 Sauvegarder</button>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Nom de la plateforme</label>
                                <input type="text" id="siteName" value="Claudyne" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Slogan</label>
                                <input type="text" id="tagline" value="La force du savoir en héritage" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email support</label>
                                <input type="email" id="supportEmail" value="support@claudyne.com" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Téléphone support</label>
                                <input type="tel" id="supportPhone" value="+237690000000" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Configuration -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Configuration des API</h2>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="badge badge-warning">Sensible - Accès restreint</span>
                            <button class="btn btn-primary btn-sm" onclick="saveAPIConfiguration()">💾 Sauvegarder APIs</button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; gap: 1.5rem;">
                            <!-- Claude API -->
                            <div style="border: 1px solid #E5E7EB; border-radius: 8px; padding: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; color: #1F2937; font-size: 1.1rem;">🤖 Claude API (Anthropic)</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">API Key</label>
                                        <input type="password" id="claudeApiKey" placeholder="sk-ant-..." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Modèle</label>
                                        <select id="claudeModel" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                            <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                            <option value="claude-3-haiku">Claude 3 Haiku</option>
                                            <option value="claude-3-opus">Claude 3 Opus</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <button class="btn btn-secondary btn-sm" onclick="testClaudeAPI()">📋 Tester la connexion</button>
                                </div>
                            </div>

                            <!-- SMS API (LMT SMS) -->
                            <div style="border: 1px solid #E5E7EB; border-radius: 8px; padding: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; color: #1F2937; font-size: 1.1rem;">📱 LMT SMS API</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">API Key LMT</label>
                                        <input type="password" id="lmtApiKey" placeholder="Clé API LMT SMS" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Sender ID</label>
                                        <input type="text" id="lmtSenderId" placeholder="CLAUDYNE" maxlength="11" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">URL API</label>
                                        <input type="url" id="lmtApiUrl" value="https://api.lmtsms.cm/send" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Coût par SMS (FCFA)</label>
                                        <input type="number" id="smsCost" value="25" min="1" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <button class="btn btn-secondary btn-sm" onclick="testSMSAPI()">📱 Envoyer SMS test</button>
                                </div>
                            </div>

                            <!-- Email SMTP Configuration & Automation -->
                            <div style="border: 1px solid #E5E7EB; border-radius: 8px; padding: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; color: #1F2937; font-size: 1.1rem;">📬 Configuration SMTP Email & Automation</h3>

                                <!-- SMTP Server Configuration -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Serveur SMTP</label>
                                        <input type="text" id="smtpHost" placeholder="smtp.gmail.com" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Port</label>
                                        <input type="number" id="smtpPort" value="587" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Utilisateur SMTP</label>
                                        <input type="email" id="smtpUser" placeholder="noreply@claudyne.com" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Mot de passe SMTP</label>
                                        <input type="password" id="smtpPassword" placeholder="App Password Gmail" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                </div>

                                <!-- Email Automation Settings -->
                                <div style="border-top: 1px solid #E5E7EB; padding-top: 1.5rem; margin-bottom: 1.5rem;">
                                    <h4 style="margin-bottom: 1rem; color: #374151; font-size: 1rem;">🤖 Paramètres Automation Email</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Nom expéditeur</label>
                                            <input type="text" id="emailFromName" placeholder="Équipe Claudyne" value="Équipe Claudyne" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email support</label>
                                            <input type="email" id="emailSupport" placeholder="support@claudyne.com" value="support@claudyne.com" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Délai bienvenue (ms)</label>
                                            <input type="number" id="welcomeEmailDelay" placeholder="0" value="0" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                        </div>
                                    </div>

                                    <!-- Email Automation Toggles -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div>
                                            <label style="display: flex; align-items: center; cursor: pointer; padding: 0.75rem; border: 1px solid #E5E7EB; border-radius: 6px; background: #F9FAFB; transition: all 0.2s;">
                                                <input type="checkbox" id="emailAutomationEnabled" checked style="margin-right: 0.75rem; transform: scale(1.2);">
                                                <div>
                                                    <div style="font-weight: 500; color: #1F2937;">🚀 Automation activée</div>
                                                    <div style="font-size: 0.875rem; color: #6B7280;">Déclencher emails automatiques</div>
                                                </div>
                                            </label>
                                        </div>
                                        <div>
                                            <label style="display: flex; align-items: center; cursor: pointer; padding: 0.75rem; border: 1px solid #E5E7EB; border-radius: 6px; background: #F9FAFB; transition: all 0.2s;">
                                                <input type="checkbox" id="welcomeEmailEnabled" checked style="margin-right: 0.75rem; transform: scale(1.2);">
                                                <div>
                                                    <div style="font-weight: 500; color: #1F2937;">🎉 Email bienvenue</div>
                                                    <div style="font-size: 0.875rem; color: #6B7280;">Envoi automatique inscription</div>
                                                </div>
                                            </label>
                                        </div>
                                        <div>
                                            <label style="display: flex; align-items: center; cursor: pointer; padding: 0.75rem; border: 1px solid #E5E7EB; border-radius: 6px; background: #F9FAFB; transition: all 0.2s;">
                                                <input type="checkbox" id="passwordResetEnabled" checked style="margin-right: 0.75rem; transform: scale(1.2);">
                                                <div>
                                                    <div style="font-weight: 500; color: #1F2937;">🔐 Reset password</div>
                                                    <div style="font-size: 0.875rem; color: #6B7280;">Réinitialisation mot de passe</div>
                                                </div>
                                            </label>
                                        </div>
                                        <div>
                                            <label style="display: flex; align-items: center; cursor: pointer; padding: 0.75rem; border: 1px solid #E5E7EB; border-radius: 6px; background: #F9FAFB; transition: all 0.2s;">
                                                <input type="checkbox" id="prixClaudineEmailEnabled" checked style="margin-right: 0.75rem; transform: scale(1.2);">
                                                <div>
                                                    <div style="font-weight: 500; color: #1F2937;">🏆 Prix Claudine</div>
                                                    <div style="font-size: 0.875rem; color: #6B7280;">Notifications concours</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="smtpTls" checked style="margin-right: 0.5rem;">
                                        Utiliser TLS/STARTTLS
                                    </label>
                                    <div style="flex: 1;"></div>
                                    <button class="btn btn-secondary btn-sm" onclick="testEmailSMTP()" style="background: #6B7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                                        📬 Test SMTP
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="saveEmailConfiguration()" style="background: #10B981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                                        💾 Sauvegarder config
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="sendTestWelcomeEmail()" style="background: #3B82F6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                                        🧪 Test bienvenue
                                    </button>
                                </div>
                                <div id="emailConfigResult" style="margin-top: 1rem; font-weight: 500; padding: 0.75rem; border-radius: 6px; display: none;"></div>
                            </div>

                            <!-- ChatGPT OpenAI Configuration -->
                            <div style="border: 1px solid #E5E7EB; border-radius: 8px; padding: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; color: #1F2937; font-size: 1.1rem;">🤖 ChatGPT API (OpenAI)</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">API Key OpenAI</label>
                                        <input type="password" id="openaiApiKey" placeholder="sk-proj-..." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Modèle</label>
                                        <select id="openaiModel" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                            <option value="gpt-4o">GPT-4o (Recommandé)</option>
                                            <option value="gpt-4o-mini">GPT-4o Mini</option>
                                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Température (0-2)</label>
                                        <input type="number" id="openaiTemperature" value="0.7" min="0" max="2" step="0.1" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Max Tokens</label>
                                        <input type="number" id="openaiMaxTokens" value="2048" min="1" max="4096" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Prompt système par défaut</label>
                                    <textarea id="openaiSystemPrompt" rows="3" placeholder="Tu es un assistant pédagogique pour la plateforme Claudyne..." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px; resize: vertical;"></textarea>
                                </div>
                                <div style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="openaiEnabled" style="margin-right: 0.5rem;">
                                        Activer l'intégration ChatGPT
                                    </label>
                                    <button class="btn btn-secondary btn-sm" onclick="testOpenAI()">🤖 Tester la connexion</button>
                                </div>
                            </div>

                            <!-- Future APIs Placeholder -->
                            <div style="border: 1px solid #E5E7EB; border-radius: 8px; padding: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; color: #1F2937; font-size: 1.1rem;">🚀 APIs futures</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">API Paiement (Flutterwave)</label>
                                        <input type="password" id="flutterwaveKey" placeholder="FLWPUBK-..." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">API Analytics (Google)</label>
                                        <input type="password" id="googleAnalyticsId" placeholder="GA-..." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">API Push Notifications</label>
                                        <input type="password" id="pushNotificationKey" placeholder="Firebase Server Key" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">API Custom</label>
                                        <input type="text" id="customApiKey" placeholder="Future integration" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing Configuration -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Configuration tarifaire</h2>
                        <button class="btn btn-primary btn-sm" onclick="savePricingConfiguration()">💾 Sauvegarder tarifs</button>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Plan Basique (FCFA/mois)</label>
                                <input type="number" id="basicPrice" value="2500" min="0" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Plan Premium (FCFA/mois)</label>
                                <input type="number" id="premiumPrice" value="4500" min="0" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Plan Famille (FCFA/an)</label>
                                <input type="number" id="familyPrice" value="45000" min="0" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Durée essai (jours)</label>
                                <input type="number" id="trialDays" value="7" min="1" max="30" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Family-Student Links Section -->
            <div id="family-links-section" class="section hidden">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">🔗 Liaisons Famille-Étudiants</h1>
                        <p class="page-description">Gestion des relations entre comptes parents et profils étudiants - Visualisation et administration des liens familiaux</p>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-grid animate-fadeInUp" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="stat-card glass-stat-card">
                        <div class="glass-stat-icon">👨‍👩‍👧‍👦</div>
                        <div class="glass-stat-value" id="totalFamilies">248</div>
                        <div class="glass-stat-title">Familles actives</div>
                    </div>
                    <div class="stat-card glass-stat-card">
                        <div class="glass-stat-icon">🎓</div>
                        <div class="glass-stat-value" id="totalStudents">832</div>
                        <div class="glass-stat-title">Étudiants inscrits</div>
                    </div>
                    <div class="stat-card glass-stat-card">
                        <div class="glass-stat-icon">🔗</div>
                        <div class="glass-stat-value" id="linkedStudents">756</div>
                        <div class="glass-stat-title">Étudiants liés</div>
                    </div>
                    <div class="stat-card glass-stat-card">
                        <div class="glass-stat-icon">⚠️</div>
                        <div class="glass-stat-value" id="orphanStudents">76</div>
                        <div class="glass-stat-title">Sans liaison</div>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Recherche et filtres</h2>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Rechercher famille</label>
                                <input type="text" id="familySearch" placeholder="Nom de famille, ID..." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Rechercher étudiant</label>
                                <input type="text" id="studentSearch" placeholder="Nom, prénom..." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Statut liaison</label>
                                <select id="linkStatusFilter" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="">Tous les statuts</option>
                                    <option value="linked">Étudiants liés</option>
                                    <option value="orphaned">Sans liaison</option>
                                    <option value="multiple">Liaisons multiples</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="searchFamilyLinks()">
                                🔍 Rechercher
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Family-Student Links Table -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">Liaisons actives</h2>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="openLinkStudentModal()">
                                ➕ Créer liaison
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="detectOrphanedStudents()">
                                ⚠️ Détecter orphelins
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="table-container">
                            <table class="glass-table" id="familyLinksTable">
                                <thead>
                                    <tr>
                                        <th>👨‍👩‍👧‍👦 Famille</th>
                                        <th>🎓 Étudiants liés</th>
                                        <th>📊 Statut</th>
                                        <th>📅 Dernière activité</th>
                                        <th>⚙️ Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="familyLinksTableBody">
                                    <!-- Data will be populated by JavaScript -->
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                                    NK
                                                </div>
                                                <div>
                                                    <div style="font-weight: 600;">Famille Nkoulou</div>
                                                    <div style="font-size: 0.875rem; color: #6B7280;">FAM-001234</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                                <span class="glass-badge glass-badge-success">📚 Marie Nkoulou (Terminale A)</span>
                                                <span class="glass-badge glass-badge-primary">📖 Jean Nkoulou (3ème)</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="glass-badge glass-badge-success">✅ Actif</span>
                                        </td>
                                        <td>Il y a 2 heures</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-sm btn-outline" onclick="viewFamilyDetails('FAM-001234')" title="Voir détails">
                                                    👁️
                                                </button>
                                                <button class="btn btn-sm btn-primary" onclick="manageFamilyLinks('FAM-001234')" title="Gérer liaisons">
                                                    🔗
                                                </button>
                                                <button class="btn btn-sm btn-warning" onclick="editFamily('FAM-001234')" title="Modifier">
                                                    ✏️
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f093fb, #f5576c); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                                    AB
                                                </div>
                                                <div>
                                                    <div style="font-weight: 600;">Famille Abena</div>
                                                    <div style="font-size: 0.875rem; color: #6B7280;">FAM-002567</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                                <span class="glass-badge glass-badge-warning">⚠️ Paul Abena (1ère S) - Orphelin</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="glass-badge glass-badge-warning">⚠️ Liaison manquante</span>
                                        </td>
                                        <td>Il y a 1 jour</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-sm btn-outline" onclick="viewFamilyDetails('FAM-002567')" title="Voir détails">
                                                    👁️
                                                </button>
                                                <button class="btn btn-sm btn-success" onclick="linkOrphanStudent('FAM-002567')" title="Lier étudiant">
                                                    🔗➕
                                                </button>
                                                <button class="btn btn-sm btn-warning" onclick="editFamily('FAM-002567')" title="Modifier">
                                                    ✏️
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Orphaned Students Section -->
                <div class="content-section glass-card animate-fadeInUp">
                    <div class="section-header">
                        <h2 class="section-title">⚠️ Étudiants sans liaison familiale</h2>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="autoLinkOrphans()">
                                🤖 Liaison automatique
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="table-container">
                            <table class="glass-table" id="orphanStudentsTable">
                                <thead>
                                    <tr>
                                        <th>🎓 Étudiant</th>
                                        <th>📚 Niveau</th>
                                        <th>📅 Inscription</th>
                                        <th>📱 Contact</th>
                                        <th>⚙️ Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="orphanStudentsTableBody">
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #4facfe, #00f2fe); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                                    CK
                                                </div>
                                                <div>
                                                    <div style="font-weight: 600;">Claude Kameni</div>
                                                    <div style="font-size: 0.875rem; color: #6B7280;">STU-003456</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="glass-badge glass-badge-primary">Terminale C</span>
                                        </td>
                                        <td>15 Mars 2024</td>
                                        <td>
                                            <div style="font-size: 0.875rem;">
                                                <div>📧 claude.kameni@email.com</div>
                                                <div>📱 +237 696 123 456</div>
                                            </div>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-sm btn-success" onclick="assignToFamily('STU-003456')" title="Assigner à famille">
                                                    👨‍👩‍👧‍👦
                                                </button>
                                                <button class="btn btn-sm btn-primary" onclick="createNewFamily('STU-003456')" title="Créer nouvelle famille">
                                                    ➕👨‍👩‍👧‍👦
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour création de compte -->
    <div id="createAccountModal" class="modal glass-modal">
        <div class="modal-content glass-modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('createAccountModal')">&times;</span>
            <h2>Créer un nouveau compte abonné</h2>
            
            <!-- Choix du type de compte -->
            <div class="form-group">
                <label style="display: block; margin-bottom: 1rem; font-weight: 600; font-size: 1.1rem;">Type de compte</label>
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                    <label class="account-type-option" onclick="selectAccountType('individual')">
                        <input type="radio" name="accountType" value="individual" id="typeIndividual">
                        <div class="account-type-card">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">👤</div>
                            <h3>Compte Individuel</h3>
                            <p>Pour une personne seule</p>
                            <small>ID: IND-XXXXXX</small>
                        </div>
                    </label>
                    <label class="account-type-option" onclick="selectAccountType('family')">
                        <input type="radio" name="accountType" value="family" id="typeFamily">
                        <div class="account-type-card">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">👨‍👩‍👧‍👦</div>
                            <h3>Compte Familial</h3>
                            <p>Pour toute la famille</p>
                            <small>ID: FAM-XXXXXX</small>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Formulaire dynamique -->
            <div id="accountForm" style="display: none;">
                <!-- Informations communes -->
                <div class="form-section">
                    <h3>Informations du responsable</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Prénom *</label>
                            <input type="text" id="firstName" required style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                        </div>
                        <div class="form-group">
                            <label>Nom *</label>
                            <input type="text" id="lastName" required style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="email" required style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                        </div>
                        <div class="form-group">
                            <label>Téléphone *</label>
                            <input type="tel" id="phone" placeholder="+237XXXXXXXXX" required style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                        </div>
                    </div>
                </div>

                <!-- Section famille (visible uniquement pour compte familial) -->
                <div id="familySection" style="display: none;">
                    <div class="form-section">
                        <h3>Informations familiales</h3>
                        <div class="form-group">
                            <label>Nom de famille *</label>
                            <input type="text" id="familyName" placeholder="Ex: Famille Mbarga" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Nombre d'enfants</label>
                                <input type="number" id="childrenCount" min="1" max="10" value="2" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                            </div>
                            <div class="form-group">
                                <label>Région</label>
                                <select id="region" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    <option value="">Sélectionner...</option>
                                    <option value="Centre">Centre</option>
                                    <option value="Littoral">Littoral</option>
                                    <option value="Ouest">Ouest</option>
                                    <option value="Nord-Ouest">Nord-Ouest</option>
                                    <option value="Sud-Ouest">Sud-Ouest</option>
                                    <option value="Adamaoua">Adamaoua</option>
                                    <option value="Nord">Nord</option>
                                    <option value="Extrême-Nord">Extrême-Nord</option>
                                    <option value="Est">Est</option>
                                    <option value="Sud">Sud</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuration d'abonnement -->
                <div class="form-section">
                    <h3>Configuration d'abonnement</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Type d'abonnement</label>
                            <select id="subscriptionType" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                <option value="trial">Essai gratuit</option>
                                <option value="basic">Basique</option>
                                <option value="premium">Premium</option>
                                <option value="family">Famille</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Durée essai (jours)</label>
                            <input type="number" id="trialDuration" value="7" min="1" max="30" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                        </div>
                        <div class="form-group">
                            <label>Statut initial</label>
                            <select id="initialStatus" style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                <option value="active">Actif</option>
                                <option value="trial">En essai</option>
                                <option value="pending">En attente</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Options avancees -->
                <div class="form-section">
                    <h3>Options avancées</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="sendWelcomeEmail" checked style="margin-right: 0.5rem;">
                                Envoyer email de bienvenue
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="sendWelcomeSMS" style="margin-right: 0.5rem;">
                                Envoyer SMS de bienvenue
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes administratives</label>
                        <textarea id="adminNotes" rows="3" placeholder="Notes internes..." style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #E5E7EB;">
                    <div>
                        <span style="font-size: 0.875rem; color: #6B7280;">* Champs obligatoires</span>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary glass-btn" onclick="closeModal('createAccountModal')">Annuler</button>
                        <button class="btn btn-primary glass-btn glass-btn-primary" onclick="previewAccount()">👁️ Aperçu</button>
                        <button class="btn btn-success glass-btn glass-btn-success" onclick="createAccount()">✅ Créer le compte</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation -->
    <div id="confirmationModal" class="modal glass-modal">
        <div class="modal-content glass-modal-content">
            <span class="close" onclick="closeModal('confirmationModal')">&times;</span>
            <h2 id="confirmationTitle">Confirmation de création</h2>
            <div id="confirmationContent"></div>
            <div style="display: flex; justify-content: end; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-secondary glass-btn" onclick="closeModal('confirmationModal')">Retour</button>
                <button class="btn btn-success glass-btn glass-btn-success" onclick="confirmCreateAccount()">✅ Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Modal de création de plan tarifaire -->
    <div id="createPlanModal" class="modal glass-modal">
        <div class="modal-content glass-modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <span class="close" onclick="closeModal('createPlanModal')">&times;</span>
                <h2>Créer un nouveau plan tarifaire</h2>
                <p>Définissez les caractéristiques du plan d'abonnement</p>
            </div>

            <div class="modal-body">
                <form id="createPlanForm">
                    <!-- Informations de base -->
                    <div class="form-group">
                        <label for="planName">Nom du plan *</label>
                        <input type="text" id="planName" name="planName" placeholder="Ex: Premium Familial" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="planType">Type de compte *</label>
                            <select id="planType" name="planType" required onchange="updatePlanFields()">
                                <option value="">Sélectionner...</option>
                                <option value="individual">Individuel</option>
                                <option value="family">Familial</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="planCategory">Catégorie *</label>
                            <select id="planCategory" name="planCategory" required>
                                <option value="">Sélectionner...</option>
                                <option value="basique">Basique</option>
                                <option value="premium">Premium</option>
                                <option value="mixte">Mixte</option>
                                <option value="trial">Essai</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tarification -->
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="planPrice">Prix (FCFA) *</label>
                            <input type="number" id="planPrice" name="planPrice" min="0" placeholder="5000" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="planDuration">Durée *</label>
                            <select id="planDuration" name="planDuration" required>
                                <option value="">Sélectionner...</option>
                                <option value="monthly">Mensuel (1 mois)</option>
                                <option value="quarterly">Trimestriel (3 mois)</option>
                                <option value="annual">Annuel (12 mois)</option>
                                <option value="trial">Essai (jours)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Durée essai (si applicable) -->
                    <div class="form-group" id="trialDaysGroup" style="display: none;">
                        <label for="trialDays">Durée de l'essai (jours)</label>
                        <input type="number" id="trialDays" name="trialDays" min="1" max="90" placeholder="7">
                    </div>

                    <!-- Fonctionnalités -->
                    <div class="form-group">
                        <label>Fonctionnalités incluses</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="features" value="courses" checked>
                                <span>Accès aux cours</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="features" value="quizzes">
                                <span>Quiz interactifs</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="features" value="progress">
                                <span>Suivi de progression</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="features" value="certificates">
                                <span>Certificats</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="features" value="support">
                                <span>Support prioritaire</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="features" value="offline">
                                <span>Accès hors ligne</span>
                            </label>
                        </div>
                    </div>

                    <!-- Limites (pour compte familial) -->
                    <div id="familyLimits" style="display: none;">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="maxChildren">Nombre max d'enfants</label>
                                <input type="number" id="maxChildren" name="maxChildren" min="1" max="10" placeholder="5">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="maxDevices">Appareils simultanés</label>
                                <input type="number" id="maxDevices" name="maxDevices" min="1" max="20" placeholder="3">
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label for="planDescription">Description</label>
                        <textarea id="planDescription" name="planDescription" rows="3" placeholder="Description détaillée du plan..."></textarea>
                    </div>

                    <!-- Statut et visibilité -->
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="planStatus">Statut</label>
                            <select id="planStatus" name="planStatus">
                                <option value="active">Actif</option>
                                <option value="inactive">Inactif</option>
                                <option value="draft">Brouillon</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="checkbox-item">
                                <input type="checkbox" id="planFeatured" name="planFeatured">
                                <span>Plan mis en avant</span>
                            </label>
                        </div>
                    </div>
                </form>

                <!-- Boutons d'action -->
                <div class="modal-actions">
                    <button class="btn btn-secondary glass-btn" onclick="closeModal('createPlanModal')">Annuler</button>
                    <button class="btn btn-primary glass-btn glass-btn-primary" onclick="previewPlan()">👁️ Aperçu</button>
                    <button class="btn btn-success glass-btn glass-btn-success" onclick="createPlan()">✅ Créer le plan</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================================
        // AUTHENTIFICATION ADMINISTRATEUR
        // ================================

        // Vérifier l'authentification au chargement de la page
        function checkAdminAuth() {
            const token = localStorage.getItem('claudyne_token');
            const user = localStorage.getItem('claudyne_user');

            if (token && user) {
                try {
                    const userData = JSON.parse(user);
                    if (userData.role === 'ADMIN' && userData.userType === 'ADMIN') {
                        // Utilisateur admin authentifié
                        showAdminInterface();
                        return true;
                    }
                } catch (e) {
                    console.error('Erreur parsing user data:', e);
                }
            }

            // Pas d'authentification ou pas admin
            showLoginForm();
            return false;
        }

        function showAdminInterface() {
            document.getElementById('adminLoginForm').style.display = 'none';
            document.querySelector('.admin-container').classList.add('authenticated');
        }

        function showLoginForm() {
            document.getElementById('adminLoginForm').style.display = 'flex';
            document.querySelector('.admin-container').classList.remove('authenticated');
        }

        // Gestion du formulaire de connexion admin
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier l'auth au chargement
            checkAdminAuth();

            // Gestion du formulaire de connexion
            const adminAuthForm = document.getElementById('adminAuthForm');
            const loginBtn = document.getElementById('adminLoginBtn');
            const errorDiv = document.getElementById('adminLoginError');

            adminAuthForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const credential = document.getElementById('adminEmail').value;
                const password = document.getElementById('adminPassword').value;

                // Validation des champs
                if (!credential || !password) {
                    showError('Veuillez saisir vos identifiants et mot de passe');
                    return;
                }

                // Affichage loading
                loginBtn.disabled = true;
                loginBtn.textContent = '🔐 Connexion...';
                hideError();

                try {
                    // Appel API d'authentification
                    const response = await fetch(`${API_BASE}/api/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            credential: credential,
                            password: password
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.data.user.role === 'ADMIN') {
                        // Connexion admin réussie
                        localStorage.setItem('claudyne_token', data.data.tokens.accessToken);
                        localStorage.setItem('claudyne_refresh_token', data.data.tokens.refreshToken);
                        localStorage.setItem('claudyne_user', JSON.stringify(data.data.user));

                        // Afficher l'interface admin
                        showAdminInterface();

                        // Message de bienvenue
                        console.log('🎉 Connexion admin réussie!');
                    } else {
                        // Erreur d'authentification - tenter l'auth locale
                        console.log('🔄 API refuse l\'accès, tentative d\'authentification locale...');
                        attemptLocalAuth();
                    }

                } catch (error) {
                    console.error('Erreur connexion admin:', error);
                    attemptLocalAuth();
                }

                // Fonction d'authentification locale
                function attemptLocalAuth() {
                    console.log('🔄 Tentative d\'authentification locale...');

                    // Identifiants admin statiques pour les tests
                    const validCredentials = [
                        { email: 'admin@claudyne.com', password: 'admin123' }
                    ];

                    const isValidLogin = validCredentials.some(cred =>
                        (credential === cred.email || credential === cred.email.replace('@claudyne.com', '@claudyne.cm')) &&
                        password === cred.password
                    );

                    if (isValidLogin) {
                        // Créer un token fictif et des données utilisateur pour le mode local
                        const fakeToken = 'local_admin_token_' + Date.now();
                        const fakeUser = {
                            id: 'admin-local',
                            email: credential,
                            firstName: 'Admin',
                            lastName: 'Local',
                            role: 'ADMIN',
                            userType: 'ADMIN'
                        };

                        localStorage.setItem('claudyne_token', fakeToken);
                        localStorage.setItem('claudyne_user', JSON.stringify(fakeUser));
                        localStorage.setItem('claudyne_local_mode', 'true');

                        showAdminInterface();
                        console.log('✅ Connexion admin locale réussie (mode offline)!');
                        return;
                    }

                    showError('Erreur de connexion. API non disponible et identifiants invalides.');
                }

                // Restaurer le bouton
                loginBtn.disabled = false;
                loginBtn.textContent = 'Se connecter';
            });

            function showError(message) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }

            function hideError() {
                errorDiv.style.display = 'none';
            }
        });

        // Fonction de déconnexion admin
        function adminLogout() {
            localStorage.removeItem('claudyne_token');
            localStorage.removeItem('claudyne_refresh_token');
            localStorage.removeItem('claudyne_user');
            localStorage.removeItem('claudyne_family');

            showLoginForm();
            console.log('🚪 Déconnexion admin effectuée');
        }

        // Fonctions pour la récupération de mot de passe
        function showForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'flex';
            document.getElementById('forgotEmail').focus();
        }

        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'none';
            document.getElementById('forgotPasswordForm').reset();
            hideForgotMessage();
        }

        function showForgotMessage(message, type) {
            const messageDiv = document.getElementById('forgotPasswordMessage');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';

            if (type === 'success') {
                messageDiv.style.background = '#F0FDF4';
                messageDiv.style.border = '1px solid #BBF7D0';
                messageDiv.style.color = '#15803D';
            } else {
                messageDiv.style.background = '#FEF2F2';
                messageDiv.style.border = '1px solid #FECACA';
                messageDiv.style.color = '#DC2626';
            }
        }

        function hideForgotMessage() {
            document.getElementById('forgotPasswordMessage').style.display = 'none';
        }

        // Gestion du formulaire de récupération de mot de passe
        document.addEventListener('DOMContentLoaded', function() {
            const forgotForm = document.getElementById('forgotPasswordForm');
            const sendResetBtn = document.getElementById('sendResetBtn');

            forgotForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const email = document.getElementById('forgotEmail').value.trim();

                if (!email) {
                    showForgotMessage('Veuillez entrer votre email', 'error');
                    return;
                }

                // Loading state
                sendResetBtn.disabled = true;
                sendResetBtn.textContent = '📧 Envoi en cours...';
                hideForgotMessage();

                try {
                    const response = await fetch(`${API_BASE}/api/auth/forgot-password`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showForgotMessage('📧 Email de réinitialisation envoyé ! Vérifiez votre boîte de réception.', 'success');

                        // Fermer le modal après 3 secondes
                        setTimeout(() => {
                            closeForgotPassword();
                        }, 3000);
                    } else {
                        showForgotMessage(data.message || 'Erreur lors de l\'envoi de l\'email', 'error');
                    }

                } catch (error) {
                    console.error('Erreur récupération mot de passe:', error);
                    showForgotMessage('Erreur de connexion. Veuillez réessayer.', 'error');
                }

                // Restaurer le bouton
                sendResetBtn.disabled = false;
                sendResetBtn.textContent = 'Envoyer le lien';
            });

            // Fermer le modal en cliquant à l'extérieur
            document.getElementById('forgotPasswordModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeForgotPassword();
                }
            });
        });

        // Définir showSection dans la portée globale immédiatement
        window.showSection = function(sectionName) {
            console.log(`🔄 Changement vers section: ${sectionName}`);
            console.log(`📍 URL avant: ${window.location.href}`);
            
            // Empêcher le comportement par défaut
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            currentSection = sectionName;
            
            // Masquer toutes les sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
                console.log(`  - Section ${section.id} masquée`);
            });

            // Afficher la section demandée
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
                
                // Initialiser les données spécifiques à la section
                if (sectionName === 'family-links') {
                    setTimeout(() => initializeFamilyLinksSection(), 100);
                } else if (sectionName === 'email-automation') {
                    setTimeout(() => {
                        console.log('🤖 Initialisation section automatisation...');
                        loadEmailAutomationData();
                    }, 100);
                }
                
                // Ajouter animation d'apparition
                targetSection.style.opacity = '0';
                setTimeout(() => {
                    targetSection.style.transition = 'opacity 0.3s ease';
                    targetSection.style.opacity = '1';
                }, 10);
                
                console.log(`✅ Section ${sectionName} affichée`);
            } else {
                console.error(`❌ Section ${sectionName}-section non trouvée`);
                return false;
            }

            // Mettre à jour la navigation - retirer active de tous les liens
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Ajouter active au lien cliqué
            if (event && event.target) {
                const clickedLink = event.target.closest('.nav-link');
                if (clickedLink) {
                    clickedLink.classList.add('active');
                    console.log(`✅ Navigation mise à jour - lien actif: ${clickedLink.textContent.trim()}`);
                }
            }
            
            // Charger les données de la section si la fonction existe
            if (typeof loadSectionData === 'function') {
                loadSectionData(sectionName);
            }
            
            console.log(`📍 URL après: ${window.location.href}`);
            return false;
        };

        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3001' : 'https://claudyne.com';
        let USE_MOCK_DATA = false; // VRAI BACKEND ACTIVÉ - Données réelles depuis l'API
        
        // Backend réel activé - données authentiques
        console.log('🚀 BACKEND RÉEL ACTIVÉ - Interface connectée aux vraies APIs');
        console.log('🎨 Cache v1.2.8 - AUTOMATISATION EMAILS ACTIVE + Force refresh');
        console.log('📡 Connexion à l\'API backend sur ' + API_BASE);
        
        // Vérifier si l'API backend est disponible (désactivé en mode démo)
        async function checkBackendAvailability() {
            try {
                // Tester une route basique du serveur principal
                const response = await fetch(`${API_BASE}/`, {
                    method: 'HEAD',
                    timeout: 3000
                });
                if (response.ok) {
                    console.log('✅ Backend disponible - Utilisation des données réelles');
                    USE_MOCK_DATA = false;
                } else {
                    console.log('⚠️ Backend indisponible - Basculement vers les données simulées');
                    USE_MOCK_DATA = true;
                }
            } catch (error) {
                console.log('❌ Erreur connexion backend - Utilisation des données simulées');
                console.error('Détails:', error.message);
                USE_MOCK_DATA = true;
            }
        }
        
        // Initialiser la vérification backend
        checkBackendAvailability();
        let currentSection = 'dashboard';
        
        // Detection des erreurs JavaScript
        window.addEventListener('error', function(e) {
            console.error('❌ Erreur JavaScript:', e.error);
            console.error('❌ Fichier:', e.filename, 'Ligne:', e.lineno);
        });

        // Vérification que showSection est bien définie
        console.log('✅ showSection définie:', typeof window.showSection);
        console.log('✅ showSection accessible:', typeof showSection);

        // showSection maintenant définie dans window au début

        // Gestion du dropdown "Ajouter contenu"
        document.addEventListener('DOMContentLoaded', function() {
            const addContentBtn = document.getElementById('addContentBtn');
            const dropdown = document.getElementById('addContentDropdown');
            
            if (addContentBtn && dropdown) {
                addContentBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const isVisible = dropdown.style.display !== 'none';
                    dropdown.style.display = isVisible ? 'none' : 'block';
                });
                
                // Fermer le dropdown en cliquant ailleurs
                document.addEventListener('click', function(e) {
                    if (!addContentBtn.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.style.display = 'none';
                    }
                });
            }
        });

        // Navigation entre sections
        // Function supprimée - utilise la version améliorée plus bas

        // Chargement des données par section
        async function loadSectionData(section) {
            try {
                console.log(`📊 Chargement des données pour la section: ${section}`);
                
                switch (section) {
                    case 'dashboard':
                        await loadDashboardData();
                        break;
                    case 'users':
                        await loadUsersData();
                        break;
                    case 'content':
                        await loadContentData();
                        break;
                    case 'payments':
                        await loadPaymentsData();
                        break;
                    case 'analytics':
                        await loadAnalyticsData();
                        break;
                    case 'free-modules':
                        await loadFreeModulesData();
                        break;
                    case 'trial-management':
                        await loadTrialManagementData();
                        break;
                    case 'roles-management':
                        await loadRolesManagementData();
                        break;
                    case 'staff-management':
                        await loadStaffManagementData();
                        break;
                    case 'communication':
                        await loadCommunicationData();
                        break;
                    case 'reports':
                        await loadReportsData();
                        break;
                    case 'system-monitoring':
                        await loadSystemMonitoringData();
                        break;
                    case 'pricing-plans':
                        await loadPricingPlansData();
                        break;
                    case 'settings':
                        await loadSettingsData();
                        await loadEmailConfiguration();
                        break;
                    case 'email-templates':
                        await loadEmailTemplatesData();
                        break;
                    case 'email-automation':
                        await loadEmailAutomationData();
                        break;
                    default:
                        console.log(`✅ Section ${section} chargée (pas de données spécifiques)`);
                }
                
                console.log(`✅ Données chargées pour ${section}`);
            } catch (error) {
                console.warn(`⚠️ Erreur lors du chargement des données pour ${section}:`, error);
                // Continuer l'exécution même en cas d'erreur - mode développement
            }
        }

        // Dashboard Data
        async function loadDashboardData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/dashboard`);
                const data = await response.json();

                if (data.success) {
                    // Mise à jour des statistiques
                    document.getElementById('active-families').textContent = data.data.stats.activeFamilies;
                    document.getElementById('active-students').textContent = data.data.stats.activeStudents;
                    document.getElementById('monthly-revenue').textContent = formatCurrency(data.data.stats.monthlyRevenue);
                    document.getElementById('quizzes-taken').textContent = data.data.stats.quizzesTaken;

                    // Activité récente
                    const activityHtml = data.data.recentActivity.map(activity => `
                        <div style="padding: 0.75rem 0; border-bottom: 1px solid #E5E7EB;">
                            <div style="font-weight: 500;">${activity.message}</div>
                            <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.25rem;">
                                ${formatDate(activity.timestamp)}
                            </div>
                        </div>
                    `).join('');

                    document.getElementById('recent-activity').innerHTML = activityHtml || '<p>Aucune activité récente</p>';
                }
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
                document.getElementById('recent-activity').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement</p>';
            }
        }

        // Users Data
        async function loadUsersData() {
            try {
                if (USE_MOCK_DATA) {
                    console.log('✅ Section Gestion des familles chargée (mode simulation)');
                    
                    // Afficher du contenu simulé visible
                    const usersContainer = document.querySelector('#users-section .section-content');
                    if (usersContainer) {
                        usersContainer.innerHTML = `
                            <div style="padding: 2rem; text-align: center; background: rgba(255,255,255,0.1); border-radius: 12px; margin: 1rem 0;">
                                <h3 style="color: #1F2937; margin-bottom: 1rem;">📊 Données de Gestion des Familles (Mode Démo)</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <h4 style="color: #1F2937;">👨‍👩‍👧‍👦 Familles</h4>
                                        <p style="font-size: 2rem; font-weight: bold; color: #3B82F6;">248</p>
                                    </div>
                                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <h4 style="color: #1F2937;">🎓 Étudiants</h4>
                                        <p style="font-size: 2rem; font-weight: bold; color: #10B981;">832</p>
                                    </div>
                                    <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <h4 style="color: #1F2937;">💰 Abonnements</h4>
                                        <p style="font-size: 2rem; font-weight: bold; color: #F59E0B;">156</p>
                                    </div>
                                </div>
                                <p style="color: #6B7280; font-style: italic;">
                                    Interface prête pour la production ! 🚀<br>
                                    Les données réelles apparaîtront une fois le backend connecté.
                                </p>
                            </div>
                        `;
                    }
                    return;
                }
                
                const response = await fetch(`${API_BASE}/api/admin/users`);
                const data = await response.json();

                if (data.success) {
                    const usersHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID Abonné</th>
                                    <th>Type Compte</th>
                                    <th>Nom/Famille</th>
                                    <th>Contact</th>
                                    <th>Statut</th>
                                    <th>Abonnement</th>
                                    <th>Points Claudine</th>
                                    <th>Dernière activité</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.users.map(user => {
                                    const isFamily = user.subscriptionType.includes('family') || user.children > 1;
                                    const subscriberId = isFamily ? `FAM-${String(user.id).padStart(6, '0')}` : `IND-${String(user.id).padStart(6, '0')}`;
                                    const accountType = isFamily ? '👨‍👩‍👧‍👦 Familial' : '👤 Individuel';
                                    const accountName = isFamily ? user.familyName : `${user.firstName} ${user.lastName}`;
                                    
                                    return `
                                    <tr>
                                        <td style="font-family: monospace; font-weight: bold; color: ${isFamily ? '#10B981' : '#3B82F6'};">${subscriberId}</td>
                                        <td>
                                            <span style="font-size: 0.875rem; font-weight: 500;">${accountType}</span>
                                        </td>
                                        <td>
                                            <div style="font-weight: 500;">${accountName}</div>
                                            ${isFamily ? `<div style="font-size: 0.75rem; color: #6B7280;">${user.firstName} ${user.lastName} (Responsable)</div>` : `<div style="font-size: 0.75rem; color: #6B7280;">Compte personnel</div>`}
                                        </td>
                                        <td>
                                            <div style="font-size: 0.875rem;">${user.email}</div>
                                            <div style="font-size: 0.75rem; color: #6B7280;">${user.phone}</div>
                                        </td>
                                        <td>
                                            <span class="status-badge ${user.status}">${getStatusLabel(user.status)}</span>
                                        </td>
                                        <td>
                                            <span class="status-badge ${user.subscriptionType}">${getSubscriptionLabel(user.subscriptionType)}</span>
                                            ${isFamily ? `<div style="font-size: 0.75rem; color: #6B7280;">${user.children} enfant(s)</div>` : ''}
                                        </td>
                                        <td style="font-weight: 600; color: #F59E0B;">${user.totalClaudinePoints}</td>
                                        <td style="font-size: 0.75rem; color: #6B7280;">${formatDate(user.lastActivity)}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" onclick="editSubscriber('${user.id}', '${isFamily ? 'family' : 'individual'}')">Modifier</button>
                                            <button class="btn btn-warning btn-sm" onclick="manageTrialPeriod('${user.id}')">Essai</button>
                                        </td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;

                    document.getElementById('users-table').innerHTML = usersHtml;
                }
            } catch (error) {
                console.error('Erreur chargement users:', error);
                document.getElementById('users-table').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement</p>';
            }
        }

        // Content Data with Tabs
        async function loadContentData() {
            await loadCoursesData();
            await loadQuizzesData();
            await loadResourcesData();
        }

        // Load Courses Data
        async function loadCoursesData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/content`);
                const data = await response.json();

                if (data.success) {
                    const coursesHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Matière</th>
                                    <th>Leçons</th>
                                    <th>Étudiants</th>
                                    <th>Score moyen</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.subjects.map(subject => `
                                    <tr>
                                        <td style="font-weight: 500;">${subject.title}</td>
                                        <td>${subject.lessons}</td>
                                        <td>${subject.students}</td>
                                        <td style="font-weight: 600; color: #10B981;">${subject.averageScore}%</td>
                                        <td>
                                            <span class="status-badge ${subject.status}">${getStatusLabel(subject.status)}</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm">Modifier</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    document.getElementById('courses-table').innerHTML = coursesHtml;
                }
            } catch (error) {
                console.error('Erreur chargement courses:', error);
                document.getElementById('courses-table').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement</p>';
            }
        }

        // Load Quizzes Data
        async function loadQuizzesData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/content`);
                const data = await response.json();
                const quizzes = data.success ? data.data.quizzes : [];
                
                const quizzesHtml = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Titre Quiz</th>
                                <th>Matière</th>
                                <th>Questions</th>
                                <th>Tentatives</th>
                                <th>Score moyen</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="font-weight: 500;">Quiz: Introduction aux nombres</td>
                                <td>Mathématiques 6ème</td>
                                <td>3</td>
                                <td>156</td>
                                <td style="font-weight: 600; color: #10B981;">78%</td>
                                <td><span class="status-badge active">Actif</span></td>
                                <td>
                                    <button class="btn btn-secondary btn-sm">Modifier</button>
                                    <button class="btn btn-danger btn-sm">Désactiver</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: 500;">Quiz: Conjugaison présent</td>
                                <td>Français 6ème</td>
                                <td>5</td>
                                <td>123</td>
                                <td style="font-weight: 600; color: #10B981;">82%</td>
                                <td><span class="status-badge active">Actif</span></td>
                                <td>
                                    <button class="btn btn-secondary btn-sm">Modifier</button>
                                    <button class="btn btn-danger btn-sm">Désactiver</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: 500;">Quiz: Les 10 régions</td>
                                <td>Géographie 6ème</td>
                                <td>10</td>
                                <td>89</td>
                                <td style="font-weight: 600; color: #F59E0B;">65%</td>
                                <td><span class="status-badge pending">En révision</span></td>
                                <td>
                                    <button class="btn btn-secondary btn-sm">Modifier</button>
                                    <button class="btn btn-success btn-sm">Activer</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `;

                document.getElementById('quizzes-table').innerHTML = quizzesHtml;
            } catch (error) {
                console.error('Erreur chargement quizzes:', error);
                document.getElementById('quizzes-table').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement</p>';
            }
        }

        // Load Resources Data
        async function loadResourcesData() {
            try {
                // Simulate resources data
                const resourcesHtml = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Titre Ressource</th>
                                <th>Type</th>
                                <th>Matière</th>
                                <th>Taille</th>
                                <th>Téléchargements</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="font-weight: 500;">Manuel Mathématiques 6ème</td>
                                <td>📚 PDF</td>
                                <td>Mathématiques</td>
                                <td>2.5 MB</td>
                                <td>234</td>
                                <td><span class="status-badge active">Actif</span></td>
                                <td>
                                    <button class="btn btn-secondary btn-sm">Modifier</button>
                                    <button class="btn btn-info btn-sm">Télécharger</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="font-weight: 500;">Vidéo: Les fractions</td>
                                <td>🎥 MP4</td>
                                <td>Mathématiques</td>
                                <td>15.2 MB</td>
                                <td>189</td>
                                <td><span class="status-badge active">Actif</span></td>
                                <td>
                                    <button class="btn btn-secondary btn-sm">Modifier</button>
                                    <button class="btn btn-info btn-sm">Visionner</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `;

                document.getElementById('resources-table').innerHTML = resourcesHtml;
            } catch (error) {
                console.error('Erreur chargement resources:', error);
                document.getElementById('resources-table').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement</p>';
            }
        }

        // Payments Data
        async function loadPaymentsData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/payments`);
                const data = await response.json();

                if (data.success) {
                    const paymentsHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID Transaction</th>
                                    <th>Famille</th>
                                    <th>Montant</th>
                                    <th>Méthode</th>
                                    <th>Plan</th>
                                    <th>Statut</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.transactions.map(tx => `
                                    <tr>
                                        <td style="font-family: monospace; font-size: 0.75rem;">${tx.id}</td>
                                        <td style="font-weight: 500;">${tx.familyName}</td>
                                        <td style="font-weight: 600; color: #10B981;">${formatCurrency(tx.amount)}</td>
                                        <td>${getPaymentMethodLabel(tx.method)}</td>
                                        <td>${tx.planName}</td>
                                        <td>
                                            <span class="status-badge ${tx.status}">${getStatusLabel(tx.status)}</span>
                                        </td>
                                        <td style="font-size: 0.75rem;">${formatDate(tx.transactionDate)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    document.getElementById('payments-table').innerHTML = paymentsHtml;
                }
            } catch (error) {
                console.error('Erreur chargement payments:', error);
                document.getElementById('payments-table').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement</p>';
            }
        }

        // Analytics Data
        async function loadAnalyticsData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/analytics`);
                const data = await response.json();

                if (data.success) {
                    // Graphique de croissance
                    const maxUsers = Math.max(...data.data.userGrowth.map(item => item.users));
                    const chartHtml = data.data.userGrowth.map(item => `
                        <div class="chart-bar" style="height: ${(item.users / maxUsers) * 200}px;" title="${item.users} utilisateurs en ${item.month}">
                            <div class="chart-label">${item.month.substring(0, 3)}</div>
                        </div>
                    `).join('');

                    document.getElementById('user-growth-chart').innerHTML = chartHtml;

                    // Statistiques régionales
                    const regionalHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Région</th>
                                    <th>Familles</th>
                                    <th>Revenus</th>
                                    <th>Moyenne par famille</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.regionalStats.map(region => `
                                    <tr>
                                        <td style="font-weight: 500;">${region.region}</td>
                                        <td>${region.families}</td>
                                        <td style="font-weight: 600; color: #10B981;">${formatCurrency(region.revenue)}</td>
                                        <td>${formatCurrency(Math.round(region.revenue / region.families))}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    document.getElementById('regional-stats').innerHTML = regionalHtml;
                }
            } catch (error) {
                console.error('Erreur chargement analytics:', error);
                document.getElementById('user-growth-chart').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement</p>';
                document.getElementById('regional-stats').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement</p>';
            }
        }

        // Settings Data
        async function loadSettingsData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/settings`);
                const data = await response.json();

                if (data.success) {
                    const settings = data.data;
                    const settingsHtml = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                            <div>
                                <h3 style="margin-bottom: 1rem; color: #1F2937;">Informations plateforme</h3>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Nom du site</label>
                                    <input type="text" value="${settings.platform.siteName}" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Slogan</label>
                                    <input type="text" value="${settings.platform.tagline}" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email de support</label>
                                    <input type="email" value="${settings.platform.supportEmail}" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                </div>
                            </div>

                            <div>
                                <h3 style="margin-bottom: 1rem; color: #1F2937;">Tarification</h3>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Plan Basique (FCFA)</label>
                                    <input type="number" value="${settings.pricing.basicMonthly}" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Plan Premium (FCFA)</label>
                                    <input type="number" value="${settings.pricing.premiumMonthly}" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Plan Famille Annuel (FCFA)</label>
                                    <input type="number" value="${settings.pricing.familyYearly}" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                </div>
                            </div>

                            <div>
                                <h3 style="margin-bottom: 1rem; color: #1F2937;">Fonctionnalités</h3>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" ${settings.features.claudinePointsEnabled ? 'checked' : ''} style="margin-right: 0.5rem;">
                                        Points Claudine activés
                                    </label>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" ${settings.features.achievementsEnabled ? 'checked' : ''} style="margin-right: 0.5rem;">
                                        Récompenses activées
                                    </label>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Durée d'essai (jours)</label>
                                    <input type="number" value="${settings.features.trialDurationDays}" style="width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 6px;">
                                </div>
                            </div>
                        </div>
                    `;

                    const settingsForm = document.getElementById('settings-form');
                    if (settingsForm) {
                        settingsForm.innerHTML = settingsHtml;
                    } else {
                        console.warn('Element settings-form non trouvé');
                    }
                }
            } catch (error) {
                console.error('Erreur chargement settings:', error);
                const settingsForm = document.getElementById('settings-form');
                if (settingsForm) {
                    settingsForm.innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement</p>';
                }
            }
        }

        // Free Modules Data
        async function loadFreeModulesData() {
            try {
                if (USE_MOCK_DATA) {
                    console.log('✅ Section Modules gratuits chargée (mode simulation)');
                    
                    // Afficher du contenu simulé visible
                    const freeModulesContainer = document.querySelector('#free-modules-section .section-content');
                    if (freeModulesContainer) {
                        freeModulesContainer.innerHTML = `
                            <div style="padding: 2rem; text-align: center; background: rgba(255,255,255,0.1); border-radius: 12px; margin: 1rem 0;">
                                <h3 style="color: #1F2937; margin-bottom: 1rem;">🆓 Modules Gratuits (Mode Démo)</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                                    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <h4 style="color: #1F2937;">📚 Mathématiques de base</h4>
                                        <p style="color: #6B7280;">Calcul, géométrie, algèbre</p>
                                        <div style="background: #10B981; color: white; padding: 0.5rem; border-radius: 4px; margin-top: 1rem;">✅ Actif</div>
                                    </div>
                                    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <h4 style="color: #1F2937;">🇫🇷 Français niveau 1</h4>
                                        <p style="color: #6B7280;">Grammaire, conjugaison</p>
                                        <div style="background: #10B981; color: white; padding: 0.5rem; border-radius: 4px; margin-top: 1rem;">✅ Actif</div>
                                    </div>
                                    <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <h4 style="color: #1F2937;">🔬 Sciences découverte</h4>
                                        <p style="color: #6B7280;">Biologie, physique-chimie</p>
                                        <div style="background: #10B981; color: white; padding: 0.5rem; border-radius: 4px; margin-top: 1rem;">✅ Actif</div>
                                    </div>
                                </div>
                                <p style="color: #6B7280; font-style: italic;">
                                    🎯 3 modules gratuits disponibles en permanence<br>
                                    Interface prête pour la gestion en production !
                                </p>
                            </div>
                        `;
                    }
                    return;
                }
                
                const response = await fetch(`${API_BASE}/api/admin/free-modules`);
                const data = await response.json();

                if (data.success) {
                    const freeModulesHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Matière</th>
                                    <th>Leçons gratuites</th>
                                    <th>Quiz gratuits</th>
                                    <th>Niveau d'accès</th>
                                    <th>Dernière modification</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.freeModules.map(module => `
                                    <tr>
                                        <td style="font-weight: 500;">${module.subject}</td>
                                        <td>${module.freeLessons}</td>
                                        <td>${module.freeQuizzes}</td>
                                        <td>
                                            <span class="status-badge ${module.accessLevel}">${module.accessLevel}</span>
                                        </td>
                                        <td style="font-size: 0.75rem; color: #6B7280;">${formatDate(module.lastModified)}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" onclick="editFreeModule('${module.subjectId}')">Modifier</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    document.getElementById('free-modules-table').innerHTML = freeModulesHtml;
                }
            } catch (error) {
                console.error('Erreur chargement free modules:', error);
                document.getElementById('free-modules-table').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement des modules gratuits</p>';
            }
        }

        // Trial Management Data
        async function loadTrialManagementData() {
            try {
                // Load trial statistics
                const statsResponse = await fetch(`${API_BASE}/api/admin/trial-stats`);
                const statsData = await statsResponse.json();

                if (statsData.success) {
                    document.getElementById('total-extensions').textContent = statsData.data.totalExtensions;
                    document.getElementById('avg-extension-days').textContent = statsData.data.averageExtensionDays;
                    document.getElementById('active-extensions').textContent = statsData.data.activeExtensions;
                }

                // Load trial extensions history
                const historyResponse = await fetch(`${API_BASE}/api/admin/trial-history`);
                const historyData = await historyResponse.json();

                if (historyData.success) {
                    const historyHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Famille</th>
                                    <th>Jours étendus</th>
                                    <th>Nouvelle expiration</th>
                                    <th>Raison</th>
                                    <th>Date d'extension</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${historyData.data.extensions.map(ext => `
                                    <tr>
                                        <td style="font-weight: 500;">${ext.familyName}</td>
                                        <td style="font-weight: 600; color: #10B981;">+${ext.daysExtended}</td>
                                        <td style="font-size: 0.875rem;">${formatDate(ext.newExpirationDate)}</td>
                                        <td style="font-size: 0.875rem;">${ext.reason}</td>
                                        <td style="font-size: 0.75rem; color: #6B7280;">${formatDate(ext.extensionDate)}</td>
                                        <td>
                                            <span class="status-badge ${ext.status}">${getStatusLabel(ext.status)}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    document.getElementById('trial-history-table').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('Erreur chargement trial management:', error);
                document.getElementById('trial-history-table').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement de l\'historique</p>';
            }
        }

        // Extend Trial Function
        async function extendTrial() {
            const familyId = document.getElementById('familyId').value;
            const trialDays = document.getElementById('newTrialDays').value;
            const reason = document.getElementById('trialReason').value;
            const resultDiv = document.getElementById('trial-extension-result');

            if (!familyId || !trialDays || !reason) {
                showTrialResult('❌ Veuillez remplir tous les champs', 'error');
                return;
            }

            try {
                showTrialResult('⏳ Extension de l\'essai en cours...', 'info');

                const response = await fetch(`${API_BASE}/api/admin/users/${familyId}/trial`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        trialDays: parseInt(trialDays),
                        reason: reason
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showTrialResult(
                        `✅ Essai étendu avec succès !<br>
                        Famille ID: ${data.data.userId}<br>
                        Nouveaux jours: ${data.data.trialDaysUpdated}<br>
                        Nouvelle expiration: ${formatDate(data.data.newExpirationDate)}`, 
                        'success'
                    );

                    // Reset form
                    document.getElementById('familyId').value = '';
                    document.getElementById('newTrialDays').value = '14';
                    document.getElementById('trialReason').value = '';

                    // Reload trial management data
                    await loadTrialManagementData();
                } else {
                    showTrialResult(`❌ Erreur: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Erreur extension essai:', error);
                showTrialResult('❌ Erreur de connexion au serveur', 'error');
            }
        }

        // Show trial extension result
        function showTrialResult(message, type) {
            const resultDiv = document.getElementById('trial-extension-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = message;
            
            if (type === 'success') {
                resultDiv.style.backgroundColor = '#D1FAE5';
                resultDiv.style.color = '#065F46';
                resultDiv.style.border = '1px solid #A7F3D0';
            } else if (type === 'error') {
                resultDiv.style.backgroundColor = '#FEE2E2';
                resultDiv.style.color = '#991B1B';
                resultDiv.style.border = '1px solid #FECACA';
            } else {
                resultDiv.style.backgroundColor = '#DBEAFE';
                resultDiv.style.color = '#1E40AF';
                resultDiv.style.border = '1px solid #93C5FD';
            }

            // Auto-hide after 5 seconds for non-error messages
            if (type !== 'error') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Save Free Module Settings
        async function saveFreeModuleSettings() {
            const settings = {
                maxFreeLessons: parseInt(document.getElementById('maxFreeLessons').value),
                maxFreeQuizzes: parseInt(document.getElementById('maxFreeQuizzes').value),
                durationLimit: parseInt(document.getElementById('durationLimit').value),
                allowProgressTracking: document.getElementById('allowProgressTracking').checked
            };

            try {
                const response = await fetch(`${API_BASE}/api/admin/free-modules/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.success) {
                    // Show success message
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = '✅ Sauvegardé !';
                    button.style.backgroundColor = '#10B981';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.backgroundColor = '';
                    }, 2000);
                } else {
                    alert('❌ Erreur lors de la sauvegarde: ' + data.message);
                }
            } catch (error) {
                console.error('Erreur sauvegarde settings:', error);
                alert('❌ Erreur de connexion au serveur');
            }
        }

        // Edit Free Module
        async function editFreeModule(subjectId) {
            // This could open a modal or navigate to an edit page
            alert(`Edition du module ${subjectId} - Fonctionnalité à implémenter`);
        }

        // Communication Data
        async function loadCommunicationData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/messages/history`);
                const data = await response.json();

                if (data.success) {
                    const historyHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Destinataires</th>
                                    <th>Objet</th>
                                    <th>Type</th>
                                    <th>Statut</th>
                                    <th>Taux d'ouverture</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.messages.map(msg => `
                                    <tr>
                                        <td style="font-size: 0.75rem;">${formatDate(msg.sentDate)}</td>
                                        <td>${msg.recipientsCount} abonnés</td>
                                        <td style="font-weight: 500;">${msg.subject}</td>
                                        <td>
                                            <span class="status-badge ${msg.type}">${msg.type}</span>
                                        </td>
                                        <td>
                                            <span class="status-badge ${msg.status}">${getStatusLabel(msg.status)}</span>
                                        </td>
                                        <td style="color: #10B981; font-weight: 600;">${msg.openRate}%</td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" onclick="viewMessageDetails('${msg.id}')">Détails</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    document.getElementById('message-history-table').innerHTML = historyHtml;
                }
            } catch (error) {
                console.error('Erreur chargement communication:', error);
                document.getElementById('message-history-table').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement</p>';
            }
        }

        // Send Message
        async function sendMessage() {
            const messageData = {
                recipients: document.getElementById('messageRecipients').value,
                type: document.getElementById('messageType').value,
                subject: document.getElementById('messageSubject').value,
                content: document.getElementById('messageContent').value,
                scheduled: document.getElementById('scheduleMessage').checked
            };

            if (!messageData.subject || !messageData.content) {
                showMessageResult('❌ Veuillez remplir l\'objet et le contenu', 'error');
                return;
            }

            try {
                showMessageResult('📤 Envoi du message en cours...', 'info');

                const response = await fetch(`${API_BASE}/api/admin/messages/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessageResult(`✅ Message envoyé avec succès à ${data.data.sentCount} familles !`, 'success');
                    
                    // Reset form
                    document.getElementById('messageSubject').value = '';
                    document.getElementById('messageContent').value = '';
                    
                    // Reload message history
                    await loadCommunicationData();
                } else {
                    showMessageResult(`❌ Erreur: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Erreur envoi message:', error);
                showMessageResult('❌ Erreur de connexion au serveur', 'error');
            }
        }

        // Preview Message
        function previewMessage() {
            const subject = document.getElementById('messageSubject').value;
            const content = document.getElementById('messageContent').value;
            
            if (!subject || !content) {
                alert('⚠️ Veuillez remplir l\'objet et le contenu pour prévisualiser');
                return;
            }

            const previewWindow = window.open('', '_blank', 'width=600,height=400');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>Aperçu du message</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 2rem; background: #f5f5f5; }
                        .email-preview { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .subject { font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; color: #333; }
                        .content { line-height: 1.6; color: #555; }
                    </style>
                </head>
                <body>
                    <div class="email-preview">
                        <div class="subject">${subject}</div>
                        <div class="content">${content.replace(/\n/g, '<br>')}</div>
                    </div>
                </body>
                </html>
            `);
        }

        // Show message result
        function showMessageResult(message, type) {
            const resultDiv = document.getElementById('message-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = message;
            
            if (type === 'success') {
                resultDiv.style.backgroundColor = '#D1FAE5';
                resultDiv.style.color = '#065F46';
                resultDiv.style.border = '1px solid #A7F3D0';
            } else if (type === 'error') {
                resultDiv.style.backgroundColor = '#FEE2E2';
                resultDiv.style.color = '#991B1B';
                resultDiv.style.border = '1px solid #FECACA';
            } else {
                resultDiv.style.backgroundColor = '#DBEAFE';
                resultDiv.style.color = '#1E40AF';
                resultDiv.style.border = '1px solid #93C5FD';
            }

            if (type !== 'error') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Reports Data
        async function loadReportsData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/scheduled-reports`);
                const data = await response.json();

                if (data.success) {
                    const reportsHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Fréquence</th>
                                    <th>Format</th>
                                    <th>Dernière exécution</th>
                                    <th>Prochaine exécution</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.reports.map(report => `
                                    <tr>
                                        <td style="font-weight: 500;">${report.type}</td>
                                        <td>${report.frequency}</td>
                                        <td style="text-transform: uppercase;">${report.format}</td>
                                        <td style="font-size: 0.75rem;">${formatDate(report.lastRun)}</td>
                                        <td style="font-size: 0.75rem;">${formatDate(report.nextRun)}</td>
                                        <td>
                                            <span class="status-badge ${report.status}">${getStatusLabel(report.status)}</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" onclick="runReport('${report.id}')">▶️ Exécuter</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    document.getElementById('scheduled-reports-table').innerHTML = reportsHtml;
                }
            } catch (error) {
                console.error('Erreur chargement reports:', error);
                document.getElementById('scheduled-reports-table').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement</p>';
            }
        }

        // Generate Report
        async function generateReport() {
            const reportData = {
                type: document.getElementById('reportType').value,
                period: document.getElementById('reportPeriod').value,
                format: document.getElementById('reportFormat').value
            };

            try {
                showReportResult('📊 Génération du rapport en cours...', 'info');

                const response = await fetch(`${API_BASE}/api/admin/reports/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reportData)
                });

                const data = await response.json();

                if (data.success) {
                    showReportResult(`✅ Rapport généré avec succès ! <a href="${data.data.downloadUrl}" target="_blank" style="color: #10B981; text-decoration: underline;">📥 Télécharger</a>`, 'success');
                } else {
                    showReportResult(`❌ Erreur: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Erreur génération rapport:', error);
                showReportResult('❌ Erreur de connexion au serveur', 'error');
            }
        }

        // Show report result
        function showReportResult(message, type) {
            const resultDiv = document.getElementById('report-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = message;
            
            if (type === 'success') {
                resultDiv.style.backgroundColor = '#D1FAE5';
                resultDiv.style.color = '#065F46';
                resultDiv.style.border = '1px solid #A7F3D0';
            } else if (type === 'error') {
                resultDiv.style.backgroundColor = '#FEE2E2';
                resultDiv.style.color = '#991B1B';
                resultDiv.style.border = '1px solid #FECACA';
            } else {
                resultDiv.style.backgroundColor = '#DBEAFE';
                resultDiv.style.color = '#1E40AF';
                resultDiv.style.border = '1px solid #93C5FD';
            }

            if (type !== 'error') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 8000);
            }
        }

        // System Monitoring Data
        async function loadSystemMonitoringData() {
            try {
                // Load system health
                const healthResponse = await apiRequest(`${API_BASE}/api/admin/system/health`);
                const healthData = await healthResponse.json();

                if (healthData.success) {
                    const health = healthData.data;
                    document.getElementById('uptime-display').textContent = formatUptime(health.uptime);
                    document.getElementById('cpu-usage').textContent = health.cpu;
                    document.getElementById('memory-usage').textContent = health.memory;
                    document.getElementById('error-count').textContent = health.errors;

                    // Update server status indicator
                    const statusIcon = document.getElementById('server-status');
                    if (health.status === 'healthy') {
                        statusIcon.textContent = '🟢';
                    } else if (health.status === 'warning') {
                        statusIcon.textContent = '🟡';
                    } else {
                        statusIcon.textContent = '🔴';
                    }
                }

                // Load security status
                await loadSecurityStatus();

                // Load performance metrics
                await loadPerformanceMetrics();

                // Load system logs
                const logsResponse = await fetch(`${API_BASE}/api/admin/system/logs`);
                const logsData = await logsResponse.json();

                if (logsData.success) {
                    const logsHtml = logsData.data.logs.map(log => {
                        const levelColor = {
                            'INFO': '#10B981',
                            'WARN': '#F59E0B',
                            'ERROR': '#EF4444',
                            'DEBUG': '#6B7280'
                        };
                        
                        return `<div style="margin-bottom: 0.25rem;">
                            <span style="color: ${levelColor[log.level] || '#F3F4F6'};">[${log.timestamp}]</span>
                            <span style="color: ${levelColor[log.level] || '#F3F4F6'}; font-weight: bold;">${log.level}</span>
                            <span style="color: #F3F4F6;">${log.message}</span>
                        </div>`;
                    }).join('');

                    document.getElementById('system-logs').innerHTML = logsHtml;
                }

                // Load backup status
                const backupResponse = await fetch(`${API_BASE}/api/admin/system/backups`);
                const backupData = await backupResponse.json();

                if (backupData.success) {
                    const backupsHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Dernière sauvegarde</th>
                                    <th>Taille</th>
                                    <th>Statut</th>
                                    <th>Prochaine</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${backupData.data.backups.map(backup => `
                                    <tr>
                                        <td style="font-weight: 500;">${backup.type}</td>
                                        <td style="font-size: 0.75rem;">${formatDate(backup.lastBackup)}</td>
                                        <td>${formatFileSize(backup.size)}</td>
                                        <td>
                                            <span class="status-badge ${backup.status}">${getStatusLabel(backup.status)}</span>
                                        </td>
                                        <td style="font-size: 0.75rem;">${formatDate(backup.nextBackup)}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" onclick="downloadBackup('${backup.id}')">⬇️ Télécharger</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    document.getElementById('backup-status-table').innerHTML = backupsHtml;
                }
            } catch (error) {
                console.error('Erreur chargement monitoring:', error);
                document.getElementById('system-logs').innerHTML = '<div style="color: #EF4444;">❌ Erreur de chargement des logs</div>';
            }
        }

        // Refresh Logs
        async function refreshLogs() {
            document.getElementById('system-logs').innerHTML = '<div class="loading" style="color: #F3F4F6;"></div> Actualisation des logs...';
            await loadSystemMonitoringData();
        }

        // Trigger Backup
        async function triggerBackup() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/system/backup`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    alert('✅ Sauvegarde lancée avec succès !');
                    await loadSystemMonitoringData();
                } else {
                    alert('❌ Erreur: ' + data.message);
                }
            } catch (error) {
                console.error('Erreur backup:', error);
                alert('❌ Erreur de connexion au serveur');
            }
        }

        // Utility functions for monitoring
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${days}j ${hours}h ${minutes}m`;
        }

        function formatFileSize(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Additional utility functions
        function viewMessageDetails(messageId) {
            alert(`Détails du message ${messageId} - Fonctionnalité à implémenter`);
        }

        function runReport(reportId) {
            alert(`Exécution du rapport ${reportId} - Fonctionnalité à implémenter`);
        }

        function scheduleNewReport() {
            alert('Planification d\'un nouveau rapport - Fonctionnalité à implémenter');
        }

        function downloadBackup(backupId) {
            alert(`Téléchargement de la sauvegarde ${backupId} - Fonctionnalité à implémenter`);
        }

        // Security Status Functions
        async function loadSecurityStatus() {
            try {
                const securityResponse = await apiRequest(`${API_BASE}/api/admin/system/security`);
                const securityData = await securityResponse.json();

                if (securityData.success) {
                    const security = securityData.data;

                    // Update security stats
                    document.getElementById('banned-ips').textContent = security.bannedIPs || 0;
                    document.getElementById('ssh-attacks').textContent = security.sshAttacks || 0;
                    document.getElementById('ssl-expiry').textContent = security.sslDaysLeft || 0;
                    document.getElementById('firewall-rules').textContent = security.firewallRules || 0;

                    // Update status indicators
                    const fail2banStatus = document.getElementById('fail2ban-status');
                    fail2banStatus.textContent = security.fail2banActive ? '🟢' : '🔴';

                    const firewallStatus = document.getElementById('firewall-status');
                    firewallStatus.textContent = security.firewallActive ? '🟢' : '🔴';

                    // Update security details
                    const securityDetails = document.getElementById('security-details');
                    securityDetails.innerHTML = `
                        <div style="margin-bottom: 0.5rem;"><strong>🛡️ FAIL2BAN STATUS:</strong></div>
                        <div style="margin-left: 1rem; margin-bottom: 0.5rem;">Active jails: ${security.fail2banJails || 0}</div>
                        <div style="margin-left: 1rem; margin-bottom: 0.5rem;">Banned IPs: ${security.bannedIPs || 0}</div>

                        <div style="margin-bottom: 0.5rem;"><strong>🔐 SSL CERTIFICATE:</strong></div>
                        <div style="margin-left: 1rem; margin-bottom: 0.5rem;">Expires in: ${security.sslDaysLeft || 0} days</div>
                        <div style="margin-left: 1rem; margin-bottom: 0.5rem;">Issuer: ${security.sslIssuer || 'Let\'s Encrypt'}</div>

                        <div style="margin-bottom: 0.5rem;"><strong>🔥 FIREWALL STATUS:</strong></div>
                        <div style="margin-left: 1rem; margin-bottom: 0.5rem;">UFW Status: ${security.firewallActive ? 'Active' : 'Inactive'}</div>
                        <div style="margin-left: 1rem; margin-bottom: 0.5rem;">Active rules: ${security.firewallRules || 0}</div>

                        <div style="margin-bottom: 0.5rem;"><strong>🚨 RECENT THREATS:</strong></div>
                        ${security.recentThreats ? security.recentThreats.map(threat =>
                            `<div style="margin-left: 1rem; margin-bottom: 0.25rem; color: #EF4444;">${threat}</div>`
                        ).join('') : '<div style="margin-left: 1rem; color: #10B981;">No recent threats detected</div>'}
                    `;
                }
            } catch (error) {
                console.error('Erreur chargement sécurité:', error);
                document.getElementById('security-details').innerHTML = '<div style="color: #EF4444;">❌ Erreur de chargement du statut sécurité</div>';
            }
        }

        async function refreshSecurityStatus() {
            document.getElementById('security-details').innerHTML = '<div class="loading" style="color: #F3F4F6;"></div> Actualisation du statut sécurité...';
            await loadSecurityStatus();
        }

        // Performance Metrics Functions
        async function loadPerformanceMetrics() {
            try {
                const timeRange = document.getElementById('metricsTimeRange')?.value || '24h';
                const metricsResponse = await apiRequest(`${API_BASE}/api/admin/system/metrics?range=${timeRange}`);
                const metricsData = await metricsResponse.json();

                if (metricsData.success) {
                    const metrics = metricsData.data;

                    // Update performance stats
                    document.getElementById('web-requests').textContent = metrics.totalRequests || 0;
                    document.getElementById('unique-visitors').textContent = metrics.uniqueVisitors || 0;
                    document.getElementById('avg-response-time').textContent = (metrics.avgResponseTime || 0).toFixed(3);
                    document.getElementById('http-errors').textContent = metrics.httpErrors || 0;

                    // Update performance chart
                    const chartData = metrics.chartData || [];
                    const chartHtml = `
                        <div style="margin-bottom: 1rem;"><strong>📊 TRAFIC LAST ${timeRange.toUpperCase()}:</strong></div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin-bottom: 1rem;">
                            ${chartData.slice(0, 12).map(data => `
                                <div style="text-align: center; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: #9CA3AF;">${data.time}</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #10B981;">${data.requests}</div>
                                    <div style="font-size: 0.75rem; color: #6B7280;">req</div>
                                </div>
                            `).join('')}
                        </div>

                        <div style="margin-bottom: 0.5rem;"><strong>🔍 TOP PAGES:</strong></div>
                        ${metrics.topPages ? metrics.topPages.map(page =>
                            `<div style="margin-left: 1rem; margin-bottom: 0.25rem; display: flex; justify-content: space-between;">
                                <span>${page.path}</span>
                                <span style="color: #10B981; font-weight: bold;">${page.hits} hits</span>
                            </div>`
                        ).join('') : '<div style="margin-left: 1rem; color: #6B7280;">No data available</div>'}

                        <div style="margin-top: 1rem; margin-bottom: 0.5rem;"><strong>🌍 TOP IPS:</strong></div>
                        ${metrics.topIPs ? metrics.topIPs.map(ip =>
                            `<div style="margin-left: 1rem; margin-bottom: 0.25rem; display: flex; justify-content: space-between;">
                                <span>${ip.address}</span>
                                <span style="color: #3B82F6; font-weight: bold;">${ip.requests} req</span>
                            </div>`
                        ).join('') : '<div style="margin-left: 1rem; color: #6B7280;">No data available</div>'}
                    `;

                    document.getElementById('performance-chart').innerHTML = chartHtml;
                }
            } catch (error) {
                console.error('Erreur chargement métriques:', error);
                document.getElementById('performance-chart').innerHTML = '<div style="color: #EF4444;">❌ Erreur de chargement des métriques</div>';
            }
        }

        async function refreshPerformanceMetrics() {
            document.getElementById('performance-chart').innerHTML = '<div class="loading" style="color: #F3F4F6;"></div> Actualisation des métriques...';
            await loadPerformanceMetrics();
        }

        // Roles Management Data
        async function loadRolesManagementData() {
            try {
                if (USE_MOCK_DATA) {
                    // Utiliser des données simulées
                    const mockData = {
                        success: true,
                        data: {
                            counts: {
                                admin: 3,
                                teacher: 24,
                                moderator: 8,
                                validator: 12
                            }
                        }
                    };
                    
                    // Update role counts avec données simulées
                    document.getElementById('admin-count').textContent = mockData.data.counts.admin;
                    document.getElementById('teacher-count').textContent = mockData.data.counts.teacher;
                    document.getElementById('moderator-count').textContent = mockData.data.counts.moderator;
                    document.getElementById('validator-count').textContent = mockData.data.counts.validator;
                    
                    console.log('✅ Données de rôles chargées (mode simulation)');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/api/admin/roles`);
                const data = await response.json();

                if (data.success) {
                    // Update role counts
                    document.getElementById('admin-count').textContent = data.data.counts.admin;
                    document.getElementById('teacher-count').textContent = data.data.counts.teacher;
                    document.getElementById('moderator-count').textContent = data.data.counts.moderator;
                    document.getElementById('validator-count').textContent = data.data.counts.validator;

                    // Load roles table
                    const rolesHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Rôle</th>
                                    <th>Niveau</th>
                                    <th>Utilisateurs</th>
                                    <th>Permissions clés</th>
                                    <th>Créé le</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.roles.map(role => `
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span>${role.icon}</span>
                                                <div>
                                                    <div style="font-weight: 500;">${role.name}</div>
                                                    <div style="font-size: 0.75rem; color: #6B7280;">${role.description}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge ${role.level <= 2 ? 'danger' : role.level <= 4 ? 'warning' : 'secondary'}">
                                                Niveau ${role.level}
                                            </span>
                                        </td>
                                        <td style="font-weight: 600; color: #10B981;">${role.userCount}</td>
                                        <td>
                                            <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                                ${role.keyPermissions.map(perm => `<span style="background: #F3F4F6; padding: 0.125rem 0.375rem; border-radius: 4px; font-size: 0.625rem;">${perm}</span>`).join('')}
                                            </div>
                                        </td>
                                        <td style="font-size: 0.75rem; color: #6B7280;">${formatDate(role.createdAt)}</td>
                                        <td>
                                            <span class="status-badge ${role.status}">${getStatusLabel(role.status)}</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" onclick="editRole('${role.id}')">✏️ Modifier</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    document.getElementById('roles-table').innerHTML = rolesHtml;
                }
            } catch (error) {
                console.error('Erreur chargement roles:', error);
                document.getElementById('roles-table').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement des rôles</p>';
            }
        }

        // Staff Management Data
        async function loadStaffManagementData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/staff`);
                const data = await response.json();

                if (data.success) {
                    // Update staff counts
                    document.getElementById('total-staff').textContent = data.data.stats.total;
                    document.getElementById('active-staff-today').textContent = data.data.stats.activeToday;
                    document.getElementById('staff-in-training').textContent = data.data.stats.inTraining;
                    document.getElementById('staff-evaluations').textContent = data.data.stats.pendingEvaluations;

                    // Load staff directory
                    const staffHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Personnel</th>
                                    <th>Rôle</th>
                                    <th>Spécialité</th>
                                    <th>Région</th>
                                    <th>Performance</th>
                                    <th>Dernière activité</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.staff.map(member => `
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #10B981, #3B82F6); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.875rem;">
                                                    ${member.firstName.charAt(0)}${member.lastName.charAt(0)}
                                                </div>
                                                <div>
                                                    <div style="font-weight: 500;">${member.firstName} ${member.lastName}</div>
                                                    <div style="font-size: 0.75rem; color: #6B7280;">${member.email}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                                <span>${member.roleIcon}</span>
                                                <span>${member.roleName}</span>
                                            </div>
                                        </td>
                                        <td>${member.speciality}</td>
                                        <td>
                                            <span style="background: #F3F4F6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                                ${member.region}
                                            </span>
                                        </td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div style="width: 50px; height: 4px; background: #E5E7EB; border-radius: 2px; overflow: hidden;">
                                                    <div style="width: ${member.performanceScore}%; height: 100%; background: ${member.performanceScore >= 80 ? '#10B981' : member.performanceScore >= 60 ? '#F59E0B' : '#EF4444'};"></div>
                                                </div>
                                                <span style="font-size: 0.75rem; font-weight: 600; color: ${member.performanceScore >= 80 ? '#10B981' : member.performanceScore >= 60 ? '#F59E0B' : '#EF4444'};">
                                                    ${member.performanceScore}%
                                                </span>
                                            </div>
                                        </td>
                                        <td style="font-size: 0.75rem; color: #6B7280;">${formatDate(member.lastActivity)}</td>
                                        <td>
                                            <span class="status-badge ${member.status}">${getStatusLabel(member.status)}</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" onclick="viewStaffProfile('${member.id}')">👤 Profil</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    document.getElementById('staff-directory-table').innerHTML = staffHtml;

                    // Load performance chart
                    const performanceHtml = data.data.performance.map(dept => `
                        <div style="background: white; border: 1px solid #E5E7EB; border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <h4 style="margin: 0; font-size: 0.875rem; color: #374151;">${dept.department}</h4>
                                <span style="font-size: 0.75rem; color: #6B7280;">${dept.memberCount} membres</span>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #1F2937; margin-bottom: 0.5rem;">${dept.avgScore}%</div>
                            <div style="width: 100%; height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden;">
                                <div style="width: ${dept.avgScore}%; height: 100%; background: ${dept.avgScore >= 80 ? '#10B981' : dept.avgScore >= 60 ? '#F59E0B' : '#EF4444'};"></div>
                            </div>
                            <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.5rem;">Performance moyenne</div>
                        </div>
                    `).join('');

                    document.getElementById('staff-performance-chart').innerHTML = performanceHtml;
                }
            } catch (error) {
                console.error('Erreur chargement staff:', error);
                document.getElementById('staff-directory-table').innerHTML = '<p style="color: #EF4444;">❌ Erreur de chargement du personnel</p>';
            }
        }

        // Create New Role
        function createNewRole() {
            // Reset form to default template
            document.getElementById('roleName').value = '';
            document.getElementById('roleLevel').value = '5';
            document.getElementById('roleDescription').value = '';
            
            // Uncheck all permissions
            document.querySelectorAll('input[id^="perm-"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Save Role
        async function saveRole() {
            const roleData = {
                name: document.getElementById('roleName').value,
                level: parseInt(document.getElementById('roleLevel').value),
                description: document.getElementById('roleDescription').value,
                permissions: {}
            };

            // Collect permissions
            const permissionCategories = ['users', 'content', 'finance', 'system'];
            const permissionActions = ['read', 'create', 'edit', 'delete', 'validate', 'manage', 'reports', 'admin', 'backup', 'config'];

            permissionCategories.forEach(category => {
                roleData.permissions[category] = {};
                permissionActions.forEach(action => {
                    const checkbox = document.getElementById(`perm-${category}-${action}`);
                    if (checkbox) {
                        roleData.permissions[category][action] = checkbox.checked;
                    }
                });
            });

            if (!roleData.name || !roleData.description) {
                showRoleResult('❌ Veuillez remplir le nom et la description du rôle', 'error');
                return;
            }

            try {
                showRoleResult('💾 Sauvegarde du rôle en cours...', 'info');

                const response = await fetch(`${API_BASE}/api/admin/roles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(roleData)
                });

                const data = await response.json();

                if (data.success) {
                    showRoleResult(`✅ Rôle "${roleData.name}" créé avec succès !`, 'success');
                    resetRoleForm();
                    await loadRolesManagementData();
                } else {
                    showRoleResult(`❌ Erreur: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Erreur création rôle:', error);
                showRoleResult('❌ Erreur de connexion au serveur', 'error');
            }
        }

        // Reset Role Form
        function resetRoleForm() {
            document.getElementById('roleName').value = '';
            document.getElementById('roleLevel').value = '5';
            document.getElementById('roleDescription').value = '';
            
            document.querySelectorAll('input[id^="perm-"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Add Staff Member
        async function addStaffMember() {
            const staffData = {
                firstName: document.getElementById('staffFirstName').value,
                lastName: document.getElementById('staffLastName').value,
                email: document.getElementById('staffEmail').value,
                phone: document.getElementById('staffPhone').value,
                role: document.getElementById('staffRole').value,
                region: document.getElementById('staffRegion').value,
                speciality: document.getElementById('staffSpeciality').value,
                hireDate: document.getElementById('staffHireDate').value,
                bio: document.getElementById('staffBio').value,
                sendWelcomeEmail: document.getElementById('sendWelcomeEmail').checked
            };

            if (!staffData.firstName || !staffData.lastName || !staffData.email) {
                showStaffResult('❌ Veuillez remplir les champs obligatoires (prénom, nom, email)', 'error');
                return;
            }

            try {
                showStaffResult('👤 Ajout du membre en cours...', 'info');

                const response = await fetch(`${API_BASE}/api/admin/staff`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(staffData)
                });

                const data = await response.json();

                if (data.success) {
                    showStaffResult(`✅ ${staffData.firstName} ${staffData.lastName} ajouté(e) avec succès !`, 'success');
                    resetStaffForm();
                    await loadStaffManagementData();
                } else {
                    showStaffResult(`❌ Erreur: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Erreur ajout staff:', error);
                showStaffResult('❌ Erreur de connexion au serveur', 'error');
            }
        }

        // Reset Staff Form
        function resetStaffForm() {
            document.getElementById('staffFirstName').value = '';
            document.getElementById('staffLastName').value = '';
            document.getElementById('staffEmail').value = '';
            document.getElementById('staffPhone').value = '';
            document.getElementById('staffRole').value = 'teacher';
            document.getElementById('staffRegion').value = 'centre';
            document.getElementById('staffSpeciality').value = 'mathematics';
            document.getElementById('staffHireDate').value = '';
            document.getElementById('staffBio').value = '';
            document.getElementById('sendWelcomeEmail').checked = true;
        }

        // Show role result
        function showRoleResult(message, type) {
            const resultDiv = document.getElementById('role-creation-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = message;
            
            if (type === 'success') {
                resultDiv.style.backgroundColor = '#D1FAE5';
                resultDiv.style.color = '#065F46';
                resultDiv.style.border = '1px solid #A7F3D0';
            } else if (type === 'error') {
                resultDiv.style.backgroundColor = '#FEE2E2';
                resultDiv.style.color = '#991B1B';
                resultDiv.style.border = '1px solid #FECACA';
            } else {
                resultDiv.style.backgroundColor = '#DBEAFE';
                resultDiv.style.color = '#1E40AF';
                resultDiv.style.border = '1px solid #93C5FD';
            }

            if (type !== 'error') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Show staff result
        function showStaffResult(message, type) {
            const resultDiv = document.getElementById('staff-addition-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = message;
            
            if (type === 'success') {
                resultDiv.style.backgroundColor = '#D1FAE5';
                resultDiv.style.color = '#065F46';
                resultDiv.style.border = '1px solid #A7F3D0';
            } else if (type === 'error') {
                resultDiv.style.backgroundColor = '#FEE2E2';
                resultDiv.style.color = '#991B1B';
                resultDiv.style.border = '1px solid #FECACA';
            } else {
                resultDiv.style.backgroundColor = '#DBEAFE';
                resultDiv.style.color = '#1E40AF';
                resultDiv.style.border = '1px solid #93C5FD';
            }

            if (type !== 'error') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Additional utility functions
        function editRole(roleId) {
            alert(`Édition du rôle ${roleId} - Fonctionnalité à implémenter`);
        }

        function viewStaffProfile(staffId) {
            alert(`Profil du membre ${staffId} - Fonctionnalité à implémenter`);
        }

        function importStaffCSV() {
            alert('Import CSV du personnel - Fonctionnalité à implémenter');
        }

        function exportStaffDirectory() {
            alert('Export de l\'annuaire - Fonctionnalité à implémenter');
        }

        // Fonctions utilitaires
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR').format(amount) + ' FCFA';
        }

        // === GESTION DES LIAISONS FAMILLE-ÉTUDIANTS ===
        
        // Recherche de liaisons familiales
        function searchFamilyLinks() {
            const familySearch = document.getElementById('familySearch').value;
            const studentSearch = document.getElementById('studentSearch').value;
            const statusFilter = document.getElementById('linkStatusFilter').value;
            
            console.log('🔍 Recherche liaisons:', { familySearch, studentSearch, statusFilter });
            
            // Simuler une recherche API
            showNotification('Recherche en cours...', 'info');
            
            setTimeout(() => {
                loadFamilyLinksData({ familySearch, studentSearch, statusFilter });
                showNotification('Recherche terminée', 'success');
            }, 1000);
        }
        
        // Charger les données de liaisons
        function loadFamilyLinksData(filters = {}) {
            // Données simulées - À remplacer par un appel API réel
            const mockData = [
                {
                    familyId: 'FAM-001234',
                    familyName: 'Famille Nkoulou',
                    students: [
                        { name: 'Marie Nkoulou', level: 'Terminale A', status: 'linked' },
                        { name: 'Jean Nkoulou', level: '3ème', status: 'linked' }
                    ],
                    status: 'active',
                    lastActivity: 'Il y a 2 heures'
                },
                {
                    familyId: 'FAM-002567',
                    familyName: 'Famille Abena',
                    students: [
                        { name: 'Paul Abena', level: '1ère S', status: 'orphaned' }
                    ],
                    status: 'warning',
                    lastActivity: 'Il y a 1 jour'
                }
            ];
            
            updateFamilyLinksTable(mockData);
            updateOrphanStudentsTable();
            updateFamilyLinksStats();
        }
        
        // Mettre à jour le tableau des liaisons
        function updateFamilyLinksTable(data) {
            const tbody = document.getElementById('familyLinksTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = data.map(family => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ${family.familyName.split(' ')[1].substring(0, 2).toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${family.familyName}</div>
                                <div style="font-size: 0.875rem; color: #6B7280;">${family.familyId}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                            ${family.students.map(student => `
                                <span class="glass-badge ${student.status === 'linked' ? 'glass-badge-success' : 'glass-badge-warning'}">
                                    ${student.status === 'linked' ? '📚' : '⚠️'} ${student.name} (${student.level})${student.status === 'orphaned' ? ' - Orphelin' : ''}
                                </span>
                            `).join('')}
                        </div>
                    </td>
                    <td>
                        <span class="glass-badge ${family.status === 'active' ? 'glass-badge-success' : 'glass-badge-warning'}">
                            ${family.status === 'active' ? '✅ Actif' : '⚠️ Liaison manquante'}
                        </span>
                    </td>
                    <td>${family.lastActivity}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-outline" onclick="viewFamilyDetails('${family.familyId}')" title="Voir détails">
                                👁️
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="manageFamilyLinks('${family.familyId}')" title="Gérer liaisons">
                                🔗
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editFamily('${family.familyId}')" title="Modifier">
                                ✏️
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Mettre à jour le tableau des étudiants orphelins
        function updateOrphanStudentsTable() {
            const tbody = document.getElementById('orphanStudentsTableBody');
            if (!tbody) return;
            
            // Données simulées des étudiants orphelins
            const orphanStudents = [
                {
                    studentId: 'STU-003456',
                    name: 'Claude Kameni',
                    level: 'Terminale C',
                    registrationDate: '15 Mars 2024',
                    email: 'claude.kameni@email.com',
                    phone: '+237 696 123 456'
                },
                {
                    studentId: 'STU-004789',
                    name: 'Fatima Ousmane',
                    level: '1ère D',
                    registrationDate: '22 Mars 2024',
                    email: 'fatima.ousmane@email.com',
                    phone: '+237 677 234 567'
                }
            ];
            
            tbody.innerHTML = orphanStudents.map(student => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #4facfe, #00f2fe); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ${student.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${student.name}</div>
                                <div style="font-size: 0.875rem; color: #6B7280;">${student.studentId}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="glass-badge glass-badge-primary">${student.level}</span>
                    </td>
                    <td>${student.registrationDate}</td>
                    <td>
                        <div style="font-size: 0.875rem;">
                            <div>📧 ${student.email}</div>
                            <div>📱 ${student.phone}</div>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-success" onclick="assignToFamily('${student.studentId}')" title="Assigner à famille">
                                👨‍👩‍👧‍👦
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="createNewFamily('${student.studentId}')" title="Créer nouvelle famille">
                                ➕👨‍👩‍👧‍👦
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Mettre à jour les statistiques
        function updateFamilyLinksStats() {
            const stats = {
                totalFamilies: 248,
                totalStudents: 832,
                linkedStudents: 756,
                orphanStudents: 76
            };
            
            document.getElementById('totalFamilies').textContent = stats.totalFamilies;
            document.getElementById('totalStudents').textContent = stats.totalStudents;
            document.getElementById('linkedStudents').textContent = stats.linkedStudents;
            document.getElementById('orphanStudents').textContent = stats.orphanStudents;
        }
        
        // Actions spécifiques
        function viewFamilyDetails(familyId) {
            console.log('👁️ Voir détails famille:', familyId);
            showNotification(`Ouverture des détails de ${familyId}`, 'info');
        }
        
        function manageFamilyLinks(familyId) {
            console.log('🔗 Gérer liaisons famille:', familyId);
            showNotification(`Gestion des liaisons pour ${familyId}`, 'info');
        }
        
        function editFamily(familyId) {
            console.log('✏️ Modifier famille:', familyId);
            showNotification(`Modification de ${familyId}`, 'info');
        }
        
        function linkOrphanStudent(familyId) {
            console.log('🔗➕ Lier étudiant orphelin à:', familyId);
            showNotification(`Liaison d'étudiant orphelin à ${familyId}`, 'success');
        }
        
        function assignToFamily(studentId) {
            console.log('👨‍👩‍👧‍👦 Assigner étudiant à famille:', studentId);
            showNotification(`Assignation de ${studentId} à une famille`, 'info');
        }
        
        function createNewFamily(studentId) {
            console.log('➕👨‍👩‍👧‍👦 Créer nouvelle famille pour:', studentId);
            showNotification(`Création d'une nouvelle famille pour ${studentId}`, 'success');
        }
        
        function openLinkStudentModal() {
            console.log('➕ Ouvrir modal création liaison');
            showNotification('Ouverture du modal de création de liaison', 'info');
        }
        
        function detectOrphanedStudents() {
            console.log('⚠️ Détection des étudiants orphelins');
            showNotification('Détection des étudiants orphelins...', 'info');
            
            setTimeout(() => {
                updateOrphanStudentsTable();
                showNotification('Détection terminée - 2 orphelins trouvés', 'warning');
            }, 2000);
        }
        
        function autoLinkOrphans() {
            console.log('🤖 Liaison automatique des orphelins');
            showNotification('Liaison automatique en cours...', 'info');
            
            setTimeout(() => {
                showNotification('Liaison automatique terminée - 1 étudiant lié', 'success');
                updateFamilyLinksStats();
                updateOrphanStudentsTable();
            }, 3000);
        }
        
        // Initialisation lors du changement vers la section family-links
        function initializeFamilyLinksSection() {
            loadFamilyLinksData();
        }
        
        // === FIN GESTION LIAISONS FAMILLE-ÉTUDIANTS ===

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusLabel(status) {
            const labels = {
                active: 'Actif',
                pending: 'En attente',
                inactive: 'Inactif',
                trial: 'Essai',
                completed: 'Terminé'
            };
            return labels[status] || status;
        }

        function getSubscriptionLabel(type) {
            const labels = {
                basic: 'Basique',
                premium: 'Premium',
                trial: 'Essai',
                family: 'Famille'
            };
            return labels[type] || type;
        }

        function getPaymentMethodLabel(method) {
            const labels = {
                mtn_momo: 'MTN MoMo',
                orange_money: 'Orange Money',
                bank_transfer: 'Virement bancaire'
            };
            return labels[method] || method;
        }

        // Fonctions pour la création de comptes
        function showCreateAccountModal() {
            console.log('🔵 showCreateAccountModal() appelée');
            const modal = document.getElementById('createAccountModal');
            if (modal) {
                modal.style.display = 'block';
                console.log('✅ Modal nouveau compte affiché');
            } else {
                console.error('❌ Element createAccountModal non trouvé');
            }
            const typeStep = document.querySelector('#accountTypeStep');
            const formStep = document.querySelector('#accountFormStep');
            const previewStep = document.querySelector('#accountPreviewStep');
            
            if (typeStep) typeStep.style.display = 'block';
            if (formStep) formStep.style.display = 'none';
            if (previewStep) previewStep.style.display = 'none';
        }

        function selectAccountType(type) {
            const formStep = document.querySelector('#accountFormStep');
            const formContainer = document.querySelector('#accountForm');
            
            document.querySelector('#accountTypeStep').style.display = 'none';
            formStep.style.display = 'block';

            let formHtml = '';
            if (type === 'individual') {
                formHtml = `
                    <div class="form-group">
                        <label for="firstName">Prénom *</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Nom *</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Téléphone *</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="dateOfBirth">Date de naissance</label>
                        <input type="date" id="dateOfBirth" name="dateOfBirth">
                    </div>
                    <div class="form-group">
                        <label for="subscription">Type d'abonnement *</label>
                        <select id="subscription" name="subscription" required>
                            <option value="">Sélectionner...</option>
                            <option value="basic">Basique (5000 FCFA/mois)</option>
                            <option value="premium">Premium (8000 FCFA/mois)</option>
                            <option value="trial">Essai gratuit (7 jours)</option>
                        </select>
                    </div>
                    <input type="hidden" name="accountType" value="individual">
                `;
            } else {
                formHtml = `
                    <div class="form-group">
                        <label for="familyName">Nom de famille *</label>
                        <input type="text" id="familyName" name="familyName" required>
                    </div>
                    <div class="form-group">
                        <label for="parentFirstName">Prénom du parent *</label>
                        <input type="text" id="parentFirstName" name="parentFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="parentLastName">Nom du parent *</label>
                        <input type="text" id="parentLastName" name="parentLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Téléphone *</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="numChildren">Nombre d'enfants *</label>
                        <input type="number" id="numChildren" name="numChildren" min="1" max="10" required>
                    </div>
                    <div class="form-group">
                        <label for="subscription">Type d'abonnement *</label>
                        <select id="subscription" name="subscription" required>
                            <option value="">Sélectionner...</option>
                            <option value="family-basic">Famille Basique (12000 FCFA/mois)</option>
                            <option value="family-premium">Famille Premium (18000 FCFA/mois)</option>
                            <option value="trial">Essai gratuit (14 jours)</option>
                        </select>
                    </div>
                    <input type="hidden" name="accountType" value="family">
                `;
            }
            
            formContainer.innerHTML = formHtml;
        }

        function validateAccountForm() {
            const form = document.querySelector('#accountForm');
            const formData = new FormData(form);
            const errors = [];

            // Validation des champs obligatoires
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    errors.push(`Le champ "${field.previousElementSibling.textContent.replace(' *', '')}" est obligatoire`);
                }
            });

            // Validation email
            const email = formData.get('email');
            if (email && !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                errors.push('Format email invalide');
            }

            // Validation téléphone
            const phone = formData.get('phone');
            if (phone && !phone.match(/^[+]?[0-9\s-()]{8,}$/)) {
                errors.push('Format téléphone invalide');
            }

            if (errors.length > 0) {
                alert('Erreurs de validation:\n' + errors.join('\n'));
                return false;
            }

            showAccountPreview(formData);
            return true;
        }

        function showAccountPreview(formData) {
            const accountType = formData.get('accountType');
            const subscription = formData.get('subscription');
            
            // Génération de l'ID abonné
            const timestamp = Date.now();
            const randomNum = Math.floor(Math.random() * 100000).toString().padStart(5, '0');
            const subscriberId = accountType === 'family' ? `FAM-${randomNum}` : `IND-${randomNum}`;
            
            let previewHtml = `
                <div class="form-group">
                    <label>ID Abonné:</label>
                    <div style="font-weight: bold; color: ${accountType === 'family' ? '#10B981' : '#3B82F6'};">
                        ${subscriberId}
                    </div>
                </div>
                <div class="form-group">
                    <label>Type de compte:</label>
                    <div>${accountType === 'family' ? 'Compte Familial' : 'Compte Individuel'}</div>
                </div>
            `;

            if (accountType === 'individual') {
                previewHtml += `
                    <div class="form-group">
                        <label>Nom complet:</label>
                        <div>${formData.get('firstName')} ${formData.get('lastName')}</div>
                    </div>
                `;
            } else {
                previewHtml += `
                    <div class="form-group">
                        <label>Famille:</label>
                        <div>${formData.get('familyName')}</div>
                    </div>
                    <div class="form-group">
                        <label>Parent:</label>
                        <div>${formData.get('parentFirstName')} ${formData.get('parentLastName')}</div>
                    </div>
                    <div class="form-group">
                        <label>Nombre d'enfants:</label>
                        <div>${formData.get('numChildren')}</div>
                    </div>
                `;
            }

            previewHtml += `
                <div class="form-group">
                    <label>Email:</label>
                    <div>${formData.get('email')}</div>
                </div>
                <div class="form-group">
                    <label>Téléphone:</label>
                    <div>${formData.get('phone')}</div>
                </div>
                <div class="form-group">
                    <label>Abonnement:</label>
                    <div>${getSubscriptionLabel(subscription)}</div>
                </div>
            `;

            document.querySelector('#accountPreview').innerHTML = previewHtml;
            document.querySelector('#accountFormStep').style.display = 'none';
            document.querySelector('#accountPreviewStep').style.display = 'block';

            // Stocker les données pour la création
            window.accountCreationData = {
                subscriberId,
                accountType,
                formData: Object.fromEntries(formData)
            };
        }

        function goBackToForm() {
            document.querySelector('#accountPreviewStep').style.display = 'none';
            document.querySelector('#accountFormStep').style.display = 'block';
        }

        async function createAccount() {
            try {
                const accountData = window.accountCreationData;
                
                const response = await fetch(`${API_BASE}/api/admin/accounts/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(accountData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Compte créé avec succès!\nID Abonné: ${accountData.subscriberId}`);
                    closeModal('createAccountModal');
                    
                    // Recharger la liste des abonnés
                    if (document.querySelector('#subscribers-section').classList.contains('active')) {
                        loadSubscribersData();
                    }
                } else {
                    alert('Erreur lors de la création du compte: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur technique lors de la création du compte');
            }
        }

        // Fonctions pour la gestion des plans tarifaires
        async function loadPricingPlansData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/pricing-plans`);
                const data = await response.json();

                if (data.success) {
                    displayPricingPlans(data.data.plans);
                    updatePricingStats(data.data.stats);
                } else {
                    document.getElementById('pricing-plans-grid').innerHTML = '<p>Erreur lors du chargement des plans</p>';
                }
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('pricing-plans-grid').innerHTML = '<p>Erreur de connexion</p>';
            }
        }

        function displayPricingPlans(plans) {
            const plansGrid = document.getElementById('pricing-plans-grid');
            
            if (!plans || plans.length === 0) {
                plansGrid.innerHTML = '<p style="text-align: center; color: #6B7280;">Aucun plan tarifaire configuré</p>';
                return;
            }

            const plansHtml = plans.map(plan => {
                const featuresHtml = plan.features.map(feature => `<li>${feature}</li>`).join('');
                const priceDisplay = plan.duration === 'trial' ? 'Gratuit' : `${plan.price.toLocaleString()} FCFA`;
                const durationLabel = {
                    monthly: '/mois',
                    quarterly: '/trimestre',
                    annual: '/an',
                    trial: `(${plan.trialDays} jours)`
                }[plan.duration];

                return `
                    <div class="plan-card ${plan.featured ? 'featured' : ''}">
                        <div class="plan-status ${plan.status}">${getStatusLabel(plan.status)}</div>
                        <div class="plan-header">
                            <div class="plan-name">${plan.name}</div>
                            <div class="plan-type ${plan.type}">${plan.type === 'family' ? 'Familial' : 'Individuel'}</div>
                            <div class="plan-price">${priceDisplay}</div>
                            <div class="plan-duration">${durationLabel}</div>
                        </div>
                        <div class="plan-features">
                            <ul>${featuresHtml}</ul>
                        </div>
                        <div class="plan-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editPlan('${plan.id}')">✏️ Modifier</button>
                            <button class="btn btn-sm ${plan.status === 'active' ? 'btn-warning' : 'btn-success'}" 
                                    onclick="togglePlanStatus('${plan.id}', '${plan.status}')">
                                ${plan.status === 'active' ? '⏸️ Désactiver' : '▶️ Activer'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            plansGrid.innerHTML = plansHtml;
        }

        function updatePricingStats(stats) {
            document.getElementById('active-plans-count').textContent = stats.activePlans;
            document.getElementById('monthly-revenue-plans').textContent = formatCurrency(stats.monthlyRevenue);
            document.getElementById('total-subscribers').textContent = stats.totalSubscribers;
            document.getElementById('popular-plan').textContent = stats.popularPlan || '-';
        }

        function showCreatePlanModal() {
            console.log('🔵 showCreatePlanModal() appelée');
            const modal = document.getElementById('createPlanModal');
            if (modal) {
                modal.style.display = 'block';
                console.log('✅ Modal nouveau plan affiché');
            } else {
                console.error('❌ Element createPlanModal non trouvé');
            }
            document.getElementById('createPlanForm').reset();
            updatePlanFields();
        }

        function updatePlanFields() {
            const planType = document.getElementById('planType').value;
            const planDuration = document.getElementById('planDuration').value;
            
            // Afficher/masquer les champs spécifiques aux familles
            const familyLimits = document.getElementById('familyLimits');
            familyLimits.style.display = planType === 'family' ? 'block' : 'none';
            
            // Afficher/masquer la durée d'essai
            const trialDaysGroup = document.getElementById('trialDaysGroup');
            trialDaysGroup.style.display = planDuration === 'trial' ? 'block' : 'none';
            
            if (planDuration === 'trial') {
                document.getElementById('trialDays').setAttribute('required', 'required');
            } else {
                document.getElementById('trialDays').removeAttribute('required');
            }
        }

        function filterPlans() {
            const typeFilter = document.getElementById('planTypeFilter').value;
            const statusFilter = document.getElementById('planStatusFilter').value;
            
            const planCards = document.querySelectorAll('.plan-card');
            
            planCards.forEach(card => {
                let showCard = true;
                
                if (typeFilter) {
                    const planTypeEl = card.querySelector('.plan-type');
                    const cardType = planTypeEl.classList.contains('family') ? 'family' : 'individual';
                    if (cardType !== typeFilter) showCard = false;
                }
                
                if (statusFilter) {
                    const planStatusEl = card.querySelector('.plan-status');
                    if (!planStatusEl.classList.contains(statusFilter)) showCard = false;
                }
                
                card.style.display = showCard ? 'block' : 'none';
            });
        }

        function previewPlan() {
            const form = document.getElementById('createPlanForm');
            const formData = new FormData(form);
            
            // Validation
            const requiredFields = ['planName', 'planType', 'planCategory', 'planPrice', 'planDuration'];
            const errors = [];
            
            requiredFields.forEach(field => {
                if (!formData.get(field)) {
                    errors.push(`Le champ "${field}" est obligatoire`);
                }
            });
            
            if (formData.get('planDuration') === 'trial' && !formData.get('trialDays')) {
                errors.push('La durée d\'essai est obligatoire pour un plan d\'essai');
            }
            
            if (errors.length > 0) {
                alert('Erreurs de validation:\n' + errors.join('\n'));
                return;
            }
            
            // Créer aperçu
            const features = Array.from(form.querySelectorAll('input[name="features"]:checked')).map(cb => cb.value);
            const planData = {
                name: formData.get('planName'),
                type: formData.get('planType'),
                category: formData.get('planCategory'),
                price: parseInt(formData.get('planPrice')),
                duration: formData.get('planDuration'),
                trialDays: formData.get('trialDays'),
                features: features,
                maxChildren: formData.get('maxChildren'),
                maxDevices: formData.get('maxDevices'),
                description: formData.get('planDescription'),
                status: formData.get('planStatus'),
                featured: formData.get('planFeatured') === 'on'
            };
            
            alert(`Aperçu du plan:\n\nNom: ${planData.name}\nType: ${planData.type}\nPrix: ${planData.price} FCFA\nDurée: ${planData.duration}\nFonctionnalités: ${features.join(', ')}`);
        }

        async function createPlan() {
            const form = document.getElementById('createPlanForm');
            const formData = new FormData(form);
            
            // Collecter les fonctionnalités
            const features = Array.from(form.querySelectorAll('input[name="features"]:checked')).map(cb => cb.value);
            
            const planData = {
                name: formData.get('planName'),
                type: formData.get('planType'),
                category: formData.get('planCategory'),
                price: parseInt(formData.get('planPrice')),
                duration: formData.get('planDuration'),
                trialDays: formData.get('trialDays') ? parseInt(formData.get('trialDays')) : null,
                features: features,
                maxChildren: formData.get('maxChildren') ? parseInt(formData.get('maxChildren')) : null,
                maxDevices: formData.get('maxDevices') ? parseInt(formData.get('maxDevices')) : null,
                description: formData.get('planDescription'),
                status: formData.get('planStatus'),
                featured: formData.get('planFeatured') === 'on'
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/pricing-plans/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(planData)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Plan créé avec succès!');
                    closeModal('createPlanModal');
                    loadPricingPlansData();
                } else {
                    alert('Erreur lors de la création du plan: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur technique lors de la création du plan');
            }
        }

        async function togglePlanStatus(planId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/pricing-plans/${planId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();

                if (result.success) {
                    loadPricingPlansData();
                } else {
                    alert('Erreur lors de la mise à jour du statut');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur technique');
            }
        }

        function editPlan(planId) {
            // Pour l'instant, afficher un message
            alert(`Édition du plan ${planId} - Fonctionnalité à développer`);
        }

        // Fonctions de test des API
        async function testClaudeAPI() {
            const apiKey = document.getElementById('claudeApiKey').value;
            const model = document.getElementById('claudeModel').value;
            
            if (!apiKey) {
                alert('Veuillez saisir une clé API Claude');
                return;
            }
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: model,
                        max_tokens: 100,
                        messages: [{ role: 'user', content: 'Test de connexion API' }]
                    })
                });
                
                if (response.ok) {
                    alert('✅ Connexion Claude API réussie!');
                } else {
                    const error = await response.json();
                    alert(`❌ Erreur Claude API: ${error.error?.message || 'Erreur inconnue'}`);
                }
            } catch (error) {
                alert(`❌ Erreur de connexion: ${error.message}`);
            }
        }

        async function testOpenAI() {
            const apiKey = document.getElementById('openaiApiKey').value;
            const model = document.getElementById('openaiModel').value;
            
            if (!apiKey) {
                alert('Veuillez saisir une clé API OpenAI');
                return;
            }
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: 'Test de connexion API' }],
                        max_tokens: 50
                    })
                });
                
                if (response.ok) {
                    alert('✅ Connexion OpenAI API réussie!');
                } else {
                    const error = await response.json();
                    alert(`❌ Erreur OpenAI API: ${error.error?.message || 'Erreur inconnue'}`);
                }
            } catch (error) {
                alert(`❌ Erreur de connexion: ${error.message}`);
            }
        }

        async function testSMSAPI() {
            const apiKey = document.getElementById('lmtApiKey').value;
            const apiUrl = document.getElementById('lmtApiUrl').value;
            const senderId = document.getElementById('lmtSenderId').value;
            
            if (!apiKey || !apiUrl) {
                alert('Veuillez configurer la clé API et l\'URL LMT SMS');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/test/sms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        apiUrl: apiUrl,
                        senderId: senderId,
                        testNumber: '+237690000000'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('✅ Test SMS envoyé avec succès!');
                } else {
                    alert(`❌ Erreur SMS: ${result.message}`);
                }
            } catch (error) {
                alert(`❌ Erreur: ${error.message}`);
            }
        }

        async function testEmailSMTP() {
            const smtpHost = document.getElementById('smtpHost').value;
            const smtpPort = document.getElementById('smtpPort').value;
            const smtpUser = document.getElementById('smtpUser').value;
            const smtpPassword = document.getElementById('smtpPassword').value;
            
            if (!smtpHost || !smtpUser || !smtpPassword) {
                alert('Veuillez configurer tous les champs SMTP');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/test/email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        host: smtpHost,
                        port: smtpPort,
                        user: smtpUser,
                        password: smtpPassword,
                        testEmail: smtpUser
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('✅ Email de test envoyé avec succès!');
                } else {
                    alert(`❌ Erreur SMTP: ${result.message}`);
                }
            } catch (error) {
                alert(`❌ Erreur: ${error.message}`);
            }
        }


        // Utility functions for notifications
        function showError(message) {
            alert(`❌ Erreur: ${message}`);
        }

        function showSuccess(message) {
            alert(`✅ ${message}`);
        }

        // Get authentication token
        function getAuthToken() {
            return localStorage.getItem('claudyne_token');
        }

        // Password Change Functions
        function togglePasswordChange() {
            const form = document.getElementById('passwordChangeForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                // Clear form fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } else {
                form.style.display = 'none';
            }
        }

        function cancelPasswordChange() {
            document.getElementById('passwordChangeForm').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        async function changeAdminPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validation des champs
            if (!currentPassword || !newPassword || !confirmPassword) {
                showError('Veuillez remplir tous les champs');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('Les nouveaux mots de passe ne correspondent pas');
                return;
            }

            if (newPassword.length < 6) {
                showError('Le nouveau mot de passe doit contenir au moins 6 caractères');
                return;
            }

            try {
                const token = getAuthToken();
                if (!token) {
                    showError('Token d\'authentification manquant. Veuillez vous reconnecter.');
                    return;
                }

                const response = await fetch(`${API_BASE}/api/admin/profile/change-password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Mot de passe modifié avec succès !');
                    cancelPasswordChange();
                } else {
                    showError(data.message || 'Erreur lors de la modification du mot de passe');
                }

            } catch (error) {
                console.error('Erreur changement mot de passe:', error);
                showError('Erreur lors de la modification du mot de passe');
            }
        }
        // Fonction de sauvegarde des paramètres
        async function saveSettings() {
            const settings = {
                general: {
                    siteName: document.getElementById('siteName').value,
                    tagline: document.getElementById('tagline').value,
                    supportEmail: document.getElementById('supportEmail').value,
                    supportPhone: document.getElementById('supportPhone').value
                },
                apis: {
                    claude: {
                        apiKey: document.getElementById('claudeApiKey').value,
                        model: document.getElementById('claudeModel').value
                    },
                    openai: {
                        apiKey: document.getElementById('openaiApiKey').value,
                        model: document.getElementById('openaiModel').value,
                        temperature: parseFloat(document.getElementById('openaiTemperature').value),
                        maxTokens: parseInt(document.getElementById('openaiMaxTokens').value),
                        systemPrompt: document.getElementById('openaiSystemPrompt').value,
                        enabled: document.getElementById('openaiEnabled').checked
                    },
                    sms: {
                        apiKey: document.getElementById('lmtApiKey').value,
                        apiUrl: document.getElementById('lmtApiUrl').value,
                        senderId: document.getElementById('lmtSenderId').value,
                        cost: parseInt(document.getElementById('smsCost').value)
                    },
                    smtp: {
                        host: document.getElementById('smtpHost').value,
                        port: parseInt(document.getElementById('smtpPort').value),
                        user: document.getElementById('smtpUser').value,
                        password: document.getElementById('smtpPassword').value,
                        tls: document.getElementById('smtpTls').checked
                    }
                }
            };

            try {
                const response = await fetch(`${API_BASE}/api/admin/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                if (result.success) {
                    alert('✅ Paramètres sauvegardés avec succès!');
                } else {
                    alert(`❌ Erreur lors de la sauvegarde: ${result.message}`);
                }
            } catch (error) {
                alert(`❌ Erreur: ${error.message}`);
            }
        }

        // Fonctions pour les abonnés
        async function searchSubscribers() {
            const searchQuery = document.querySelector('#subscriberSearch').value;
            const filterType = document.querySelector('#subscriberFilter').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/subscribers/search?q=${encodeURIComponent(searchQuery)}&type=${filterType}`);
                const result = await response.json();
                
                if (result.success) {
                    displaySubscribers(result.data);
                } else {
                    alert('Erreur lors de la recherche: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur de connexion lors de la recherche');
            }
        }

        function displaySubscribers(subscribers) {
            const subscribersTable = document.getElementById('subscribers-table');
            
            if (!subscribers || subscribers.length === 0) {
                subscribersTable.innerHTML = '<p>Aucun abonné trouvé</p>';
                return;
            }

            const tableHtml = `
                <table class="glass-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>ID Abonné</th>
                            <th>Nom</th>
                            <th>Type</th>
                            <th>Statut</th>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${subscribers.map(subscriber => `
                            <tr>
                                <td>
                                    <span class="glass-badge ${subscriber.accountType === 'family' ? 'glass-badge-success' : 'glass-badge-primary'}">
                                        ${subscriber.subscriberId}
                                    </span>
                                </td>
                                <td>${subscriber.name}</td>
                                <td>${subscriber.accountType === 'family' ? 'Familial' : 'Individuel'}</td>
                                <td>
                                    <span class="glass-badge glass-badge-${subscriber.status === 'active' ? 'success' : 'warning'}">
                                        ${getStatusLabel(subscriber.status)}
                                    </span>
                                </td>
                                <td>${subscriber.email}</td>
                                <td>
                                    <button class="btn btn-sm glass-btn" onclick="editSubscriber('${subscriber.id}')">✏️ Modifier</button>
                                    <button class="btn btn-sm glass-btn glass-btn-warning" onclick="suspendSubscriber('${subscriber.id}')">⏸️ Suspendre</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            subscribersTable.innerHTML = tableHtml;
        }

        async function exportSubscribersCSV() {
            console.log('🔵 exportSubscribersCSV() appelée');
            try {
                const response = await fetch(`${API_BASE}/api/admin/subscribers/export`);
                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `abonnes_claudyne_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                window.URL.revokeObjectURL(url);
                alert('✅ Export CSV terminé!');
            } catch (error) {
                console.error('Erreur:', error);
                alert('❌ Erreur lors de l\'export CSV');
            }
        }

        function editSubscriber(subscriberId) {
            alert(`Édition de l'abonné ${subscriberId} - Fonctionnalité à développer`);
        }

        async function suspendSubscriber(subscriberId) {
            if (!confirm('Êtes-vous sûr de vouloir suspendre cet abonné ?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/subscribers/${subscriberId}/suspend`, {
                    method: 'PUT'
                });

                const result = await response.json();
                if (result.success) {
                    alert('✅ Abonné suspendu avec succès');
                    searchSubscribers(); // Recharger la liste
                } else {
                    alert('❌ Erreur: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('❌ Erreur technique');
            }
        }

        // Fonctions pour la gestion de contenu
        function showContentTab(tabName) {
            // Masquer tous les tabs
            document.querySelectorAll('.content-tab').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Masquer tous les boutons tab actifs
            document.querySelectorAll('.btn-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Afficher le tab sélectionné
            document.getElementById(tabName + '-tab').classList.add('active');
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            // Charger le contenu du tab
            loadContentTabData(tabName);
        }

        async function loadContentTabData(tabName) {
            try {
                const response = await fetch(`${API_BASE}/api/admin/content/${tabName}`);
                const result = await response.json();
                
                if (result.success) {
                    displayContentData(tabName, result.data);
                } else {
                    document.getElementById(tabName + '-content').innerHTML = 
                        '<p>Erreur lors du chargement du contenu</p>';
                }
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById(tabName + '-content').innerHTML = 
                    '<p>Erreur de connexion</p>';
            }
        }

        function displayContentData(tabType, data) {
            const container = document.getElementById(tabType + '-content');
            
            if (tabType === 'courses') {
                displayCourses(container, data);
            } else if (tabType === 'quizzes') {
                displayQuizzes(container, data);
            } else if (tabType === 'resources') {
                displayResources(container, data);
            }
        }

        function displayCourses(container, courses) {
            const coursesHtml = `
                <div class="content-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Gestion des cours</h3>
                    <button class="btn btn-primary glass-btn glass-btn-primary" onclick="showAddCourseModal()">➕ Nouveau cours</button>
                </div>
                <div class="courses-grid">
                    ${courses.map(course => `
                        <div class="glass-card" style="margin-bottom: 1rem;">
                            <h4 class="glass-text-primary">${course.title}</h4>
                            <p class="glass-text-secondary">${course.description}</p>
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button class="btn btn-sm glass-btn" onclick="editCourse('${course.id}')">✏️ Modifier</button>
                                <button class="btn btn-sm glass-btn glass-btn-warning" onclick="toggleCourseStatus('${course.id}')">
                                    ${course.status === 'active' ? '⏸️ Désactiver' : '▶️ Activer'}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = coursesHtml;
        }

        function displayQuizzes(container, quizzes) {
            const quizzesHtml = `
                <div class="content-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Gestion des quiz</h3>
                    <button class="btn btn-primary glass-btn glass-btn-primary" onclick="showAddQuizModal()">➕ Nouveau quiz</button>
                </div>
                <div class="quizzes-grid">
                    ${quizzes.map(quiz => `
                        <div class="glass-card" style="margin-bottom: 1rem;">
                            <h4 class="glass-text-primary">${quiz.title}</h4>
                            <p class="glass-text-secondary">${quiz.questions.length} questions</p>
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button class="btn btn-sm glass-btn" onclick="editQuiz('${quiz.id}')">✏️ Modifier</button>
                                <button class="btn btn-sm glass-btn glass-btn-warning" onclick="toggleQuizStatus('${quiz.id}')">
                                    ${quiz.status === 'active' ? '⏸️ Désactiver' : '▶️ Activer'}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = quizzesHtml;
        }

        function displayResources(container, resources) {
            const resourcesHtml = `
                <div class="content-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Gestion des ressources</h3>
                    <button class="btn btn-primary glass-btn glass-btn-primary" onclick="showAddResourceModal()">➕ Nouvelle ressource</button>
                </div>
                <div class="resources-grid">
                    ${resources.map(resource => `
                        <div class="glass-card" style="margin-bottom: 1rem;">
                            <h4 class="glass-text-primary">${resource.title}</h4>
                            <p class="glass-text-secondary">${resource.type} - ${resource.size}</p>
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button class="btn btn-sm glass-btn" onclick="editResource('${resource.id}')">✏️ Modifier</button>
                                <button class="btn btn-sm glass-btn glass-btn-warning" onclick="deleteResource('${resource.id}')">🗑️ Supprimer</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = resourcesHtml;
        }

        // Fonctions pour l'ajout de contenu
        function showAddCourseModal() {
            console.log('🔵 showAddCourseModal() appelée');
            const modal = document.createElement('div');
            modal.className = 'glass-modal show';
            modal.innerHTML = `
                <div class="glass-modal-content" style="max-width: 600px;">
                    <h2 class="glass-text-primary" style="margin-bottom: 1.5rem;">Ajouter un nouveau cours</h2>
                    <form id="add-course-form" onsubmit="handleAddCourse(event)">
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Titre du cours:</label>
                            <input type="text" class="glass-input" name="title" required placeholder="Ex: Introduction à la Physique">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Matière:</label>
                            <select class="glass-input" name="subject" required>
                                <option value="">Sélectionner une matière</option>
                                <option value="mathematiques">Mathématiques</option>
                                <option value="physique">Physique</option>
                                <option value="chimie">Chimie</option>
                                <option value="biologie">Biologie</option>
                                <option value="francais">Français</option>
                                <option value="anglais">Anglais</option>
                                <option value="histoire">Histoire</option>
                                <option value="geographie">Géographie</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Niveau:</label>
                            <select class="glass-input" name="level" required>
                                <option value="">Sélectionner un niveau</option>
                                <option value="6eme">6ème</option>
                                <option value="5eme">5ème</option>
                                <option value="4eme">4ème</option>
                                <option value="3eme">3ème</option>
                                <option value="2nde">2nde</option>
                                <option value="1ere">1ère</option>
                                <option value="terminale">Terminale</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Description:</label>
                            <textarea class="glass-input" name="description" rows="3" placeholder="Description du cours..."></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Contenu du cours:</label>
                            <textarea class="glass-input" name="content" rows="6" placeholder="Contenu détaillé du cours..." required></textarea>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Durée estimée (minutes):</label>
                            <input type="number" class="glass-input" name="duration" min="1" placeholder="Ex: 45">
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="glass-btn" onclick="closeModalDynamic(this)">Annuler</button>
                            <button type="submit" class="glass-btn glass-btn-primary">Créer le cours</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModalDynamic(modal);
            });
        }

        function showAddQuizModal() {
            console.log('🔵 showAddQuizModal() appelée');
            const modal = document.createElement('div');
            modal.className = 'glass-modal show';
            modal.innerHTML = `
                <div class="glass-modal-content" style="max-width: 700px;">
                    <h2 class="glass-text-primary" style="margin-bottom: 1.5rem;">Créer un nouveau quiz</h2>
                    <form id="add-quiz-form" onsubmit="handleAddQuiz(event)">
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Titre du quiz:</label>
                            <input type="text" class="glass-input" name="title" required placeholder="Ex: Quiz Physique - Forces et mouvements">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Matière:</label>
                            <select class="glass-input" name="subject" required>
                                <option value="">Sélectionner une matière</option>
                                <option value="mathematiques">Mathématiques</option>
                                <option value="physique">Physique</option>
                                <option value="chimie">Chimie</option>
                                <option value="biologie">Biologie</option>
                                <option value="francais">Français</option>
                                <option value="anglais">Anglais</option>
                                <option value="histoire">Histoire</option>
                                <option value="geographie">Géographie</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Niveau:</label>
                            <select class="glass-input" name="level" required>
                                <option value="">Sélectionner un niveau</option>
                                <option value="6eme">6ème</option>
                                <option value="5eme">5ème</option>
                                <option value="4eme">4ème</option>
                                <option value="3eme">3ème</option>
                                <option value="2nde">2nde</option>
                                <option value="1ere">1ère</option>
                                <option value="terminale">Terminale</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Description:</label>
                            <textarea class="glass-input" name="description" rows="2" placeholder="Description du quiz..."></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Durée (minutes):</label>
                            <input type="number" class="glass-input" name="duration" min="1" value="20" required>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Note de passage (%):</label>
                            <input type="number" class="glass-input" name="passing_score" min="0" max="100" value="60" required>
                        </div>
                        <div id="quiz-questions" style="margin-bottom: 1.5rem;">
                            <h3 class="glass-text-primary" style="margin-bottom: 1rem;">Questions</h3>
                            <div class="quiz-question" style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 12px;">
                                <input type="text" class="glass-input" placeholder="Question 1" style="margin-bottom: 0.5rem;" name="question_1" required>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <input type="text" class="glass-input" placeholder="Option A" name="option_1_a" required>
                                    <input type="text" class="glass-input" placeholder="Option B" name="option_1_b" required>
                                    <input type="text" class="glass-input" placeholder="Option C" name="option_1_c" required>
                                    <input type="text" class="glass-input" placeholder="Option D" name="option_1_d" required>
                                </div>
                                <select class="glass-input" name="correct_1" style="margin-top: 0.5rem;" required>
                                    <option value="">Réponse correcte</option>
                                    <option value="a">Option A</option>
                                    <option value="b">Option B</option>
                                    <option value="c">Option C</option>
                                    <option value="d">Option D</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" class="glass-btn" onclick="addQuizQuestion()" style="margin-bottom: 1rem;">Ajouter une question</button>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="glass-btn" onclick="closeModalDynamic(this)">Annuler</button>
                            <button type="submit" class="glass-btn glass-btn-primary">Créer le quiz</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModalDynamic(modal);
            });
        }

        function showAddResourceModal() {
            const modal = document.createElement('div');
            modal.className = 'glass-modal show';
            modal.innerHTML = `
                <div class="glass-modal-content" style="max-width: 600px;">
                    <h2 class="glass-text-primary" style="margin-bottom: 1.5rem;">Ajouter une nouvelle ressource</h2>
                    <form id="add-resource-form" onsubmit="handleAddResource(event)">
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Titre de la ressource:</label>
                            <input type="text" class="glass-input" name="title" required placeholder="Ex: Formules mathématiques importantes">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Type de ressource:</label>
                            <select class="glass-input" name="type" required>
                                <option value="">Sélectionner un type</option>
                                <option value="document">Document PDF</option>
                                <option value="video">Vidéo</option>
                                <option value="audio">Audio</option>
                                <option value="image">Image/Schéma</option>
                                <option value="link">Lien externe</option>
                                <option value="exercise">Exercice</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Matière:</label>
                            <select class="glass-input" name="subject" required>
                                <option value="">Sélectionner une matière</option>
                                <option value="mathematiques">Mathématiques</option>
                                <option value="physique">Physique</option>
                                <option value="chimie">Chimie</option>
                                <option value="biologie">Biologie</option>
                                <option value="francais">Français</option>
                                <option value="anglais">Anglais</option>
                                <option value="histoire">Histoire</option>
                                <option value="geographie">Géographie</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Niveau:</label>
                            <select class="glass-input" name="level" required>
                                <option value="">Sélectionner un niveau</option>
                                <option value="6eme">6ème</option>
                                <option value="5eme">5ème</option>
                                <option value="4eme">4ème</option>
                                <option value="3eme">3ème</option>
                                <option value="2nde">2nde</option>
                                <option value="1ere">1ère</option>
                                <option value="terminale">Terminale</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Description:</label>
                            <textarea class="glass-input" name="description" rows="3" placeholder="Description de la ressource..."></textarea>
                        </div>
                        <div id="file-upload-section" style="margin-bottom: 1rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">Fichier ou URL:</label>
                            <input type="text" class="glass-input" name="url" placeholder="URL du fichier ou lien externe">
                            <p class="glass-text-muted" style="font-size: 0.8rem; margin-top: 0.25rem;">Ou coller l'URL d'une ressource externe</p>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <label class="glass-text-secondary" style="display: block; margin-bottom: 0.5rem;">
                                <input type="checkbox" name="is_premium" style="margin-right: 0.5rem;">
                                Ressource premium (réservée aux abonnés)
                            </label>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="glass-btn" onclick="closeModalDynamic(this)">Annuler</button>
                            <button type="submit" class="glass-btn glass-btn-primary">Ajouter la ressource</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModalDynamic(modal);
            });
        }

        // Fonction pour fermer les modals dynamiques
        function closeModalDynamic(element) {
            const modal = element.closest('.glass-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Fonction pour ajouter une question au quiz
        let quizQuestionCount = 1;
        function addQuizQuestion() {
            quizQuestionCount++;
            const questionsContainer = document.getElementById('quiz-questions');
            const newQuestion = document.createElement('div');
            newQuestion.className = 'quiz-question';
            newQuestion.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 12px;';
            newQuestion.innerHTML = `
                <input type="text" class="glass-input" placeholder="Question ${quizQuestionCount}" style="margin-bottom: 0.5rem;" name="question_${quizQuestionCount}" required>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <input type="text" class="glass-input" placeholder="Option A" name="option_${quizQuestionCount}_a" required>
                    <input type="text" class="glass-input" placeholder="Option B" name="option_${quizQuestionCount}_b" required>
                    <input type="text" class="glass-input" placeholder="Option C" name="option_${quizQuestionCount}_c" required>
                    <input type="text" class="glass-input" placeholder="Option D" name="option_${quizQuestionCount}_d" required>
                </div>
                <select class="glass-input" name="correct_${quizQuestionCount}" style="margin-top: 0.5rem;" required>
                    <option value="">Réponse correcte</option>
                    <option value="a">Option A</option>
                    <option value="b">Option B</option>
                    <option value="c">Option C</option>
                    <option value="d">Option D</option>
                </select>
                <button type="button" class="glass-btn" style="margin-top: 0.5rem; background: rgba(239, 68, 68, 0.2);" onclick="removeQuizQuestion(this)">Supprimer cette question</button>
            `;
            questionsContainer.appendChild(newQuestion);
        }

        function removeQuizQuestion(button) {
            const questionDiv = button.closest('.quiz-question');
            if (questionDiv) {
                questionDiv.remove();
            }
        }

        // Fonctions de gestion des formulaires
        async function handleAddCourse(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const courseData = {
                title: formData.get('title'),
                subject: formData.get('subject'),
                level: formData.get('level'),
                description: formData.get('description'),
                content: formData.get('content'),
                duration: formData.get('duration') || 45,
                created_by: 'admin',
                created_at: new Date().toISOString()
            };

            try {
                const response = await fetch(`${API_BASE}/api/admin/courses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(courseData)
                });

                const result = await response.json();
                if (result.success) {
                    alert('Cours créé avec succès !');
                    closeModalDynamic(event.target);
                    loadContentData(); // Recharger les données
                } else {
                    alert('Erreur lors de la création du cours: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la création du cours');
            }
        }

        async function handleAddQuiz(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const questions = [];
            
            // Collecter toutes les questions
            for (let i = 1; i <= quizQuestionCount; i++) {
                const question = formData.get(`question_${i}`);
                if (question) {
                    questions.push({
                        question: question,
                        options: {
                            a: formData.get(`option_${i}_a`),
                            b: formData.get(`option_${i}_b`),
                            c: formData.get(`option_${i}_c`),
                            d: formData.get(`option_${i}_d`)
                        },
                        correct_answer: formData.get(`correct_${i}`)
                    });
                }
            }

            const quizData = {
                title: formData.get('title'),
                subject: formData.get('subject'),
                level: formData.get('level'),
                description: formData.get('description'),
                duration: formData.get('duration'),
                passing_score: formData.get('passing_score'),
                questions: questions,
                created_by: 'admin',
                created_at: new Date().toISOString()
            };

            try {
                const response = await fetch(`${API_BASE}/api/admin/quizzes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quizData)
                });

                const result = await response.json();
                if (result.success) {
                    alert('Quiz créé avec succès !');
                    closeModalDynamic(event.target);
                    quizQuestionCount = 1; // Reset counter
                    loadContentData(); // Recharger les données
                } else {
                    alert('Erreur lors de la création du quiz: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la création du quiz');
            }
        }

        async function handleAddResource(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const resourceData = {
                title: formData.get('title'),
                type: formData.get('type'),
                subject: formData.get('subject'),
                level: formData.get('level'),
                description: formData.get('description'),
                url: formData.get('url'),
                is_premium: formData.has('is_premium'),
                created_by: 'admin',
                created_at: new Date().toISOString()
            };

            try {
                const response = await fetch(`${API_BASE}/api/admin/resources`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(resourceData)
                });

                const result = await response.json();
                if (result.success) {
                    alert('Ressource ajoutée avec succès !');
                    closeModalDynamic(event.target);
                    loadContentData(); // Recharger les données
                } else {
                    alert('Erreur lors de l\'ajout de la ressource: ' + result.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'ajout de la ressource');
            }
        }

        function editCourse(courseId) {
            alert(`Édition du cours ${courseId} - À implémenter`);
        }

        function editQuiz(quizId) {
            alert(`Édition du quiz ${quizId} - À implémenter`);
        }

        function editResource(resourceId) {
            alert(`Édition de la ressource ${resourceId} - À implémenter`);
        }

        async function toggleCourseStatus(courseId) {
            try {
                const response = await fetch(`${API_BASE}/api/admin/content/courses/${courseId}/toggle`, {
                    method: 'PUT'
                });

                const result = await response.json();
                if (result.success) {
                    showContentTab('courses'); // Recharger
                } else {
                    alert('Erreur: ' + result.message);
                }
            } catch (error) {
                alert('Erreur technique');
            }
        }

        async function toggleQuizStatus(quizId) {
            try {
                const response = await fetch(`${API_BASE}/api/admin/content/quizzes/${quizId}/toggle`, {
                    method: 'PUT'
                });

                const result = await response.json();
                if (result.success) {
                    showContentTab('quizzes'); // Recharger
                } else {
                    alert('Erreur: ' + result.message);
                }
            } catch (error) {
                alert('Erreur technique');
            }
        }

        // Fonctions pour la gestion d'équipe
        function addStaffMember() {
            alert('Modal d\'ajout de membre d\'équipe - À implémenter');
        }

        // Fonctions pour la communication
        async function sendMessage() {
            const messageData = {
                type: document.getElementById('messageType').value,
                channel: document.getElementById('messageChannel').value,
                subject: document.getElementById('messageSubject').value,
                content: document.getElementById('messageContent').value,
                recipients: document.getElementById('messageRecipients').value
            };

            try {
                const response = await fetch(`${API_BASE}/api/admin/messages/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(messageData)
                });

                const result = await response.json();
                if (result.success) {
                    alert('✅ Message envoyé avec succès!');
                    // Réinitialiser le formulaire
                    document.getElementById('messageSubject').value = '';
                    document.getElementById('messageContent').value = '';
                } else {
                    alert('❌ Erreur: ' + result.message);
                }
            } catch (error) {
                alert('❌ Erreur technique');
            }
        }

        // Fonctions pour les rapports
        async function generateReport() {
            console.log('🔵 generateReport() appelée');
            const reportType = document.getElementById('reportType').value;
            const reportPeriod = document.getElementById('reportPeriod').value;

            try {
                const response = await fetch(`${API_BASE}/api/admin/reports/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: reportType, period: reportPeriod })
                });

                if (response.headers.get('content-type').includes('application/pdf')) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `rapport_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
                    link.click();
                    window.URL.revokeObjectURL(url);
                    alert('✅ Rapport généré et téléchargé!');
                } else {
                    const result = await response.json();
                    alert('❌ Erreur: ' + result.message);
                }
            } catch (error) {
                alert('❌ Erreur technique');
            }
        }

        // Fonctions pour la gestion des essais
        function showTrialManagement() {
            showSection('trial-management');
        }

        async function extendTrial() {
            const subscriberId = prompt('ID de l\'abonné:');
            const extensionDays = prompt('Nombre de jours d\'extension:');

            if (!subscriberId || !extensionDays) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/subscribers/${subscriberId}/extend-trial`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days: parseInt(extensionDays) })
                });

                const result = await response.json();
                if (result.success) {
                    alert('✅ Essai étendu avec succès!');
                } else {
                    alert('❌ Erreur: ' + result.message);
                }
            } catch (error) {
                alert('❌ Erreur technique');
            }
        }

        // Fonctions utilitaires pour les modals
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
        }

        // Fonction showSection maintenant définie au début du script

        // === EMAIL TEMPLATES MANAGEMENT FUNCTIONS ===

        // Global state for email templates
        let emailTemplates = [];
        let currentTemplate = null;
        let isEditMode = false;

        // Load email templates data (static data for testing)
        async function loadEmailTemplatesData() {
            try {
                document.getElementById('templateLoading').classList.remove('hidden');
                document.getElementById('templateEmpty').classList.add('hidden');

                // Static test data
                const staticTemplates = [
                    {
                        id: 1,
                        templateKey: 'WELCOME',
                        name: 'Bienvenue sur Claudyne',
                        description: 'Email de bienvenue pour les nouveaux utilisateurs',
                        category: 'authentication',
                        subject: '🎓 Bienvenue dans la famille Claudyne, {{firstName}} ! La force du savoir vous attend',
                        htmlContent: `
                            <div style="max-width: 600px; margin: 0 auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; text-align: center; border-radius: 10px 10px 0 0;">
                                    <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 600;">🎓 Bienvenue {{firstName}} !</h1>
                                    <p style="color: #f1f5f9; margin: 10px 0 0 0; font-size: 16px;">La force du savoir en héritage</p>
                                </div>

                                <div style="background: white; padding: 40px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                    <h2 style="color: #1e293b; margin-bottom: 20px;">Félicitations ! Vous venez de rejoindre la révolution éducative camerounaise 🇨🇲</h2>

                                    <p style="color: #475569; line-height: 1.6; margin-bottom: 25px;">
                                        Cher(e) {{firstName}} de la famille <strong>{{familyName}}</strong>,
                                    </p>

                                    <p style="color: #475569; line-height: 1.6; margin-bottom: 25px;">
                                        Nous sommes <strong>ravis et honorés</strong> de vous accueillir sur <strong>Claudyne</strong>, la plateforme éducative de référence qui transforme l'apprentissage au Cameroun et en Afrique francophone.
                                    </p>

                                    <div style="background: #f8fafc; border-left: 4px solid #3b82f6; padding: 20px; margin: 25px 0; border-radius: 0 8px 8px 0;">
                                        <h3 style="color: #1e293b; margin: 0 0 15px 0; font-size: 18px;">🚀 Ce qui vous attend :</h3>
                                        <ul style="color: #475569; margin: 0; padding-left: 20px;">
                                            <li style="margin-bottom: 8px;"><strong>Apprentissage adapté</strong> au système éducatif camerounais</li>
                                            <li style="margin-bottom: 8px;"><strong>Battle Royale éducatifs</strong> pour stimuler la compétition saine</li>
                                            <li style="margin-bottom: 8px;"><strong>Mentor IA Claudyne</strong> disponible 24h/24</li>
                                            <li style="margin-bottom: 8px;"><strong>Prix Claudine</strong> pour récompenser l'excellence</li>
                                            <li><strong>Suivi personnalisé</strong> des progrès de votre famille</li>
                                        </ul>
                                    </div>

                                    <div style="text-align: center; margin: 35px 0;">
                                        <a href="https://claudyne.com" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 15px 35px; text-decoration: none; border-radius: 25px; font-weight: 600; display: inline-block; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);">
                                            🎯 Commencer l'aventure
                                        </a>
                                    </div>

                                    <p style="color: #64748b; font-size: 14px; text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                                        <strong>L'équipe Claudyne</strong><br>
                                        💚 <em>"La force du savoir en héritage - Claudine"</em> 💚<br><br>
                                        📧 support@claudyne.com | 🌐 <a href="https://claudyne.com" style="color: #3b82f6;">www.claudyne.com</a><br>
                                        📱 Suivez-nous : <a href="#" style="color: #3b82f6;">Facebook</a> | <a href="#" style="color: #3b82f6;">Twitter</a> | <a href="#" style="color: #3b82f6;">LinkedIn</a>
                                    </p>
                                </div>
                            </div>
                        `,
                        textContent: `Bienvenue {{firstName}} dans la famille Claudyne !

Nous sommes ravis de vous accueillir sur la plateforme éducative de référence au Cameroun.

Ce qui vous attend :
- Apprentissage adapté au système camerounais
- Battle Royale éducatifs
- Mentor IA Claudyne 24h/24
- Prix Claudine pour l'excellence
- Suivi personnalisé

Commencez votre aventure : https://claudyne.com

L'équipe Claudyne
"La force du savoir en héritage - Claudine"
support@claudyne.com | www.claudyne.com`,
                        variables: ['firstName', 'familyName'],
                        isActive: true,
                        isDefault: false,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        templateKey: 'PASSWORD_RESET',
                        name: 'Réinitialisation mot de passe',
                        description: 'Template pour la réinitialisation de mot de passe',
                        category: 'authentication',
                        subject: '🔐 Réinitialisation de votre mot de passe Claudyne - Action requise',
                        htmlContent: `
                            <div style="max-width: 600px; margin: 0 auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
                                    <h1 style="color: white; margin: 0; font-size: 24px; font-weight: 600;">🔐 Réinitialisation de mot de passe</h1>
                                </div>

                                <div style="background: white; padding: 40px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                    <p style="color: #1e293b; font-size: 16px; margin-bottom: 20px;">Bonjour {{firstName}},</p>

                                    <p style="color: #475569; line-height: 1.6; margin-bottom: 25px;">
                                        Vous avez demandé la réinitialisation de votre mot de passe Claudyne. Pour des raisons de sécurité, veuillez cliquer sur le bouton ci-dessous pour créer un nouveau mot de passe.
                                    </p>

                                    <div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 15px; border-radius: 8px; margin: 20px 0;">
                                        <p style="color: #92400e; margin: 0; font-size: 14px;">
                                            ⚠️ <strong>Important :</strong> Ce lien expire dans 15 minutes pour votre sécurité.
                                        </p>
                                    </div>

                                    <div style="text-align: center; margin: 35px 0;">
                                        <a href="{{resetLink}}" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 15px 35px; text-decoration: none; border-radius: 8px; font-weight: 600; display: inline-block;">
                                            🔑 Réinitialiser mon mot de passe
                                        </a>
                                    </div>

                                    <p style="color: #64748b; font-size: 14px; margin-top: 25px;">
                                        Si vous n'avez pas demandé cette réinitialisation, vous pouvez ignorer cet email. Votre mot de passe restera inchangé.
                                    </p>

                                    <p style="color: #64748b; font-size: 14px; text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                                        <strong>L'équipe Sécurité Claudyne</strong><br>
                                        💚 <em>"La force du savoir en héritage - Claudine"</em> 💚<br><br>
                                        📧 security@claudyne.com | 🌐 <a href="https://claudyne.com" style="color: #3b82f6;">www.claudyne.com</a>
                                    </p>
                                </div>
                            </div>
                        `,
                        textContent: `Bonjour {{firstName}},

Vous avez demandé la réinitialisation de votre mot de passe Claudyne.

Cliquez sur ce lien pour créer un nouveau mot de passe :
{{resetLink}}

⚠️ IMPORTANT : Ce lien expire dans 15 minutes.

Si vous n'avez pas demandé cette réinitialisation, ignorez cet email.

L'équipe Sécurité Claudyne
"La force du savoir en héritage - Claudine"
security@claudyne.com | www.claudyne.com`,
                        variables: ['firstName', 'resetLink'],
                        isActive: true,
                        isDefault: false,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 3,
                        templateKey: 'BATTLE_INVITATION',
                        name: 'Invitation Battle Royale',
                        description: 'Invitation à participer aux battles éducatifs',
                        category: 'notification',
                        subject: '🏆 {{studentName}}, prêt(e) pour le Battle Royale "{{battleTitle}}" ? La gloire vous attend !',
                        htmlContent: `
                            <div style="max-width: 600px; margin: 0 auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 40px; text-align: center; border-radius: 10px 10px 0 0;">
                                    <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700;">🏆 BATTLE ROYALE 🏆</h1>
                                    <p style="color: #e0e7ff; margin: 10px 0 0 0; font-size: 18px; font-weight: 600;">{{battleTitle}}</p>
                                </div>

                                <div style="background: white; padding: 40px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                    <h2 style="color: #1e293b; margin-bottom: 20px; text-align: center;">⚡ {{studentName}}, ton moment de gloire arrive ! ⚡</h2>

                                    <p style="color: #475569; line-height: 1.6; margin-bottom: 25px; font-size: 16px;">
                                        Le <strong>{{date}}</strong>, les meilleurs esprits du Cameroun s'affronteront dans un combat épique de connaissances. Auras-tu le courage de relever le défi ?
                                    </p>

                                    <div style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #92400e; padding: 25px; border-radius: 10px; margin: 25px 0; text-align: center;">
                                        <h3 style="margin: 0 0 10px 0; font-size: 20px; color: #92400e;">🎯 ENJEUX DU BATTLE</h3>
                                        <div style="display: flex; justify-content: space-around; flex-wrap: wrap; margin-top: 15px;">
                                            <div style="margin: 5px;">🏅 <strong>Points Claudine</strong></div>
                                            <div style="margin: 5px;">🎖️ <strong>Badges d'honneur</strong></div>
                                            <div style="margin: 5px;">🏆 <strong>Trophées</strong></div>
                                        </div>
                                    </div>

                                    <div style="text-align: center; margin: 35px 0;">
                                        <a href="{{battleLink}}" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 18px 40px; text-decoration: none; border-radius: 25px; font-weight: 700; display: inline-block; font-size: 16px; box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);">
                                            ⚔️ ACCEPTER LE DÉFI ⚔️
                                        </a>
                                    </div>

                                    <p style="color: #64748b; font-size: 14px; text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                                        <strong>L'équipe Battle Royale Claudyne</strong><br>
                                        💚 <em>"La force du savoir en héritage - Claudine"</em> 💚<br><br>
                                        📧 battles@claudyne.com | 🌐 <a href="https://claudyne.com" style="color: #3b82f6;">www.claudyne.com</a>
                                    </p>
                                </div>
                            </div>
                        `,
                        textContent: `🏆 BATTLE ROYALE - {{battleTitle}} 🏆

{{studentName}}, ton moment de gloire arrive !

Le {{date}}, les meilleurs esprits du Cameroun s'affronteront dans un combat épique de connaissances.

ENJEUX :
🏅 Points Claudine
🎖️ Badges d'honneur
🏆 Trophées

Accepter le défi : {{battleLink}}

L'équipe Battle Royale Claudyne
"La force du savoir en héritage - Claudine"
battles@claudyne.com | www.claudyne.com`,
                        variables: ['studentName', 'battleTitle', 'date', 'battleLink'],
                        isActive: true,
                        isDefault: false,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 4,
                        templateKey: 'NOTIFICATION_GENERAL',
                        name: 'Notification générale',
                        description: 'Template pour les notifications générales',
                        category: 'notification',
                        subject: '📢 Important : {{notificationTitle}} - Claudyne',
                        htmlContent: `
                            <div style="max-width: 600px; margin: 0 auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                <div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
                                    <h1 style="color: white; margin: 0; font-size: 24px; font-weight: 600;">📢 {{notificationTitle}}</h1>
                                </div>

                                <div style="background: white; padding: 40px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                    <div style="color: #475569; line-height: 1.6; font-size: 16px;">
                                        {{content}}
                                    </div>

                                    <div style="text-align: center; margin: 35px 0;">
                                        <a href="https://claudyne.com" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; padding: 12px 30px; text-decoration: none; border-radius: 20px; font-weight: 600; display: inline-block;">
                                            🌐 Accéder à Claudyne
                                        </a>
                                    </div>

                                    <p style="color: #64748b; font-size: 14px; text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                                        <strong>L'équipe Claudyne</strong><br>
                                        💚 <em>"La force du savoir en héritage - Claudine"</em> 💚<br><br>
                                        📧 notifications@claudyne.com | 🌐 <a href="https://claudyne.com" style="color: #3b82f6;">www.claudyne.com</a>
                                    </p>
                                </div>
                            </div>
                        `,
                        textContent: `📢 {{notificationTitle}}

{{content}}

Accéder à Claudyne : https://claudyne.com

L'équipe Claudyne
"La force du savoir en héritage - Claudine"
notifications@claudyne.com | www.claudyne.com`,
                        variables: ['notificationTitle', 'content'],
                        isActive: true,
                        isDefault: false,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 5,
                        templateKey: 'PRIX_CLAUDINE_NOMINATION',
                        name: 'Nomination Prix Claudine',
                        description: 'Email de nomination pour le Prix Claudine',
                        category: 'prix_claudine',
                        subject: '🏆 FÉLICITATIONS ! {{studentName}} nominé(e) pour le Prix Claudine {{season}}',
                        htmlContent: `
                            <div style="max-width: 600px; margin: 0 auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                <div style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); padding: 40px; text-align: center; border-radius: 10px 10px 0 0; position: relative;">
                                    <div style="position: absolute; top: 10px; left: 10px; font-size: 24px;">🇨🇲</div>
                                    <div style="position: absolute; top: 10px; right: 10px; font-size: 24px;">🇨🇲</div>
                                    <h1 style="color: white; margin: 0; font-size: 32px; font-weight: 800;">🏆 PRIX CLAUDINE 🏆</h1>
                                    <p style="color: #fef2f2; margin: 10px 0 0 0; font-size: 20px; font-weight: 600;">{{season}}</p>
                                    <div style="color: #fed7d7; margin-top: 15px; font-size: 14px; font-style: italic;">
                                        "Excellence • Persévérance • Solidarité • Valeurs Familiales"
                                    </div>
                                </div>

                                <div style="background: white; padding: 40px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                    <div style="text-align: center; margin-bottom: 30px;">
                                        <h2 style="color: #dc2626; margin: 0; font-size: 28px; font-weight: 700;">🎉 FÉLICITATIONS ! 🎉</h2>
                                        <p style="color: #1e293b; font-size: 18px; margin: 10px 0; font-weight: 600;">{{studentName}} de la famille {{familyName}}</p>
                                    </div>

                                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; padding: 25px; border-radius: 15px; margin: 25px 0; text-align: center;">
                                        <h3 style="color: #92400e; margin: 0 0 15px 0; font-size: 22px;">✨ NOMINATION OFFICIELLE ✨</h3>
                                        <p style="color: #92400e; margin: 0; font-size: 16px; font-weight: 600;">
                                            Vous êtes officiellement nominé(e) pour le <strong>Prix Claudine {{season}}</strong><br>
                                            Catégorie : <strong>{{category}}</strong>
                                        </p>
                                    </div>

                                    <p style="color: #475569; line-height: 1.6; margin-bottom: 25px; font-size: 16px;">
                                        Cette nomination reconnaît votre <strong>excellence académique exceptionnelle</strong>, votre <strong>persévérance remarquable</strong>, votre <strong>esprit de solidarité</strong> et l'exemplarité de vos <strong>valeurs familiales</strong>.
                                    </p>

                                    <div style="background: #ecfdf5; border: 1px solid #10b981; padding: 20px; border-radius: 10px; margin: 25px 0;">
                                        <h3 style="color: #047857; margin: 0 0 10px 0;">🎁 Récompenses à gagner :</h3>
                                        <ul style="color: #047857; margin: 0; padding-left: 20px;">
                                            <li style="margin-bottom: 5px;">🏆 Trophée Prix Claudine</li>
                                            <li style="margin-bottom: 5px;">💰 Bourse d'études</li>
                                            <li style="margin-bottom: 5px;">🎓 Certificat d'excellence</li>
                                            <li style="margin-bottom: 5px;">📱 Équipements technologiques</li>
                                            <li>🌟 Reconnaissance nationale</li>
                                        </ul>
                                    </div>

                                    <div style="text-align: center; margin: 35px 0;">
                                        <a href="{{candidatureLink}}" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 18px 40px; text-decoration: none; border-radius: 25px; font-weight: 700; display: inline-block; font-size: 16px; box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);">
                                            📋 Compléter ma candidature
                                        </a>
                                    </div>

                                    <p style="color: #64748b; font-size: 14px; text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                                        <strong>Comité Prix Claudine</strong><br>
                                        💚 <em>"La force du savoir en héritage - Claudine"</em> 💚<br><br>
                                        📧 prix.claudine@claudyne.com | 🌐 <a href="https://claudyne.com/prix-claudine" style="color: #3b82f6;">Prix Claudine</a>
                                    </p>
                                </div>
                            </div>
                        `,
                        textContent: `🏆 PRIX CLAUDINE {{season}} 🏆

FÉLICITATIONS ! {{studentName}} de la famille {{familyName}}

Vous êtes officiellement nominé(e) pour le Prix Claudine {{season}}
Catégorie : {{category}}

Cette nomination reconnaît votre excellence académique exceptionnelle, votre persévérance remarquable, votre esprit de solidarité et l'exemplarité de vos valeurs familiales.

RÉCOMPENSES À GAGNER :
🏆 Trophée Prix Claudine
💰 Bourse d'études
🎓 Certificat d'excellence
📱 Équipements technologiques
🌟 Reconnaissance nationale

Compléter votre candidature : {{candidatureLink}}

Comité Prix Claudine
"La force du savoir en héritage - Claudine"
prix.claudine@claudyne.com | https://claudyne.com/prix-claudine`,
                        variables: ['studentName', 'familyName', 'season', 'category', 'candidatureLink'],
                        isActive: true,
                        isDefault: false,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];

                emailTemplates = staticTemplates;
                displayEmailTemplates(emailTemplates);

                const stats = {
                    total: staticTemplates.length,
                    active: staticTemplates.filter(t => t.isActive).length,
                    categories: [...new Set(staticTemplates.map(t => t.category))].length
                };
                updateEmailTemplateStats(stats);

            } catch (error) {
                console.error('Error loading email templates:', error);
                showEmailTemplateError('Erreur lors du chargement des templates');
            } finally {
                document.getElementById('templateLoading').classList.add('hidden');
            }
        }

        // Display email templates in grid
        function displayEmailTemplates(templates) {
            const grid = document.getElementById('templatesGrid');
            const emptyState = document.getElementById('templateEmpty');

            if (!templates || templates.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            grid.innerHTML = templates.map(template => createTemplateCard(template)).join('');
        }

        // Create individual template card
        function createTemplateCard(template) {
            const categoryIcons = {
                authentication: 'fa-user-shield',
                notification: 'fa-bell',
                battle: 'fa-crown',
                system: 'fa-cogs'
            };

            const statusColors = {
                active: '#10B981',
                inactive: '#6B7280',
                draft: '#F59E0B',
                archived: '#6B7280'
            };

            return `
                <div class="template-card" data-template-id="${template.id}">
                    <div class="template-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div class="template-category" style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas ${categoryIcons[template.category] || 'fa-envelope'}" style="color: rgba(255,255,255,0.8);"></i>
                            <span style="font-size: 0.85rem; opacity: 0.8; text-transform: capitalize;">${template.category}</span>
                        </div>
                        <div class="template-status" style="background: ${statusColors[template.isActive ? 'active' : 'inactive']}; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                            ${template.isActive ? 'ACTIF' : 'INACTIF'}
                        </div>
                    </div>

                    <h3 style="margin-bottom: 0.5rem; font-size: 1.2rem; font-weight: 600;">${template.name}</h3>
                    <p style="opacity: 0.8; margin-bottom: 1rem; font-size: 0.9rem; line-height: 1.4;">${template.subject}</p>

                    <div class="template-meta" style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem; font-size: 0.8rem; opacity: 0.7;">
                        <span>v${template.version}</span>
                        <span>${template.isDefault ? '⭐ Défaut' : ''}</span>
                        <span>${formatDate(template.updatedAt)}</span>
                    </div>

                    <div class="template-actions" style="display: flex; gap: 0.5rem;">
                        <button class="glass-btn" style="flex: 1; padding: 0.5rem;" onclick="previewTemplate('${template.id}')">
                            <i class="fas fa-eye"></i> Aperçu
                        </button>
                        <button class="glass-btn" style="flex: 1; padding: 0.5rem;" onclick="editTemplate('${template.id}')">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="glass-btn" style="padding: 0.5rem;" onclick="duplicateTemplate('${template.id}')">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="glass-btn" style="padding: 0.5rem;" onclick="deleteTemplate('${template.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // Update stats in the dashboard
        function updateEmailTemplateStats(stats) {
            document.getElementById('totalTemplates').textContent = stats.total || emailTemplates.length;
            document.getElementById('emailsSent').textContent = stats.sent || '0';
            document.getElementById('successRate').textContent = (stats.successRate || 98) + '%';
            document.getElementById('lastUpdate').textContent = formatTimeAgo(new Date());
        }

        // Filter and search functions
        function filterEmailTemplates() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();

            let filteredTemplates = emailTemplates.filter(template => {
                const matchesCategory = !categoryFilter || template.category === categoryFilter;
                const matchesStatus = !statusFilter || template.status === statusFilter;
                const matchesSearch = !searchTerm ||
                    template.name.toLowerCase().includes(searchTerm) ||
                    template.subject.toLowerCase().includes(searchTerm);

                return matchesCategory && matchesStatus && matchesSearch;
            });

            displayEmailTemplates(filteredTemplates);
        }

        function resetFilters() {
            document.getElementById('categoryFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchFilter').value = '';
            displayEmailTemplates(emailTemplates);
        }

        // Modal management functions
        function openTemplateModal(templateId = null) {
            console.log('🔍 openTemplateModal appelée avec ID:', templateId);

            const modal = document.getElementById('templateModal');
            const title = document.getElementById('modalTitle');

            isEditMode = !!templateId;

            // Convertir en nombre si c'est une string
            const numericId = typeof templateId === 'string' ? parseInt(templateId) : templateId;
            currentTemplate = templateId ? emailTemplates.find(t => t.id === numericId || t.id === templateId) : null;

            console.log('🔍 Template trouvé:', currentTemplate);
            console.log('🔍 Mode édition:', isEditMode);

            title.textContent = isEditMode ? 'Modifier le Template' : 'Nouveau Template Email';

            if (isEditMode && currentTemplate) {
                console.log('🔍 Appel de populateTemplateForm avec:', currentTemplate.name);
                populateTemplateForm(currentTemplate);
            } else {
                console.log('🔍 Reset du formulaire (nouveau template ou template non trouvé)');
                resetTemplateForm();
            }

            modal.classList.add('show');
            switchTab('editor');
        }

        function closeTemplateModal() {
            const modal = document.getElementById('templateModal');
            modal.classList.remove('show');
            resetTemplateForm();
            currentTemplate = null;
            isEditMode = false;
        }

        function populateTemplateForm(template) {
            console.log('🔍 populateTemplateForm appelée avec:', template);

            // Vérifier si tous les éléments existent
            const elements = {
                name: document.getElementById('templateName'),
                category: document.getElementById('templateCategory'),
                subject: document.getElementById('templateSubject'),
                content: document.getElementById('templateContent'),
                variables: document.getElementById('templateVariables'),
                status: document.getElementById('templateStatus'),
                version: document.getElementById('templateVersion'),
                isDefault: document.getElementById('isDefault'),
                description: document.getElementById('templateDescription')
            };

            console.log('🔍 Éléments du formulaire:', elements);

            if (elements.name) elements.name.value = template.name || '';
            if (elements.category) elements.category.value = template.category || '';
            if (elements.subject) elements.subject.value = template.subject || '';

            // Support both 'content' and 'htmlContent' properties (prioritize htmlContent like in static data)
            const content = template.htmlContent || template.content || '';
            console.log('🔍 Contenu template à insérer:', content.substring(0, 100) + '...');

            if (elements.content) {
                elements.content.value = content;
                console.log('✅ Contenu inséré dans templateContent');

                // Synchroniser vers l'éditeur visuel si il existe
                const visualEditor = document.getElementById('visualEditor');
                if (visualEditor) {
                    visualEditor.innerHTML = content;
                }

                // Initialiser la synchronisation des éditeurs
                setTimeout(() => {
                    setupEditorSync();
                }, 100);
            } else {
                console.error('❌ Élément templateContent non trouvé!');
            }

            if (elements.variables) elements.variables.value = template.variables ? template.variables.join(',') : '';
            if (elements.status) elements.status.value = template.status || 'active';
            if (elements.version) elements.version.value = template.version || '1';
            if (elements.isDefault) elements.isDefault.checked = template.isDefault || false;
            if (elements.description) elements.description.value = template.description || '';

            console.log('✅ populateTemplateForm terminée');
        }

        function resetTemplateForm() {
            document.getElementById('templateForm').reset();
            document.getElementById('templateVersion').value = '1';
            document.getElementById('templateStatus').value = 'active';
            document.getElementById('isDefault').checked = false;
        }

        // Éditeur visuel pour templates
        let currentEditorMode = 'html';

        function switchEditorMode(mode) {
            currentEditorMode = mode;
            const htmlEditor = document.getElementById('templateContent');
            const visualEditor = document.getElementById('visualEditor');
            const htmlBtn = document.getElementById('htmlModeBtn');
            const visualBtn = document.getElementById('visualModeBtn');
            const visualToolbar = document.getElementById('visualToolbar');

            if (mode === 'html') {
                // Mode HTML
                htmlEditor.style.display = 'block';
                visualEditor.style.display = 'none';
                visualToolbar.style.display = 'none';
                htmlBtn.classList.add('active');
                visualBtn.classList.remove('active');

                // Synchroniser le contenu du visuel vers HTML
                if (visualEditor.innerHTML.trim()) {
                    htmlEditor.value = visualEditor.innerHTML;
                }
            } else {
                // Mode Visuel
                htmlEditor.style.display = 'none';
                visualEditor.style.display = 'block';
                visualToolbar.style.display = 'flex';
                htmlBtn.classList.remove('active');
                visualBtn.classList.add('active');

                // Synchroniser le contenu HTML vers visuel
                if (htmlEditor.value.trim()) {
                    visualEditor.innerHTML = htmlEditor.value;
                }

                // Focus sur l'éditeur visuel
                visualEditor.focus();
            }
        }

        function formatText(command, value = null) {
            if (currentEditorMode === 'visual') {
                document.execCommand(command, false, value);
                syncVisualToHtml();
            }
        }

        function insertLink() {
            if (currentEditorMode === 'visual') {
                const url = prompt('URL du lien:');
                if (url) {
                    document.execCommand('createLink', false, url);
                    syncVisualToHtml();
                }
            }
        }

        function syncVisualToHtml() {
            const visualEditor = document.getElementById('visualEditor');
            const htmlEditor = document.getElementById('templateContent');
            htmlEditor.value = visualEditor.innerHTML;
        }

        function syncHtmlToVisual() {
            const visualEditor = document.getElementById('visualEditor');
            const htmlEditor = document.getElementById('templateContent');
            visualEditor.innerHTML = htmlEditor.value;
        }

        // Synchronisation automatique
        function setupEditorSync() {
            const visualEditor = document.getElementById('visualEditor');
            const htmlEditor = document.getElementById('templateContent');

            // Sync du visuel vers HTML
            visualEditor.addEventListener('input', () => {
                if (currentEditorMode === 'visual') {
                    syncVisualToHtml();
                }
            });

            // Sync du HTML vers visuel
            htmlEditor.addEventListener('input', () => {
                if (currentEditorMode === 'html') {
                    syncHtmlToVisual();
                }
            });
        }

        // Tab management
        function switchTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Refresh preview if switching to preview tab
            if (tabName === 'preview') {
                refreshPreview();
            }
        }

        // Template editor functions
        function insertVariable(variable) {
            const contentTextarea = document.getElementById('templateContent');
            const start = contentTextarea.selectionStart;
            const end = contentTextarea.selectionEnd;
            const text = contentTextarea.value;

            contentTextarea.value = text.substring(0, start) + variable + text.substring(end);
            contentTextarea.focus();
            contentTextarea.setSelectionRange(start + variable.length, start + variable.length);
        }

        function refreshPreview() {
            const subject = document.getElementById('templateSubject').value;
            const content = document.getElementById('templateContent').value;

            document.getElementById('previewSubject').textContent = subject || 'Sujet de l\'email';
            document.getElementById('previewContent').innerHTML = content || 'Contenu de l\'email apparaîtra ici...';
        }

        // Save functions
        async function saveTemplate() {
            try {
                const formData = getTemplateFormData();
                const endpoint = isEditMode ?
                    `${API_BASE}/api/admin/email-templates/${currentTemplate.id}` :
                    `${API_BASE}/api/admin/email-templates`;

                const method = isEditMode ? 'PUT' : 'POST';

                const token = getAuthToken();
                const response = await fetch(endpoint, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showEmailTemplateSuccess(isEditMode ? 'Template modifié avec succès!' : 'Template créé avec succès!');
                    closeTemplateModal();
                    loadEmailTemplatesData(); // Reload the list
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error saving template:', error);
                showEmailTemplateError('Erreur lors de la sauvegarde: ' + error.message);
            }
        }

        async function saveAsDraft() {
            const formData = getTemplateFormData();
            formData.status = 'draft';

            try {
                const endpoint = isEditMode ?
                    `${API_BASE}/api/admin/email-templates/${currentTemplate.id}` :
                    `${API_BASE}/api/admin/email-templates`;

                const method = isEditMode ? 'PUT' : 'POST';

                const token = getAuthToken();
                const response = await fetch(endpoint, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showEmailTemplateSuccess('Brouillon sauvegardé!');
                    closeTemplateModal();
                    loadEmailTemplatesData();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error saving draft:', error);
                showEmailTemplateError('Erreur lors de la sauvegarde du brouillon: ' + error.message);
            }
        }

        function getTemplateFormData() {
            const variables = document.getElementById('templateVariables').value
                .split(',')
                .map(v => v.trim())
                .filter(v => v.length > 0);

            return {
                name: document.getElementById('templateName').value,
                category: document.getElementById('templateCategory').value,
                subject: document.getElementById('templateSubject').value,
                content: document.getElementById('templateContent').value,
                variables: variables,
                status: document.getElementById('templateStatus').value,
                version: parseInt(document.getElementById('templateVersion').value),
                isDefault: document.getElementById('isDefault').checked,
                description: document.getElementById('templateDescription').value
            };
        }

        // Template actions
        function editTemplate(templateId) {
            console.log('🔍 editTemplate appelée avec ID:', templateId, 'Type:', typeof templateId);
            console.log('🔍 Templates disponibles:', emailTemplates.map(t => ({id: t.id, name: t.name})));
            openTemplateModal(templateId);
        }

        // Fonction de débogage pour vérifier les templates
        function debugTemplates() {
            console.log('=== DEBUG TEMPLATES ===');
            console.log('Nombre de templates:', emailTemplates.length);
            console.log('Templates:', emailTemplates);
            if (emailTemplates.length > 0) {
                console.log('Premier template:', emailTemplates[0]);
            }
            alert(`Templates chargés: ${emailTemplates.length}\nVoir console pour détails`);
        }

        // Ajouter le debug au window pour pouvoir l'appeler depuis la console
        window.debugTemplates = debugTemplates;

        function previewTemplate(templateId) {
            // Convert templateId to number if it's a string
            const numericId = typeof templateId === 'string' ? parseInt(templateId) : templateId;
            const template = emailTemplates.find(t => t.id === numericId || t.id === templateId);

            if (!template) {
                console.log('Template recherché:', templateId, 'Type:', typeof templateId);
                console.log('Templates disponibles:', emailTemplates.map(t => ({id: t.id, name: t.name})));
                alert('Template non trouvé. Vérifiez la console pour plus de détails.');
                return;
            }

            // Get content - support both 'content' and 'htmlContent' properties (prioritize htmlContent)
            const content = template.htmlContent || template.content || 'Contenu non disponible';
            const subject = template.subject || 'Sujet non défini';

            // Create preview modal
            const modal = document.createElement('div');
            modal.className = 'modal glass-modal show';
            modal.innerHTML = `
                <div class="modal-content glass-modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>Aperçu: ${template.name}</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="padding: 2rem;">
                        <div class="email-preview">
                            <div class="email-subject" style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 6px;">
                                <strong>Sujet:</strong> ${subject}
                            </div>
                            <div class="email-metadata" style="margin-bottom: 1rem; font-size: 0.9rem; color: #6b7280;">
                                <strong>Catégorie:</strong> ${template.category || 'Non définie'} |
                                <strong>Statut:</strong> ${template.isActive ? '✅ Actif' : '❌ Inactif'}
                            </div>
                            <div class="email-content" style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 1.5rem; background: white; min-height: 200px;">
                                ${content}
                            </div>
                            ${template.variables && template.variables.length > 0 ? `
                                <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                    <strong>Variables disponibles:</strong> ${template.variables.map(v => `{{${v}}}`).join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        async function duplicateTemplate(templateId) {
            const template = emailTemplates.find(t => t.id === templateId);
            if (!template) return;

            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE}/api/admin/email-templates/${templateId}/duplicate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showEmailTemplateSuccess('Template dupliqué avec succès!');
                    loadEmailTemplatesData();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error duplicating template:', error);
                showEmailTemplateError('Erreur lors de la duplication: ' + error.message);
            }
        }

        async function deleteTemplate(templateId) {
            const template = emailTemplates.find(t => t.id === templateId);
            if (!template) return;

            if (!confirm(`Êtes-vous sûr de vouloir supprimer le template "${template.name}" ?`)) {
                return;
            }

            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE}/api/admin/email-templates/${templateId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showEmailTemplateSuccess('Template supprimé avec succès!');
                    loadEmailTemplatesData();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error deleting template:', error);
                showEmailTemplateError('Erreur lors de la suppression: ' + error.message);
            }
        }

        // Utility functions
        function showEmailTemplateSuccess(message) {
            // Use existing notification system or create a simple alert
            if (typeof showNotification === 'function') {
                showNotification(message, 'success');
            } else {
                alert('✅ ' + message);
            }
        }

        function showEmailTemplateError(message) {
            // Use existing notification system or create a simple alert
            if (typeof showNotification === 'function') {
                showNotification(message, 'error');
            } else {
                alert('❌ ' + message);
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);

            if (minutes < 1) return 'Maintenant';
            if (minutes < 60) return `${minutes}min`;
            if (minutes < 1440) return `${Math.floor(minutes / 60)}h`;
            return `${Math.floor(minutes / 1440)}j`;
        }

        // === END EMAIL TEMPLATES MANAGEMENT ===

        // ==========================================
        // EMAIL AUTOMATION SYSTEM
        // ==========================================

        // Variables globales pour l'automatisation
        let emailTriggers = [
            {
                id: 'welcome',
                name: 'Email de bienvenue',
                description: 'Envoyé lors de l\'inscription d\'un nouvel utilisateur',
                event: 'user_registration',
                delay: 0,
                template: 'welcome',
                active: true,
                stats: { sent: 245, opened: 178, clicked: 89 }
            },
            {
                id: 'password_reset',
                name: 'Réinitialisation mot de passe',
                description: 'Envoyé lors d\'une demande de réinitialisation',
                event: 'password_reset_request',
                delay: 0,
                template: 'password_reset',
                active: true,
                stats: { sent: 67, opened: 54, clicked: 42 }
            },
            {
                id: 'activity_reminder',
                name: 'Rappel d\'activité',
                description: 'Envoyé si pas de connexion depuis 7 jours',
                event: 'user_inactive',
                delay: 10080, // 7 jours en minutes
                template: 'activity_reminder',
                active: true,
                stats: { sent: 156, opened: 98, clicked: 34 }
            },
            {
                id: 'quiz_results',
                name: 'Résultats de quiz',
                description: 'Envoyé après la completion d\'un quiz',
                event: 'quiz_completed',
                delay: 5, // 5 minutes
                template: 'quiz_results',
                active: true,
                stats: { sent: 389, opened: 301, clicked: 156 }
            },
            {
                id: 'weekly_report',
                name: 'Rapport hebdomadaire',
                description: 'Envoyé chaque dimanche avec le résumé de la semaine',
                event: 'weekly_schedule',
                delay: 0,
                template: 'weekly_report',
                active: false,
                stats: { sent: 89, opened: 67, clicked: 23 }
            }
        ];

        let emailQueue = [
            {
                id: 'eq1',
                userId: 'user123',
                userEmail: 'jean.dupont@email.com',
                userName: 'Jean Dupont',
                triggerId: 'welcome',
                templateId: 'welcome',
                scheduledFor: new Date(Date.now() + 300000), // Dans 5 minutes
                status: 'pending',
                attempts: 0,
                createdAt: new Date()
            },
            {
                id: 'eq2',
                userId: 'user456',
                userEmail: 'marie.martin@email.com',
                userName: 'Marie Martin',
                triggerId: 'password_reset',
                templateId: 'password_reset',
                scheduledFor: new Date(Date.now() + 60000), // Dans 1 minute
                status: 'pending',
                attempts: 0,
                createdAt: new Date()
            },
            {
                id: 'eq3',
                userId: 'user789',
                userEmail: 'paul.bernard@email.com',
                userName: 'Paul Bernard',
                triggerId: 'quiz_results',
                templateId: 'quiz_results',
                scheduledFor: new Date(Date.now() - 300000), // Il y a 5 minutes
                status: 'sent',
                attempts: 1,
                createdAt: new Date(Date.now() - 600000),
                sentAt: new Date(Date.now() - 300000)
            }
        ];

        // Fonction principale pour charger les données d'automatisation
        async function loadEmailAutomationData() {
            console.log('📧 Chargement des données d\'automatisation email...');

            try {
                // Charger les statistiques
                loadEmailAutomationStats();

                // Charger les triggers
                loadEmailTriggers();

                // Charger la queue
                loadEmailQueue();

                // Charger les analytics
                loadEmailAnalytics();

                console.log('✅ Données d\'automatisation chargées');
            } catch (error) {
                console.error('❌ Erreur lors du chargement de l\'automatisation:', error);
            }
        }

        // Charger les statistiques d'automatisation
        function loadEmailAutomationStats() {
            const stats = {
                totalTriggers: emailTriggers.length,
                activeTriggers: emailTriggers.filter(t => t.active).length,
                pendingEmails: emailQueue.filter(e => e.status === 'pending').length,
                sentToday: emailQueue.filter(e =>
                    e.status === 'sent' &&
                    e.sentAt &&
                    new Date(e.sentAt).toDateString() === new Date().toDateString()
                ).length
            };

            // Mettre à jour l'interface avec tous les IDs possibles
            const totalTriggersElements = ['total-triggers', 'activeAutomations'];
            const activeTriggersElements = ['active-triggers'];
            const pendingEmailsElements = ['pending-emails', 'emailsInQueue'];
            const sentTodayElements = ['sent-today', 'emailsSentToday'];

            totalTriggersElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = stats.totalTriggers;
            });

            activeTriggersElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = stats.activeTriggers;
            });

            pendingEmailsElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = stats.pendingEmails;
            });

            sentTodayElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = stats.sentToday;
            });
        }

        // Charger et afficher les triggers
        function loadEmailTriggers() {
            const triggersGrid = document.getElementById('triggers-grid') || document.getElementById('triggersGrid');

            const triggersHtml = emailTriggers.map(trigger => `
                <div class="glass-card automation-trigger-card">
                    <div class="automation-trigger-header">
                        <h4>${trigger.name}</h4>
                        <div class="trigger-toggle">
                            <label class="switch">
                                <input type="checkbox" ${trigger.active ? 'checked' : ''}
                                       onchange="toggleTrigger('${trigger.id}')">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <p class="trigger-description">${trigger.description}</p>

                    <div class="trigger-details">
                        <div class="detail-item">
                            <span class="detail-label">Événement:</span>
                            <span class="detail-value">${getEventLabel(trigger.event)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Délai:</span>
                            <span class="detail-value">${formatDelay(trigger.delay)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Template:</span>
                            <span class="detail-value">${trigger.template}</span>
                        </div>
                    </div>

                    <div class="trigger-stats">
                        <div class="stat-item">
                            <span class="stat-value">${trigger.stats.sent}</span>
                            <span class="stat-label">Envoyés</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${trigger.stats.opened}</span>
                            <span class="stat-label">Ouverts</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${trigger.stats.clicked}</span>
                            <span class="stat-label">Cliqués</span>
                        </div>
                    </div>

                    <div class="trigger-actions">
                        <button class="btn glass-btn btn-sm" onclick="editTrigger('${trigger.id}')">
                            ✏️ Modifier
                        </button>
                        <button class="btn glass-btn btn-sm" onclick="testTrigger('${trigger.id}')">
                            🧪 Tester
                        </button>
                    </div>
                </div>
            `).join('');

            triggersGrid.innerHTML = triggersHtml;
        }

        // Charger et afficher la queue d'emails
        function loadEmailQueue() {
            const queueTable = document.getElementById('email-queue-table') || document.getElementById('emailQueueTable');

            if (emailQueue.length === 0) {
                queueTable.innerHTML = '<p class="text-center">Aucun email en attente</p>';
                return;
            }

            const queueHtml = `
                <table class="glass-table">
                    <thead>
                        <tr>
                            <th>Destinataire</th>
                            <th>Trigger</th>
                            <th>Planifié pour</th>
                            <th>Statut</th>
                            <th>Tentatives</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${emailQueue.map(email => `
                            <tr>
                                <td>
                                    <div class="user-info">
                                        <div class="user-name">${email.userName}</div>
                                        <div class="user-email">${email.userEmail}</div>
                                    </div>
                                </td>
                                <td>
                                    <span class="glass-badge glass-badge-info">
                                        ${getTriggerName(email.triggerId)}
                                    </span>
                                </td>
                                <td>${formatScheduledTime(email.scheduledFor)}</td>
                                <td>
                                    <span class="glass-badge glass-badge-${getStatusColor(email.status)}">
                                        ${getStatusLabel(email.status)}
                                    </span>
                                </td>
                                <td>${email.attempts}</td>
                                <td>
                                    ${email.status === 'pending' ? `
                                        <button class="btn glass-btn btn-sm" onclick="sendEmailNow('${email.id}')">
                                            📧 Envoyer
                                        </button>
                                        <button class="btn glass-btn glass-btn-warning btn-sm" onclick="cancelEmail('${email.id}')">
                                            ❌ Annuler
                                        </button>
                                    ` : `
                                        <button class="btn glass-btn btn-sm" onclick="viewEmailDetails('${email.id}')">
                                            👁️ Détails
                                        </button>
                                    `}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            queueTable.innerHTML = queueHtml;
        }

        // Charger les analytics d'automatisation
        function loadEmailAnalytics() {
            // Calculer les données d'analytics
            const totalSent = emailTriggers.reduce((sum, trigger) => sum + trigger.stats.sent, 0);
            const totalOpened = emailTriggers.reduce((sum, trigger) => sum + trigger.stats.opened, 0);
            const totalClicked = emailTriggers.reduce((sum, trigger) => sum + trigger.stats.clicked, 0);

            const openRate = totalSent > 0 ? ((totalOpened / totalSent) * 100).toFixed(1) : 0;
            const clickRate = totalOpened > 0 ? ((totalClicked / totalOpened) * 100).toFixed(1) : 0;

            // Mettre à jour l'interface
            document.getElementById('total-sent').textContent = totalSent;
            document.getElementById('open-rate').textContent = openRate + '%';
            document.getElementById('click-rate').textContent = clickRate + '%';
        }

        // ==========================================
        // FONCTIONS D'INTERACTION
        // ==========================================

        // Activer/désactiver un trigger
        function toggleTrigger(triggerId) {
            const trigger = emailTriggers.find(t => t.id === triggerId);
            if (trigger) {
                trigger.active = !trigger.active;
                console.log(`🔄 Trigger ${triggerId} ${trigger.active ? 'activé' : 'désactivé'}`);

                // Mettre à jour les stats
                loadEmailAutomationStats();

                // Envoyer au backend si disponible
                saveTriggerState(triggerId, trigger.active);
            }
        }

        // Modifier un trigger
        function editTrigger(triggerId) {
            const trigger = emailTriggers.find(t => t.id === triggerId);
            if (!trigger) return;

            // Ouvrir modal d'édition (à implémenter)
            alert(`Édition du trigger: ${trigger.name}\n\nFonctionnalité à développer avec modal d'édition complète.`);
        }

        // Tester un trigger
        async function testTrigger(triggerId) {
            const trigger = emailTriggers.find(t => t.id === triggerId);
            if (!trigger) return;

            const testEmail = prompt('Email de test:', 'admin@claudyne.com');
            if (!testEmail) return;

            console.log(`🧪 Test du trigger ${triggerId} vers ${testEmail}`);

            try {
                // Simulation d'envoi de test
                alert(`✅ Email de test envoyé avec succès vers ${testEmail}\n\nTrigger: ${trigger.name}\nTemplate: ${trigger.template}`);

                // TODO: Implémenter l'envoi réel via l'API
            } catch (error) {
                alert(`❌ Erreur lors de l'envoi de test: ${error.message}`);
            }
        }

        // Envoyer un email immédiatement
        async function sendEmailNow(emailId) {
            const email = emailQueue.find(e => e.id === emailId);
            if (!email || email.status !== 'pending') return;

            if (!confirm(`Envoyer l'email immédiatement à ${email.userEmail} ?`)) return;

            console.log(`📧 Envoi immédiat de l'email ${emailId}`);

            try {
                // Mettre à jour le statut
                email.status = 'sending';
                email.attempts++;

                // Recharger la queue
                loadEmailQueue();

                // Simulation d'envoi
                setTimeout(() => {
                    email.status = 'sent';
                    email.sentAt = new Date();
                    loadEmailQueue();
                    loadEmailAutomationStats();
                    alert(`✅ Email envoyé avec succès à ${email.userEmail}`);
                }, 2000);

                // TODO: Implémenter l'envoi réel via l'API

            } catch (error) {
                email.status = 'failed';
                loadEmailQueue();
                alert(`❌ Erreur lors de l'envoi: ${error.message}`);
            }
        }

        // Annuler un email en attente
        function cancelEmail(emailId) {
            const emailIndex = emailQueue.findIndex(e => e.id === emailId);
            if (emailIndex === -1) return;

            if (!confirm('Annuler cet email ?')) return;

            emailQueue.splice(emailIndex, 1);
            loadEmailQueue();
            loadEmailAutomationStats();

            console.log(`🗑️ Email ${emailId} annulé`);
        }

        // Voir les détails d'un email
        function viewEmailDetails(emailId) {
            const email = emailQueue.find(e => e.id === emailId);
            if (!email) return;

            const details = `
                Détails de l'email:

                ID: ${email.id}
                Destinataire: ${email.userName} (${email.userEmail})
                Trigger: ${getTriggerName(email.triggerId)}
                Template: ${email.templateId}
                Statut: ${getStatusLabel(email.status)}
                Créé: ${email.createdAt.toLocaleString()}
                ${email.sentAt ? `Envoyé: ${email.sentAt.toLocaleString()}` : ''}
                Tentatives: ${email.attempts}
            `;

            alert(details);
        }

        // Ajouter un nouveau trigger
        function addNewTrigger() {
            alert('Ajout d\'un nouveau trigger\n\nFonctionnalité à développer avec formulaire complet.');
        }

        // Ouvrir le modal d'automatisation
        function openAutomationModal() {
            alert('Configuration d\'un nouveau déclencheur\n\nModal d\'édition à implémenter avec:\n- Sélection d\'événement\n- Configuration de délai\n- Choix de template\n- Conditions avancées');
        }

        // Rafraîchir la queue d'emails
        function refreshEmailQueue() {
            console.log('🔄 Actualisation de la queue d\'emails...');
            loadEmailQueue();
            loadEmailAutomationStats();
        }

        // ======================================
        // EMAIL CONFIGURATION FUNCTIONS
        // ======================================

        // Sauvegarder la configuration email
        async function saveEmailConfiguration() {
            const resultDiv = document.getElementById('emailConfigResult');

            const emailConfig = {
                smtp: {
                    host: document.getElementById('smtpHost').value,
                    port: parseInt(document.getElementById('smtpPort').value),
                    user: document.getElementById('smtpUser').value,
                    password: document.getElementById('smtpPassword').value,
                    secure: document.getElementById('smtpTls').checked
                },
                automation: {
                    enabled: document.getElementById('emailAutomationEnabled').checked,
                    fromName: document.getElementById('emailFromName').value,
                    supportEmail: document.getElementById('emailSupport').value,
                    welcomeEmailEnabled: document.getElementById('welcomeEmailEnabled').checked,
                    welcomeEmailDelay: parseInt(document.getElementById('welcomeEmailDelay').value),
                    passwordResetEnabled: document.getElementById('passwordResetEnabled').checked,
                    prixClaudineEmailEnabled: document.getElementById('prixClaudineEmailEnabled').checked
                }
            };

            try {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#F3F4F6';
                resultDiv.style.color = '#374151';
                resultDiv.textContent = '⏳ Sauvegarde de la configuration email...';

                const response = await apiRequest(`${API_BASE}/api/admin/email-config`, {
                    method: 'POST',
                    body: JSON.stringify(emailConfig)
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.style.background = '#D1FAE5';
                    resultDiv.style.color = '#065F46';
                    resultDiv.textContent = '✅ Configuration email sauvegardée avec succès!';

                    // Redémarrer le service email
                    setTimeout(() => {
                        restartEmailService();
                    }, 1000);
                } else {
                    resultDiv.style.background = '#FEE2E2';
                    resultDiv.style.color = '#991B1B';
                    resultDiv.textContent = `❌ Erreur: ${result.message}`;
                }
            } catch (error) {
                console.error('Erreur sauvegarde email config:', error);
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#FEE2E2';
                resultDiv.style.color = '#991B1B';
                resultDiv.textContent = '❌ Erreur de connexion au serveur';
            }
        }

        // Tester la connexion SMTP
        async function testEmailSMTP() {
            const resultDiv = document.getElementById('emailConfigResult');

            try {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#F3F4F6';
                resultDiv.style.color = '#374151';
                resultDiv.textContent = '⏳ Test de la connexion SMTP...';

                const response = await apiRequest(`${API_BASE}/api/admin/email-test-smtp`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.style.background = '#D1FAE5';
                    resultDiv.style.color = '#065F46';
                    resultDiv.textContent = '✅ Connexion SMTP réussie!';
                } else {
                    resultDiv.style.background = '#FEE2E2';
                    resultDiv.style.color = '#991B1B';
                    resultDiv.textContent = `❌ Échec SMTP: ${result.message}`;
                }
            } catch (error) {
                console.error('Erreur test SMTP:', error);
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#FEE2E2';
                resultDiv.style.color = '#991B1B';
                resultDiv.textContent = '❌ Erreur test SMTP';
            }
        }

        // Envoyer un email de bienvenue de test
        async function sendTestWelcomeEmail() {
            const resultDiv = document.getElementById('emailConfigResult');
            const emailUser = document.getElementById('smtpUser').value;

            if (!emailUser) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#FEF3C7';
                resultDiv.style.color = '#92400E';
                resultDiv.textContent = '⚠️ Veuillez configurer l\'email SMTP d\'abord';
                return;
            }

            try {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#F3F4F6';
                resultDiv.style.color = '#374151';
                resultDiv.textContent = `⏳ Envoi email test vers ${emailUser}...`;

                const response = await apiRequest(`${API_BASE}/api/admin/email-test-welcome`, {
                    method: 'POST',
                    body: JSON.stringify({
                        testEmail: emailUser
                    })
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.style.background = '#D1FAE5';
                    resultDiv.style.color = '#065F46';
                    resultDiv.textContent = `✅ Email de bienvenue envoyé vers ${emailUser}!`;
                } else {
                    resultDiv.style.background = '#FEE2E2';
                    resultDiv.style.color = '#991B1B';
                    resultDiv.textContent = `❌ Échec envoi: ${result.message}`;
                }
            } catch (error) {
                console.error('Erreur test email bienvenue:', error);
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#FEE2E2';
                resultDiv.style.color = '#991B1B';
                resultDiv.textContent = '❌ Erreur envoi test';
            }
        }

        // Redémarrer le service email
        async function restartEmailService() {
            try {
                const response = await apiRequest(`${API_BASE}/api/admin/email-restart`, {
                    method: 'POST'
                });
                const result = await response.json();
                console.log('🔄 Service email redémarré:', result.success);
            } catch (error) {
                console.error('Erreur redémarrage service email:', error);
            }
        }

        // Charger la configuration email existante
        async function loadEmailConfiguration() {
            try {
                const response = await apiRequest(`${API_BASE}/api/admin/email-config`);
                const result = await response.json();

                if (result.success && result.data) {
                    const config = result.data;

                    // SMTP Configuration
                    if (config.smtp) {
                        document.getElementById('smtpHost').value = config.smtp.host || '';
                        document.getElementById('smtpPort').value = config.smtp.port || 587;
                        document.getElementById('smtpUser').value = config.smtp.user || '';
                        document.getElementById('smtpTls').checked = config.smtp.secure !== false;
                    }

                    // Automation Configuration
                    if (config.automation) {
                        document.getElementById('emailAutomationEnabled').checked = config.automation.enabled !== false;
                        document.getElementById('emailFromName').value = config.automation.fromName || 'Équipe Claudyne';
                        document.getElementById('emailSupport').value = config.automation.supportEmail || 'support@claudyne.com';
                        document.getElementById('welcomeEmailEnabled').checked = config.automation.welcomeEmailEnabled !== false;
                        document.getElementById('welcomeEmailDelay').value = config.automation.welcomeEmailDelay || 0;
                        document.getElementById('passwordResetEnabled').checked = config.automation.passwordResetEnabled !== false;
                        document.getElementById('prixClaudineEmailEnabled').checked = config.automation.prixClaudineEmailEnabled !== false;
                    }
                }
            } catch (error) {
                console.error('Erreur chargement configuration email:', error);
            }
        }

        // Fonctions utilitaires manquantes pour l'interface
        function testAllTriggers() {
            alert('Test de tous les triggers\n\nEnvoi d\'emails de test pour tous les déclencheurs actifs.');
        }

        function processEmailQueue() {
            alert('Traitement de la file d\'attente\n\nTraitement en cours des emails en attente...');
        }

        function pauseEmailQueue() {
            alert('Pause de la file d\'attente\n\nLa file d\'attente est mise en pause.');
        }

        function clearEmailQueue() {
            if (confirm('Êtes-vous sûr de vouloir vider la file d\'attente ?')) {
                emailQueue.length = 0;
                loadEmailQueue();
                loadEmailAutomationStats();
                alert('File d\'attente vidée avec succès.');
            }
        }

        function updateEmailAnalytics() {
            console.log('📊 Mise à jour des analytics...');
            loadEmailAnalytics();
        }

        // ==========================================
        // FONCTIONS UTILITAIRES
        // ==========================================

        function getEventLabel(event) {
            const labels = {
                'user_registration': 'Inscription utilisateur',
                'password_reset_request': 'Demande mot de passe',
                'user_inactive': 'Utilisateur inactif',
                'quiz_completed': 'Quiz terminé',
                'weekly_schedule': 'Programmation hebdomadaire'
            };
            return labels[event] || event;
        }

        function formatDelay(minutes) {
            if (minutes === 0) return 'Immédiat';
            if (minutes < 60) return `${minutes} min`;
            if (minutes < 1440) return `${Math.floor(minutes / 60)} h`;
            return `${Math.floor(minutes / 1440)} j`;
        }

        function getTriggerName(triggerId) {
            const trigger = emailTriggers.find(t => t.id === triggerId);
            return trigger ? trigger.name : triggerId;
        }

        function formatScheduledTime(date) {
            const now = new Date();
            const diff = date - now;

            if (diff < 0) {
                return `Il y a ${formatTimeAgo(date)}`;
            } else if (diff < 3600000) { // Moins d'1 heure
                return `Dans ${Math.floor(diff / 60000)} min`;
            } else {
                return date.toLocaleString();
            }
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'sending': 'info',
                'sent': 'success',
                'failed': 'danger'
            };
            return colors[status] || 'secondary';
        }

        // Sauvegarder l'état d'un trigger
        async function saveTriggerState(triggerId, active) {
            try {
                // TODO: Implémenter la sauvegarde via l'API
                console.log(`💾 Sauvegarde état trigger ${triggerId}: ${active}`);
            } catch (error) {
                console.error('Erreur sauvegarde trigger:', error);
            }
        }

        // === END EMAIL AUTOMATION SYSTEM ===

        // === FONCTIONS GESTION DES DONNÉES ===
        let dataLogElement = null;

        function dataLog(message) {
            if (!dataLogElement) {
                dataLogElement = document.getElementById('dataActionLog');
            }
            if (dataLogElement) {
                const timestamp = new Date().toLocaleTimeString();
                dataLogElement.innerHTML += `[${timestamp}] ${message}<br>`;
                dataLogElement.scrollTop = dataLogElement.scrollHeight;
            }
        }

        function updateDataStatusInfo() {
            const statusEl = document.getElementById('dataStatusInfo');
            if (!statusEl) return;

            try {
                const templates = claudyneData.getEmailTemplates();
                const automations = claudyneData.getEmailAutomations();
                const stats = claudyneData.getDashboardStats();

                statusEl.innerHTML = `
                    <div class="data-status-item">
                        <h4>📧 Templates Email</h4>
                        <p>${templates.length} template(s)</p>
                        <small>Dernière modification: ${templates[0]?.lastModified ? new Date(templates[0].lastModified).toLocaleString() : 'N/A'}</small>
                    </div>
                    <div class="data-status-item">
                        <h4>🤖 Automations</h4>
                        <p>${automations.length} automation(s)</p>
                        <p>${automations.filter(a => a.active).length} active(s)</p>
                    </div>
                    <div class="data-status-item">
                        <h4>📊 Statistiques</h4>
                        <p>Utilisateurs: ${stats.users?.total || 0}</p>
                        <small>Dernière MAJ: ${stats.lastUpdate ? new Date(stats.lastUpdate).toLocaleString() : 'N/A'}</small>
                    </div>
                    <div class="data-status-item">
                        <h4>💾 Stockage</h4>
                        <p>Données: ${getClaudyneStorageSize()} KB</p>
                        <p>Total: ${getStorageSize()} KB</p>
                    </div>
                `;
            } catch (error) {
                statusEl.innerHTML = `<div class="data-status-item"><h4>❌ Erreur</h4><p>Impossible de charger</p></div>`;
                dataLog(`❌ Erreur mise à jour statut: ${error.message}`);
            }
        }

        function getStorageSize() {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length;
                }
            }
            return Math.round(total / 1024);
        }

        function getClaudyneStorageSize() {
            let total = 0;
            if (window.claudyneData && window.claudyneData.manager) {
                Object.values(claudyneData.manager.dataKeys).forEach(key => {
                    const data = localStorage.getItem(key);
                    if (data) total += data.length;
                });
            }
            return Math.round(total / 1024);
        }

        function resetAllDataAdmin() {
            if (confirm('⚠️ ATTENTION: Cette action va supprimer TOUTES les données et les remettre aux valeurs par défaut.\n\nContinuer ?')) {
                try {
                    claudyneData.resetAll();
                    dataLog('🔄 RESET COMPLET effectué');
                    showNotification('✅ Toutes les données ont été réinitialisées', 'success');
                    updateDataStatusInfo();
                } catch (error) {
                    dataLog(`❌ Erreur reset complet: ${error.message}`);
                    showNotification('❌ Erreur lors du reset complet', 'error');
                }
            }
        }

        function resetCategoryAdmin(category) {
            const categoryNames = {
                'EMAIL_TEMPLATES': 'Templates Email',
                'EMAIL_AUTOMATIONS': 'Automations Email',
                'DASHBOARD_STATS': 'Statistiques'
            };

            const categoryName = categoryNames[category] || category;

            if (confirm(`Réinitialiser ${categoryName} ?`)) {
                try {
                    claudyneData.resetCategory(category);
                    dataLog(`🔄 ${categoryName} réinitialisés`);
                    showNotification(`✅ ${categoryName} réinitialisés`, 'success');
                    updateDataStatusInfo();
                } catch (error) {
                    dataLog(`❌ Erreur reset ${categoryName}: ${error.message}`);
                    showNotification(`❌ Erreur reset ${categoryName}`, 'error');
                }
            }
        }

        function exportDataAdmin() {
            try {
                claudyneData.exportData();
                dataLog('📥 Données exportées avec succès');
                showNotification('✅ Données exportées', 'success');
            } catch (error) {
                dataLog(`❌ Erreur export: ${error.message}`);
                showNotification('❌ Erreur export', 'error');
            }
        }

        function importDataAdmin(file) {
            if (!file) return;

            claudyneData.importData(file)
                .then(() => {
                    dataLog(`📤 Données importées depuis: ${file.name}`);
                    showNotification('✅ Données importées avec succès', 'success');
                    updateDataStatusInfo();
                })
                .catch(error => {
                    dataLog(`❌ Erreur import: ${error.message}`);
                    showNotification('❌ Erreur lors de l\'import', 'error');
                });
        }

        function clearDataLog() {
            if (dataLogElement) {
                dataLogElement.innerHTML = 'Journal vidé...<br>';
            }
        }

        // Mise à jour de showSection pour inclure la gestion des données
        const originalShowSection = showSection;
        showSection = function(sectionName) {
            originalShowSection(sectionName);

            if (sectionName === 'data-management') {
                setTimeout(() => {
                    dataLog('🔧 Section gestion des données ouverte');
                    updateDataStatusInfo();
                }, 100);
            }
        };

        // ======================================
        // ADMIN TOKEN AUTHENTICATION SYSTEM
        // ======================================

        let adminToken = localStorage.getItem('claudyne-admin-token');

        // Générer token admin automatiquement
        async function generateAdminToken() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/generate-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminKey: 'claudyne-admin-2024'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    adminToken = result.token;
                    localStorage.setItem('claudyne-admin-token', adminToken);
                    console.log('🔑 Token admin généré avec succès');
                    return true;
                } else {
                    console.error('❌ Erreur génération token:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('❌ Erreur connexion pour token:', error);
                return false;
            }
        }

        // Fonction pour faire des requêtes API avec authentification
        async function apiRequest(url, options = {}) {
            // S'assurer qu'on a un token
            if (!adminToken) {
                const tokenGenerated = await generateAdminToken();
                if (!tokenGenerated) {
                    throw new Error('Impossible de générer le token admin');
                }
            }

            // Ajouter le token aux headers
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${adminToken}`,
                ...options.headers
            };

            const response = await fetch(url, {
                ...options,
                headers
            });

            // Si token expiré, en générer un nouveau
            if (response.status === 401) {
                console.log('🔄 Token expiré, génération d\'un nouveau...');
                const tokenGenerated = await generateAdminToken();
                if (tokenGenerated) {
                    // Retry avec le nouveau token
                    headers['Authorization'] = `Bearer ${adminToken}`;
                    return fetch(url, {
                        ...options,
                        headers
                    });
                }
            }

            return response;
        }

        // Chargement initial
        window.addEventListener('load', async function() {
            // Générer token si nécessaire
            if (!adminToken) {
                await generateAdminToken();
            }
            loadDashboardData();
        });

        // ======================================
        // NOUVELLES FONCTIONS DE SAUVEGARDE
        // ======================================

        // Sauvegarder configuration tarifaire
        async function savePricingConfiguration() {
            const pricingConfig = {
                basicPrice: parseInt(document.getElementById('basicPrice').value),
                premiumPrice: parseInt(document.getElementById('premiumPrice').value),
                familyPrice: parseInt(document.getElementById('familyPrice').value),
                trialDays: parseInt(document.getElementById('trialDays').value)
            };

            try {
                const response = await apiRequest(`${API_BASE}/api/admin/pricing-config`, {
                    method: 'POST',
                    body: JSON.stringify(pricingConfig)
                });

                const result = await response.json();
                if (result.success) {
                    alert('✅ Configuration tarifaire sauvegardée avec succès!');
                } else {
                    alert(`❌ Erreur: ${result.message}`);
                }
            } catch (error) {
                console.error('Erreur sauvegarde tarifs:', error);
                alert('❌ Erreur de connexion au serveur');
            }
        }

        // Sauvegarder configuration des API
        async function saveAPIConfiguration() {
            const apiConfig = {
                claude: {
                    apiKey: document.getElementById('claudeApiKey')?.value || '',
                    model: document.getElementById('claudeModel')?.value || ''
                },
                openai: {
                    apiKey: document.getElementById('openaiApiKey')?.value || '',
                    model: document.getElementById('openaiModel')?.value || '',
                    temperature: parseFloat(document.getElementById('openaiTemperature')?.value || 0.7),
                    maxTokens: parseInt(document.getElementById('openaiMaxTokens')?.value || 2000),
                    systemPrompt: document.getElementById('openaiSystemPrompt')?.value || '',
                    enabled: document.getElementById('openaiEnabled')?.checked || false
                },
                sms: {
                    ltmApiKey: document.getElementById('ltmApiKey')?.value || '',
                    ltmApiUrl: document.getElementById('ltmApiUrl')?.value || ''
                },
                future: {
                    flutterwaveKey: document.getElementById('flutterwaveKey')?.value || '',
                    googleAnalyticsId: document.getElementById('googleAnalyticsId')?.value || '',
                    pushNotificationKey: document.getElementById('pushNotificationKey')?.value || '',
                    customApiKey: document.getElementById('customApiKey')?.value || ''
                }
            };

            try {
                const response = await apiRequest(`${API_BASE}/api/admin/api-config`, {
                    method: 'POST',
                    body: JSON.stringify(apiConfig)
                });

                const result = await response.json();
                if (result.success) {
                    alert('✅ Configuration des API sauvegardée avec succès!');
                } else {
                    alert(`❌ Erreur: ${result.message}`);
                }
            } catch (error) {
                console.error('Erreur sauvegarde API config:', error);
                alert('❌ Erreur de connexion au serveur');
            }
        }

        // Ajouter membre de l'équipe
        async function addTeamMember() {
            const teamMember = {
                firstName: document.getElementById('staffFirstName')?.value || '',
                lastName: document.getElementById('staffLastName')?.value || '',
                email: document.getElementById('staffEmail')?.value || '',
                phone: document.getElementById('staffPhone')?.value || '',
                role: document.getElementById('staffRole')?.value || '',
                region: document.getElementById('staffRegion')?.value || '',
                speciality: document.getElementById('staffSpeciality')?.value || ''
            };

            if (!teamMember.firstName || !teamMember.lastName || !teamMember.email) {
                alert('⚠️ Veuillez remplir au minimum le prénom, nom et email');
                return;
            }

            try {
                const response = await apiRequest(`${API_BASE}/api/admin/team-members`, {
                    method: 'POST',
                    body: JSON.stringify(teamMember)
                });

                const result = await response.json();
                if (result.success) {
                    alert(`✅ Membre ${teamMember.firstName} ${teamMember.lastName} ajouté avec succès!`);
                    // Reset form
                    document.getElementById('staffFirstName').value = '';
                    document.getElementById('staffLastName').value = '';
                    document.getElementById('staffEmail').value = '';
                    document.getElementById('staffPhone').value = '';
                } else {
                    alert(`❌ Erreur: ${result.message}`);
                }
            } catch (error) {
                console.error('Erreur ajout membre équipe:', error);
                alert('❌ Erreur de connexion au serveur');
            }
        }

        // Envoyer message rapide
        async function sendQuickMessage() {
            const message = {
                recipients: document.getElementById('messageRecipients')?.value || '',
                channel: document.getElementById('messageChannel')?.value || '',
                type: document.getElementById('messageType')?.value || '',
                subject: document.getElementById('messageSubject')?.value || '',
                content: document.getElementById('messageContent')?.value || ''
            };

            if (!message.subject || !message.content) {
                alert('⚠️ Veuillez remplir le sujet et le contenu du message');
                return;
            }

            try {
                const response = await apiRequest(`${API_BASE}/api/admin/quick-message`, {
                    method: 'POST',
                    body: JSON.stringify(message)
                });

                const result = await response.json();
                if (result.success) {
                    alert(`✅ Message envoyé avec succès vers ${message.recipients}!`);
                    // Reset form
                    if (document.getElementById('messageSubject')) document.getElementById('messageSubject').value = '';
                    if (document.getElementById('messageContent')) document.getElementById('messageContent').value = '';
                } else {
                    alert(`❌ Erreur: ${result.message}`);
                }
            } catch (error) {
                console.error('Erreur envoi message:', error);
                alert('❌ Erreur de connexion au serveur');
            }
        }

        // Générer rapport
        async function generateReport() {
            const reportConfig = {
                type: document.getElementById('reportType')?.value || 'users',
                period: document.getElementById('reportPeriod')?.value || 'month',
                format: document.getElementById('reportFormat')?.value || 'pdf'
            };

            try {
                const response = await apiRequest(`${API_BASE}/api/admin/generate-report`, {
                    method: 'POST',
                    body: JSON.stringify(reportConfig)
                });

                const result = await response.json();
                if (result.success) {
                    alert(`✅ Rapport ${reportConfig.type} généré avec succès!\nTéléchargement en cours...`);
                    if (result.downloadUrl) {
                        window.open(result.downloadUrl, '_blank');
                    }
                } else {
                    alert(`❌ Erreur: ${result.message}`);
                }
            } catch (error) {
                console.error('Erreur génération rapport:', error);
                alert('❌ Erreur de connexion au serveur');
            }
        }

        // Programmer nouveau rapport
        async function scheduleNewReport() {
            const reportSchedule = {
                type: prompt('Type de rapport:', 'users'),
                frequency: prompt('Fréquence (daily, weekly, monthly):', 'weekly'),
                format: prompt('Format (pdf, excel, csv):', 'pdf'),
                recipients: prompt('Emails destinataires (séparés par virgule):', 'admin@claudyne.com')
            };

            if (!reportSchedule.type || !reportSchedule.frequency) {
                alert('⚠️ Informations incomplètes');
                return;
            }

            try {
                const response = await apiRequest(`${API_BASE}/api/admin/schedule-report`, {
                    method: 'POST',
                    body: JSON.stringify(reportSchedule)
                });

                const result = await response.json();
                if (result.success) {
                    alert(`✅ Rapport ${reportSchedule.type} programmé avec succès!`);
                } else {
                    alert(`❌ Erreur: ${result.message}`);
                }
            } catch (error) {
                console.error('Erreur programmation rapport:', error);
                alert('❌ Erreur de connexion au serveur');
            }
        }

        // Forcer sauvegarde
        async function triggerBackup() {
            if (!confirm('Forcer une sauvegarde immédiate ?')) return;

            try {
                const response = await apiRequest(`${API_BASE}/api/admin/force-backup`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    alert('✅ Sauvegarde forcée avec succès!');
                } else {
                    alert(`❌ Erreur sauvegarde: ${result.message}`);
                }
            } catch (error) {
                console.error('Erreur sauvegarde forcée:', error);
                alert('❌ Erreur de connexion au serveur');
            }
        }

        // Actualiser logs
        async function refreshLogs() {
            try {
                const response = await apiRequest(`${API_BASE}/api/admin/logs/recent`);
                const result = await response.json();

                if (result.success) {
                    const logsContainer = document.getElementById('system-logs');
                    if (logsContainer) {
                        logsContainer.innerHTML = result.logs.map(log =>
                            `<div class="log-entry">${log.timestamp} - ${log.level}: ${log.message}</div>`
                        ).join('');
                    }
                    alert('✅ Logs actualisés');
                } else {
                    alert(`❌ Erreur: ${result.message}`);
                }
            } catch (error) {
                console.error('Erreur actualisation logs:', error);
                alert('❌ Erreur de connexion au serveur');
            }
        }

        // Sauvegarder configuration automation emails
        async function saveAutomationConfiguration() {
            const automationConfig = {
                triggers: Array.from(document.querySelectorAll('.trigger-item')).map(item => ({
                    id: item.dataset.id,
                    enabled: item.querySelector('.trigger-enabled')?.checked || false,
                    event: item.querySelector('.trigger-event')?.value || '',
                    template: item.querySelector('.trigger-template')?.value || '',
                    delay: parseInt(item.querySelector('.trigger-delay')?.value || 0)
                }))
            };

            try {
                const response = await apiRequest(`${API_BASE}/api/admin/automation-config`, {
                    method: 'POST',
                    body: JSON.stringify(automationConfig)
                });

                const result = await response.json();
                if (result.success) {
                    alert('✅ Configuration automation sauvegardée avec succès!');
                } else {
                    alert(`❌ Erreur: ${result.message}`);
                }
            } catch (error) {
                console.error('Erreur sauvegarde automation:', error);
                alert('❌ Erreur de connexion au serveur');
            }
        }

        // ========================================
        // SUBSCRIPTION MANAGEMENT FUNCTIONS
        // ========================================

        /**
         * Refresh subscription statistics
         */
        async function refreshSubscriptionStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/subscriptions/stats`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Erreur de chargement des statistiques');
                }

                const data = await response.json();

                if (data.success) {
                    const stats = data.stats;

                    // Update statistics cards
                    document.getElementById('sub-total-users').textContent = stats.users.total;
                    document.getElementById('sub-active-trials').textContent = stats.users.activeTrials;
                    document.getElementById('sub-active-subscriptions').textContent = stats.users.activeSubscriptions;
                    document.getElementById('sub-suspended').textContent = stats.users.suspended;
                    document.getElementById('sub-expired').textContent = stats.users.expired;
                    document.getElementById('sub-current-revenue').textContent = stats.revenue.currentMonthly.toLocaleString() + ' FCFA';
                    document.getElementById('sub-expected-revenue').textContent = stats.revenue.expectedMonthly.toLocaleString() + ' FCFA';
                    document.getElementById('sub-expiring-soon').textContent = stats.alerts.expiringTrials + stats.alerts.expiringSubscriptions;

                    // Load users table
                    await loadSubscriptionUsers();
                } else {
                    console.error('Erreur:', data.message);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des stats:', error);
                alert('❌ Erreur de chargement des statistiques');
            }
        }

        /**
         * Run a cron job manually
         */
        async function runCronJob(jobName) {
            const resultsDiv = document.getElementById('cron-job-results');
            const outputPre = document.getElementById('cron-job-output');

            resultsDiv.style.display = 'block';
            outputPre.textContent = '⏳ Exécution en cours...';

            try {
                const response = await fetch(`${API_BASE_URL}/admin/subscriptions/run-job/${jobName}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    outputPre.textContent = `✅ ${data.message}\n\n` + JSON.stringify(data.result, null, 2);

                    // Refresh stats after job execution
                    setTimeout(() => refreshSubscriptionStats(), 1000);
                } else {
                    outputPre.textContent = `❌ Erreur: ${data.message}`;
                }
            } catch (error) {
                console.error('Erreur lors de l\'exécution du job:', error);
                outputPre.textContent = `❌ Erreur de connexion: ${error.message}`;
            }
        }

        /**
         * Load subscription users
         */
        async function loadSubscriptionUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Erreur de chargement des utilisateurs');
                }

                const data = await response.json();

                if (data.success) {
                    window.allSubscriptionUsers = data.users || [];
                    displaySubscriptionUsers(window.allSubscriptionUsers);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des utilisateurs:', error);
                const tbody = document.getElementById('subscription-users-tbody');
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 2rem; text-align: center; color: #EF4444;">❌ Erreur de chargement</td></tr>';
            }
        }

        /**
         * Display subscription users in table
         */
        function displaySubscriptionUsers(users) {
            const tbody = document.getElementById('subscription-users-tbody');

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 2rem; text-align: center; color: #6B7280;">Aucun utilisateur trouvé</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const statusColors = {
                    'TRIAL': '#10B981',
                    'ACTIVE': '#8B5CF6',
                    'SUSPENDED': '#F59E0B',
                    'EXPIRED': '#EF4444',
                    'CANCELLED': '#6B7280'
                };

                const statusColor = statusColors[user.subscriptionStatus] || '#6B7280';
                const expirationDate = user.trialEndsAt || user.subscriptionEndsAt || '-';
                const formattedDate = expirationDate !== '-' ? new Date(expirationDate).toLocaleDateString('fr-FR') : '-';

                return `
                    <tr style="border-bottom: 1px solid #E5E7EB;">
                        <td style="padding: 0.75rem;">
                            <div style="font-weight: 500;">${user.firstName} ${user.lastName}</div>
                            <div style="font-size: 0.875rem; color: #6B7280;">${user.email}</div>
                        </td>
                        <td style="padding: 0.75rem;">${user.role}</td>
                        <td style="padding: 0.75rem;">${user.subscriptionPlan || 'NONE'}</td>
                        <td style="padding: 0.75rem;">
                            <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; background: ${statusColor}20; color: ${statusColor}; font-size: 0.875rem; font-weight: 500;">
                                ${user.subscriptionStatus || 'NONE'}
                            </span>
                        </td>
                        <td style="padding: 0.75rem;">${user.monthlyPrice ? user.monthlyPrice.toLocaleString() + ' FCFA' : '-'}</td>
                        <td style="padding: 0.75rem;">${formattedDate}</td>
                        <td style="padding: 0.75rem;">
                            <button class="btn btn-sm" onclick="viewUserSubscription('${user.id}')" style="background: #3B82F6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                                Détails
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Filter subscription users
         */
        function filterSubscriptionUsers() {
            const statusFilter = document.getElementById('subStatusFilter').value;
            const planFilter = document.getElementById('subPlanFilter').value;

            let filtered = window.allSubscriptionUsers || [];

            if (statusFilter) {
                filtered = filtered.filter(u => u.subscriptionStatus === statusFilter);
            }

            if (planFilter) {
                filtered = filtered.filter(u => u.subscriptionPlan === planFilter);
            }

            displaySubscriptionUsers(filtered);
        }

        /**
         * View user subscription details
         */
        function viewUserSubscription(userId) {
            // For now, just navigate to user details
            // You can enhance this to show a modal with full subscription details
            alert(`Détails de l'utilisateur ${userId} - À implémenter`);
        }

        /**
         * Initialize subscription management when section is shown
         */
        const originalShowSection = showSection;
        showSection = function(sectionName) {
            originalShowSection(sectionName);

            // Load subscription data when showing subscriptions management
            if (sectionName === 'subscriptions-management') {
                refreshSubscriptionStats();
            }
        };
    </script>
    
    <!-- Script d'optimisation réseau pour 2G/3G -->
    <script src="js/network-optimization.js"></script>
    <script src="js/dynamic-data-manager.js"></script>
</body>
</html>